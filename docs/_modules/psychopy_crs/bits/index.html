<!DOCTYPE html>

<html lang="en" data-content_root="../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>psychopy_crs.bits &#8212; PsychoPy Example Plugin 0.0.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=536c50fe" />
    <link rel="stylesheet" type="text/css" href="../../../_static/psychopy.css?v=b9f4e6dd" />
    <script src="../../../_static/documentation_options.js?v=d20be8f5"></script>
    <script src="../../../_static/doctools.js?v=b682be12"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/jquery-1.11.0.min.js"></script>
    <script src="../../../_static/js/jquery-fix.js"></script>
    <script src="../../../_static/bootstrap-3.3.7/js/bootstrap.min.js"></script>
    <script src="../../../_static/bootstrap-sphinx.js"></script>
    <link rel="index" title="Index" href="../../../genindex/" />
    <link rel="search" title="Search" href="../../../search/" />
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
    <meta name="apple-mobile-web-app-capable" content="yes">

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-4089651-2"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-4089651-2');
    </script>

    <!-- Matomo -->
    <script>
      var _paq = window._paq = window._paq || [];
      /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
      _paq.push(["setDocumentTitle", document.domain + "/" + document.title]);
      _paq.push(["setCookieDomain", "*.psychopy.org"]);
      _paq.push(["setDomains", ["*.psychopy.org","*.discourse.psychopy.org"]]);
      _paq.push(['trackPageView']);
      _paq.push(['enableLinkTracking']);
      (function() {
        var u="//analytics.opensciencetools.org/";
        _paq.push(['setTrackerUrl', u+'matomo.php']);
        _paq.push(['setSiteId', '3']);
        var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
        g.async=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
      })();
    </script>
    <noscript><p><img src="//analytics.opensciencetools.org/matomo.php?idsite=3&amp;rec=1" style="border:0;" alt="" /></p></noscript>
    <!-- End Matomo Code -->


  </head><body>

<!-- The social media icon bar -->
<div class="social-bar">
  <a href="" class="github">
    <i class="fab fa-github"></i></a>
</div>


  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand small-logo" href="../../../">
          <img src="../../../_static/Psychopy Plugin Header Small.png" alt="PsychoPy Logo">
        </a>
        <a class="navbar-brand large-logo" href="../../../">
          <img src="../../../_static/Psychopy Plugin Header Large.png" alt="PsychoPy Logo">
        </a>
        <!-- <span class="navbar-text navbar-version pull-right"><b></b></span> -->
      </div>

        <div class="collapse navbar-collapse nav-collapse w-100 pull-right">
          <ul class="nav navbar-nav ml-auto">
            <li><a href="../../../">Home</a></li>
            <li><a href="../../../download/">Install</a></li>
            
            <li><a href="https://plugins.psychopy.org/directory.html" class="return-btn">plugins.psychopy.org</a></li>
            
              <!-- <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../../">Documentation <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><p class="caption" role="heading"><span class="caption-text">Added content for Coder</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../coder/bits/">Bits</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../coder/colorcal/">Color CAL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../coder/optical/">Opti CAL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../coder/shaders/">Shaders</a></li>
</ul>
</ul>
</li> -->
              
            
            <!--  -->
            
            
          </ul>

            <!-- 
              
<form class="navbar-form navbar-right" action="../../../search/" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
             -->

        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-9 content">
      
  <h1>Source code for psychopy_crs.bits</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># -*- coding: utf-8 -*-</span>

<span class="c1"># Originally part of the PsychoPy library</span>
<span class="c1"># Copyright (C) 2002-2018 Jonathan Peirce (C) 2019-2022 Open Science Tools Ltd.</span>
<span class="c1"># Distributed under the terms of the GNU General Public License (GPL).</span>

<span class="c1"># Acknowledgements:</span>
<span class="c1">#    This code was initially written by Jon Peirce.</span>
<span class="c1">#    with substantial additions by Andrew Schofield</span>
<span class="c1">#    CRS Ltd provided support as needed.</span>
<span class="c1">#    Shader code for mono++ and color++ modes was based on code in Psychtoolbox</span>
<span class="c1">#    (Kleiner) but does not actually use that code directly</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">weakref</span>
<span class="kn">import</span> <span class="nn">serial</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">copy</span><span class="p">,</span> <span class="n">deepcopy</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="c1"># Python 3.8 removed time.clock()</span>
<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">8</span><span class="p">):</span>
    <span class="n">clock</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">clock</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">clock</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">shaders</span>
<span class="kn">from</span> <span class="nn">psychopy</span> <span class="kn">import</span> <span class="n">logging</span><span class="p">,</span> <span class="n">core</span>
<span class="kn">from</span> <span class="nn">psychopy.hardware</span> <span class="kn">import</span> <span class="n">serialdevice</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">Queue</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">queue</span> <span class="k">as</span> <span class="nn">Queue</span>


<span class="n">__docformat__</span> <span class="o">=</span> <span class="s2">&quot;restructuredtext en&quot;</span>

<span class="n">DEBUG</span> <span class="o">=</span> <span class="kc">True</span>

<span class="n">plotResults</span> <span class="o">=</span> <span class="kc">False</span>
<span class="k">if</span> <span class="n">plotResults</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">psychopy.ext</span> <span class="kn">import</span> <span class="n">_bits</span>
    <span class="n">haveBitsDLL</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="n">haveBitsDLL</span> <span class="o">=</span> <span class="kc">False</span>

<span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>  <span class="c1"># we don&#39;t want error skipping in debug mode!</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">shaders</span>
    <span class="n">haveShaders</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">shaders</span>
        <span class="n">haveShaders</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">haveShaders</span> <span class="o">=</span> <span class="kc">False</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">configparser</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">ConfigParser</span> <span class="k">as</span> <span class="nn">configparser</span>

<span class="c1"># Bits++ modes</span>
<span class="n">bits8BITPALETTEMODE</span> <span class="o">=</span> <span class="mh">0x00000001</span>  <span class="c1"># /* normal vsg mode */</span>
<span class="n">NOGAMMACORRECT</span> <span class="o">=</span> <span class="mh">0x00004000</span>  <span class="c1"># /* Gamma correction mode */</span>
<span class="n">GAMMACORRECT</span> <span class="o">=</span> <span class="mh">0x00008000</span>  <span class="c1"># /* Gamma correction mode */</span>
<span class="n">VIDEOENCODEDCOMMS</span> <span class="o">=</span> <span class="mh">0x00080000</span>  <span class="c1"># must set so that LUT is read from screen</span>


<div class="viewcode-block" id="button">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.button">[docs]</a>
<span class="k">class</span> <span class="nc">button</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;clever dict like object or object like dict </span>
<span class="sd">    for button presses</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="n">button</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;dir&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">direction</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;button&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">button</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">t</span>

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span> 
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">k</span><span class="p">:</span> 
            <span class="k">return</span> <span class="kc">None</span>
        
    <span class="k">def</span> <span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span> 
        <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
    
    <span class="k">def</span> <span class="fm">__delattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">k</span><span class="p">:</span> 
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>     
        <span class="k">return</span> <span class="s1">&#39;&lt;button &#39;</span> <span class="o">+</span> <span class="nb">dict</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&gt;&#39;</span>
    
    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> 
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">value</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">items</span><span class="p">():</span> <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">=</span><span class="n">v</span></div>


<div class="viewcode-block" id="status">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.status">[docs]</a>
<span class="k">class</span> <span class="nc">status</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;clever dict like object or object like dict</span>
<span class="sd">    for Bits# status messages</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
                         <span class="n">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
                         <span class="n">trigIn</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
                         <span class="n">bitsvals</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
                         <span class="n">IR</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
                         <span class="n">ADCs</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;sample&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">sample</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">t</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;trigIn&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">trigIn</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;DIN&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="n">bitsvals</span><span class="p">]</span><span class="o">*</span><span class="mi">10</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;DWORD&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">bitsvals</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;IR&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="n">IR</span><span class="p">]</span><span class="o">*</span><span class="mi">6</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;ADC&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="n">ADCs</span><span class="p">]</span><span class="o">*</span><span class="mi">6</span> 
 

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span> 
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">k</span><span class="p">:</span> 
            <span class="k">return</span> <span class="kc">None</span>
        
    <span class="k">def</span> <span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span> 
        <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
    
    <span class="k">def</span> <span class="fm">__delattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">k</span><span class="p">:</span> 
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>     
        <span class="k">return</span> <span class="s1">&#39;&lt;sample &#39;</span> <span class="o">+</span> <span class="nb">dict</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&gt;&#39;</span>
    
    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> 
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">value</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">items</span><span class="p">():</span> <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">=</span><span class="n">v</span></div>

        
<div class="viewcode-block" id="event">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.event">[docs]</a>
<span class="k">class</span> <span class="nc">event</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;clever dict like object or object like dict </span>
<span class="sd">    for Bits# status events</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> 
                         <span class="n">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
                         <span class="nb">input</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
                         <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;dir&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">direction</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">source</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">t</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">]</span><span class="o">=</span><span class="nb">input</span>
 

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span> 
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">k</span><span class="p">:</span> 
            <span class="k">return</span> <span class="kc">None</span>
        
    <span class="k">def</span> <span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span> 
        <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
    
    <span class="k">def</span> <span class="fm">__delattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">k</span><span class="p">:</span> 
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>     
        <span class="k">return</span> <span class="s1">&#39;&lt;event &#39;</span> <span class="o">+</span> <span class="nb">dict</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&gt;&#39;</span>
    
    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> 
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">value</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">items</span><span class="p">():</span> <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">=</span><span class="n">v</span></div>

        
<div class="viewcode-block" id="touch">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.touch">[docs]</a>
<span class="k">class</span> <span class="nc">touch</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;clever dict like object or object like dict </span>
<span class="sd">    for touch screen presses</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;down&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">t</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">x</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">y</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;dir&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">direction</span>

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span> 
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">k</span><span class="p">:</span> 
            <span class="k">return</span> <span class="kc">None</span>
        
    <span class="k">def</span> <span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span> 
        <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
    
    <span class="k">def</span> <span class="fm">__delattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">k</span><span class="p">:</span> 
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>     
        <span class="k">return</span> <span class="s1">&#39;&lt;touch &#39;</span> <span class="o">+</span> <span class="nb">dict</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&gt;&#39;</span>
    
    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> 
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">value</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">items</span><span class="p">():</span> <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">=</span><span class="n">v</span></div>



<div class="viewcode-block" id="BitsPlusPlus">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.BitsPlusPlus">[docs]</a>
<span class="k">class</span> <span class="nc">BitsPlusPlus</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The main class to control a Bits++ box.</span>
<span class="sd">    This is usually a class added within the window object and is</span>
<span class="sd">    typically accessed from there. e.g.::</span>

<span class="sd">        from psychopy import visual</span>
<span class="sd">        from psychopy.hardware import crs</span>
<span class="sd">        win = visual.Window([800,600])</span>
<span class="sd">        bits = crs.BitsPlusPlus(win, mode=&#39;bits++&#39;)</span>
<span class="sd">        # use bits++ to reduce the whole screen contrast by 50%:</span>
<span class="sd">        bits.setContrast(0.5)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">win</span><span class="p">,</span>
                 <span class="n">contrast</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                 <span class="n">gamma</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">nEntries</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span>
                 <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;bits++&#39;</span><span class="p">,</span>
                 <span class="n">rampType</span><span class="o">=</span><span class="s1">&#39;configFile&#39;</span><span class="p">,</span>
                 <span class="n">frameRate</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>

<span class="sd">        contrast :</span>
<span class="sd">            The contrast to be applied to the LUT.</span>
<span class="sd">            See :func:`BitsPlusPlus.setLUT` and</span>
<span class="sd">            :func:`BitsPlusPlus.setContrast` for flexibility on setting</span>
<span class="sd">            just a section of the LUT to a different value</span>
<span class="sd">        gamma :</span>
<span class="sd">            The value used to correct the gamma in the LUT</span>
<span class="sd">        nEntries : 256</span>
<span class="sd">            [DEPRECATED feature]</span>
<span class="sd">        mode : &#39;bits++&#39; (or &#39;mono++&#39; or &#39;color++&#39;)</span>
<span class="sd">            Note that, unlike the Bits#, this only affects the way the</span>
<span class="sd">            window is rendered, it does not switch the state of the Bits++</span>
<span class="sd">            device itself (because unlike the Bits# have no way to</span>
<span class="sd">            communicate with it).</span>
<span class="sd">            The mono++ and color++ are only supported in PsychoPy 1.82.00</span>
<span class="sd">            onwards. Even then they suffer from not having gamma</span>
<span class="sd">            correction applied on Bits++ (unlike Bits# which can apply</span>
<span class="sd">            a gamma table in the device hardware).</span>
<span class="sd">        rampType : &#39;configFile&#39;, None or an integer</span>
<span class="sd">            if &#39;configFile&#39; then we&#39;ll look for a valid config in the</span>
<span class="sd">            userPrefs folder if an integer then this will be used during</span>
<span class="sd">            win.setGamma(rampType=rampType):</span>
<span class="sd">        frameRate : an estimate the frameRate of the monitor. If None frame rate</span>
<span class="sd">            will be calculated.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">win</span> <span class="o">=</span> <span class="n">win</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contrast</span> <span class="o">=</span> <span class="n">contrast</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nEntries</span> <span class="o">=</span> <span class="n">nEntries</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span>
        <span class="c1"># Frame rate isused to calculate trigger packets but for some reason</span>
        <span class="c1"># Bits++ needs it to be faked</span>
        <span class="k">if</span> <span class="n">frameRate</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">frameRate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">win</span><span class="o">.</span><span class="n">getActualFrameRate</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frameRate</span><span class="o">=</span><span class="n">frameRate</span><span class="o">*</span><span class="mf">0.9</span>
        <span class="c1"># used to allow setting via USB which was &#39;slow&#39;:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;fast&#39;</span>
        <span class="c1"># Bits++ doesn&#39;t do its own correction so we need to:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gammaCorrect</span> <span class="o">=</span> <span class="s1">&#39;software&#39;</span>

        <span class="c1"># import pyglet.GL late so that we can import bits.py without it</span>
        <span class="c1"># initially</span>
        <span class="k">global</span> <span class="n">GL</span><span class="p">,</span> <span class="n">visual</span>
        <span class="kn">from</span> <span class="nn">psychopy</span> <span class="kn">import</span> <span class="n">visual</span>
        <span class="kn">import</span> <span class="nn">pyglet.gl</span> <span class="k">as</span> <span class="nn">GL</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gammaCorrect</span> <span class="o">==</span> <span class="s1">&#39;software&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">gamma</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># inherit from window:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span> <span class="o">=</span> <span class="n">win</span><span class="o">.</span><span class="n">gamma</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">gamma</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="c1"># [Lum,R,G,B] or [R,G,B]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span> <span class="o">=</span> <span class="n">gamma</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span> <span class="o">=</span> <span class="p">[</span><span class="n">gamma</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">gamma</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">init</span><span class="p">():</span>
            <span class="n">setVideoMode</span><span class="p">(</span><span class="n">NOGAMMACORRECT</span> <span class="o">|</span> <span class="n">VIDEOENCODEDCOMMS</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initialised</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Found and initialised Bits++&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initialised</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t initialise Bits++&quot;</span><span class="p">)</span>

        <span class="c1"># do the processing</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_setHeaders</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frameRate</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">setLUT</span><span class="p">()</span>  <span class="c1"># this will set self.LUT and update self._LUTandHEAD</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setupShaders</span><span class="p">()</span>

        <span class="c1"># replace window methods with our custom ones</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">win</span><span class="o">.</span><span class="n">_prepareFBOrender</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepareFBOrender</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">win</span><span class="o">.</span><span class="n">_finishFBOrender</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_finishFBOrender</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">win</span><span class="o">.</span><span class="n">_afterFBOrender</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_afterFBOrender</span>
        <span class="c1"># set gamma of the window to the identity LUT</span>
        <span class="k">if</span> <span class="n">rampType</span> <span class="o">==</span> <span class="s1">&#39;configFile&#39;</span><span class="p">:</span>
            <span class="c1"># now check that we have a valid configuration of the box</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="c1"># check we matche the prev config for our graphics card etc</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># until we find otherwise</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">quickCheck</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">win</span><span class="o">.</span><span class="n">gammaRamp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">identityLUT</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rampType</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">rampType</span> <span class="o">==</span> <span class="s1">&#39;configFile&#39;</span><span class="p">:</span>
            <span class="c1"># &#39;this must NOT be an `else` from the above `if` because can be</span>
            <span class="c1"># overridden possibly we were given a numerical rampType (as in</span>
            <span class="c1"># the :func:`psychopy.gamma.setGamma()`)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">win</span><span class="o">.</span><span class="n">winHandle</span><span class="o">.</span><span class="n">setGamma</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">win</span><span class="o">.</span><span class="n">winHandle</span><span class="o">.</span><span class="n">_dc</span><span class="p">,</span> <span class="n">rampType</span><span class="o">=</span><span class="n">rampType</span><span class="p">)</span>
          
    <span class="c1">#==================================#</span>
    <span class="c1"># Helper function for __init__     #</span>
    <span class="c1">#==================================#</span>
    
    <span class="k">def</span> <span class="nf">_setHeaders</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frameRate</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Sets up the TLock header codes and some flags that are</span>
<span class="sd">            common to operating all CRS devices</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TLock for setting LUTs in the CRS device</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandLUT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">524</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="c1"># R</span>
        <span class="n">valsR</span> <span class="o">=</span> <span class="p">(</span><span class="mi">36</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">211</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">112</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandLUT</span><span class="p">[:</span><span class="mi">12</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">valsR</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="mi">12</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="c1"># G</span>
        <span class="n">valsG</span> <span class="o">=</span> <span class="p">(</span><span class="mi">106</span><span class="p">,</span> <span class="mi">136</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">115</span><span class="p">,</span> <span class="mi">68</span><span class="p">,</span> <span class="mi">41</span><span class="p">,</span> <span class="mi">159</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandLUT</span><span class="p">[:</span><span class="mi">12</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">valsG</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="mi">12</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="c1"># B</span>
        <span class="n">valsB</span> <span class="o">=</span> <span class="p">(</span><span class="mi">133</span><span class="p">,</span> <span class="mi">163</span><span class="p">,</span> <span class="mi">138</span><span class="p">,</span> <span class="mi">46</span><span class="p">,</span> <span class="mi">164</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="mi">208</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandLUT</span><span class="p">[:</span><span class="mi">12</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">valsB</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="mi">12</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LUT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">256</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>  <span class="c1"># just a place holder</span>

        <span class="c1">#TLock Header for everything else</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_NumberPackets</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="mi">10000</span><span class="o">/</span><span class="n">frameRate</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>

        <span class="c1"># R:</span>
        <span class="n">TLockR</span> <span class="o">=</span> <span class="p">(</span><span class="mi">69</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">119</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">233</span><span class="p">,</span> <span class="mi">41</span><span class="p">,</span> <span class="mi">183</span><span class="p">,</span> 
                    <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>        
        <span class="c1"># G:</span>
        <span class="n">TLockG</span> <span class="o">=</span> <span class="p">(</span><span class="mi">33</span><span class="p">,</span> <span class="mi">230</span><span class="p">,</span> <span class="mi">190</span><span class="p">,</span> <span class="mi">84</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">108</span><span class="p">,</span><span class="mi">201</span><span class="p">,</span> <span class="mi">124</span><span class="p">,</span> 
                    <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="c1"># B:</span>
        <span class="n">TLockB</span> <span class="o">=</span> <span class="p">(</span><span class="mi">56</span><span class="p">,</span> <span class="mi">208</span><span class="p">,</span> <span class="mi">102</span><span class="p">,</span> <span class="mi">207</span><span class="p">,</span> <span class="mi">192</span><span class="p">,</span> <span class="mi">172</span><span class="p">,</span><span class="mi">80</span><span class="p">,</span> <span class="mi">221</span><span class="p">,</span> 
                    <span class="bp">self</span><span class="o">.</span><span class="n">_NumberPackets</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c1"># The following is used to reset the Bits# clock</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandClock</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(((</span><span class="bp">self</span><span class="o">.</span><span class="n">_NumberPackets</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="mi">19</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span>
                                            <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandClock</span><span class="p">[:</span><span class="mi">19</span><span class="p">,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">TLockR</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="mi">19</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span><span class="c1">#R</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandClock</span><span class="p">[:</span><span class="mi">19</span><span class="p">,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">TLockG</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="mi">19</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span><span class="c1">#G</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandClock</span><span class="p">[:</span><span class="mi">19</span><span class="p">,:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">TLockB</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="mi">19</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span><span class="c1">#B</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandClock</span><span class="p">[</span><span class="mi">15</span><span class="p">,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">12</span> <span class="c1"># Pixel 15 green = 12 to reset clock.</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandClockstr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandClock</span><span class="o">.</span><span class="n">tostring</span><span class="p">()</span>
            
        <span class="c1"># The following are used to send triggers and control FE1 goggles</span>
        <span class="c1"># via the digital output  lines.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandTrig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(((</span><span class="bp">self</span><span class="o">.</span><span class="n">_NumberPackets</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="mi">19</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span>
                                        <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandGogLeftOpen</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(((</span><span class="bp">self</span><span class="o">.</span><span class="n">_NumberPackets</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="mi">19</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span>
                                                <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandGogRightOpen</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(((</span><span class="bp">self</span><span class="o">.</span><span class="n">_NumberPackets</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="mi">19</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span>
                                                <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandGogBothOpen</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(((</span><span class="bp">self</span><span class="o">.</span><span class="n">_NumberPackets</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="mi">19</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span>
                                                <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandGogBothClosed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(((</span><span class="bp">self</span><span class="o">.</span><span class="n">_NumberPackets</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="mi">19</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
                                        <span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandTrig</span><span class="p">[:</span><span class="mi">19</span><span class="p">,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">TLockR</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="mi">19</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span><span class="c1">#R</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandTrig</span><span class="p">[:</span><span class="mi">19</span><span class="p">,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">TLockG</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="mi">19</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span><span class="c1">#G</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandTrig</span><span class="p">[:</span><span class="mi">19</span><span class="p">,:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">TLockB</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="mi">19</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span><span class="c1">#B</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandGogLeftOpen</span><span class="p">[:</span><span class="mi">19</span><span class="p">,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                                        <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">TLockR</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="mi">19</span><span class="p">,</span><span class="mi">1</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandGogLeftOpen</span><span class="p">[:</span><span class="mi">19</span><span class="p">,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                                        <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">TLockG</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="mi">19</span><span class="p">,</span><span class="mi">1</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandGogLeftOpen</span><span class="p">[:</span><span class="mi">19</span><span class="p">,:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                                        <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">TLockB</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="mi">19</span><span class="p">,</span><span class="mi">1</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandGogRightOpen</span><span class="p">[:</span><span class="mi">19</span><span class="p">,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                                        <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">TLockR</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="mi">19</span><span class="p">,</span><span class="mi">1</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandGogRightOpen</span><span class="p">[:</span><span class="mi">19</span><span class="p">,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                                        <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">TLockG</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="mi">19</span><span class="p">,</span><span class="mi">1</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandGogRightOpen</span><span class="p">[:</span><span class="mi">19</span><span class="p">,:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                                        <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">TLockB</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="mi">19</span><span class="p">,</span><span class="mi">1</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandGogBothOpen</span><span class="p">[:</span><span class="mi">19</span><span class="p">,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                                        <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">TLockR</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="mi">19</span><span class="p">,</span><span class="mi">1</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandGogBothOpen</span><span class="p">[:</span><span class="mi">19</span><span class="p">,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                                        <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">TLockG</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="mi">19</span><span class="p">,</span><span class="mi">1</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandGogBothOpen</span><span class="p">[:</span><span class="mi">19</span><span class="p">,:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                                        <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">TLockB</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="mi">19</span><span class="p">,</span><span class="mi">1</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandGogBothClosed</span><span class="p">[:</span><span class="mi">19</span><span class="p">,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                                        <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">TLockR</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="mi">19</span><span class="p">,</span><span class="mi">1</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandGogBothClosed</span><span class="p">[:</span><span class="mi">19</span><span class="p">,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                                        <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">TLockG</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="mi">19</span><span class="p">,</span><span class="mi">1</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandGogBothClosed</span><span class="p">[:</span><span class="mi">19</span><span class="p">,:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                                        <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">TLockB</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="mi">19</span><span class="p">,</span><span class="mi">1</span><span class="p">]))</span>

        
        <span class="c1"># flags for controlling triggers, goggles and analog outputs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="o">=</span><span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clockReset</span><span class="o">=</span><span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clockReset</span><span class="o">=</span><span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gogglesGo</span><span class="o">=</span><span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gogglesLeft</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gogglesRight</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="c1"># Set up some blank triggers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setTrigger</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">triggerProtected</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1">#==========================================#</span>
    <span class="c1"># Lut Functions                            #</span>
    <span class="c1">#==========================================#</span>

<div class="viewcode-block" id="BitsPlusPlus.setLUT">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.BitsPlusPlus.setLUT">[docs]</a>
    <span class="k">def</span> <span class="nf">setLUT</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">newLUT</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">gammaCorrect</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">LUTrange</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sets the LUT to a specific range of values in &#39;bits++&#39; mode only</span>
<span class="sd">        Note that, if you leave gammaCorrect=True then any LUT values you</span>
<span class="sd">        supply will automatically be gamma corrected.</span>
<span class="sd">        The LUT will take effect on the next `Window.flip()`</span>

<span class="sd">        **Examples**:</span>

<span class="sd">            - `bitsBox.setLUT()` to build a LUT using bitsBox.contrast and bitsBox.gamma</span>
<span class="sd">            - `bitsBox.setLUT(newLUT=some256x1array)` (NB array should be float 0.0:1.0)</span>
<span class="sd">              Builds a luminance LUT using newLUT for each gun</span>
<span class="sd">              (actually array can be 256x1 or 1x256)</span>
<span class="sd">            - `bitsBox.setLUT(newLUT=some256x3array)`</span>
<span class="sd">              (NB array should be float 0.0:1.0)</span>
<span class="sd">              Allows you to use a different LUT on each gun</span>

<span class="sd">        (NB by using BitsBox.setContr() and BitsBox.setGamma() users may not</span>
<span class="sd">        need this function)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># choose endpoints</span>
        <span class="n">LUTrange</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">LUTrange</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">LUTrange</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">startII</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="mf">0.5</span> <span class="o">-</span> <span class="n">LUTrange</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span> <span class="o">*</span> <span class="mf">255.0</span><span class="p">))</span>
            <span class="c1"># +1 because python ranges exclude last value:</span>
            <span class="n">endII</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="mf">0.5</span> <span class="o">+</span> <span class="n">LUTrange</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span> <span class="o">*</span> <span class="mf">255.0</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">LUTrange</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">multiplier</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="k">if</span> <span class="n">LUTrange</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">multiplier</span> <span class="o">=</span> <span class="mf">255.0</span>
            <span class="n">startII</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">LUTrange</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">multiplier</span><span class="p">))</span>
            <span class="c1"># +1 because python ranges exclude last value:</span>
            <span class="n">endII</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">LUTrange</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">multiplier</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">stepLength</span> <span class="o">=</span> <span class="mf">2.0</span><span class="o">/</span><span class="p">(</span><span class="n">endII</span> <span class="o">-</span> <span class="n">startII</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">newLUT</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># create a LUT from scratch (based on contrast and gamma)</span>
            <span class="c1"># rampStep = 2.0/(self.nEntries-1)</span>
            <span class="n">ramp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">+</span> <span class="n">stepLength</span><span class="p">,</span> <span class="n">stepLength</span><span class="p">)</span>
            <span class="n">ramp</span> <span class="o">=</span> <span class="p">(</span><span class="n">ramp</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">contrast</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span>
            <span class="c1"># self.LUT will be stored as 0.0:1.0 (gamma-corrected)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">LUT</span><span class="p">[</span><span class="n">startII</span><span class="p">:</span><span class="n">endII</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">ramp</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">LUT</span><span class="p">[</span><span class="n">startII</span><span class="p">:</span><span class="n">endII</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">ramp</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">LUT</span><span class="p">[</span><span class="n">startII</span><span class="p">:</span><span class="n">endII</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">ramp</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">newLUT</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="ow">or</span> <span class="p">(</span><span class="n">newLUT</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">()):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">LUT</span><span class="p">[</span><span class="n">startII</span><span class="p">:</span><span class="n">endII</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">newLUT</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">LUT</span><span class="p">[</span><span class="n">startII</span><span class="p">:</span><span class="n">endII</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">newLUT</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">LUT</span><span class="p">[</span><span class="n">startII</span><span class="p">:</span><span class="n">endII</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">newLUT</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">newLUT</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># one dimensional LUT</span>
            <span class="c1"># replicate LUT to other channels, check range is 0:1</span>
            <span class="k">if</span> <span class="n">newLUT</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;newLUT should be float in range 0.0:1.0&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">LUT</span><span class="p">[</span><span class="n">startII</span><span class="p">:</span><span class="n">endII</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">newLUT</span><span class="o">.</span><span class="n">flat</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">LUT</span><span class="p">[</span><span class="n">startII</span><span class="p">:</span><span class="n">endII</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">newLUT</span><span class="o">.</span><span class="n">flat</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">LUT</span><span class="p">[</span><span class="n">startII</span><span class="p">:</span><span class="n">endII</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">newLUT</span><span class="o">.</span><span class="n">flat</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">newLUT</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c1"># one dimensional LUT</span>
            <span class="c1"># use LUT as is, check range is 0:1</span>
            <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">newLUT</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;newLUT should be float in range 0.0:1.0&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">LUT</span><span class="p">[</span><span class="n">startII</span><span class="p">:</span><span class="n">endII</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">newLUT</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;newLUT can be None, nx1 or nx3&#39;</span><span class="p">)</span>

        <span class="c1"># do gamma correction if necessary</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gammaCorrect</span> <span class="o">==</span> <span class="s1">&#39;software&#39;</span><span class="p">:</span>
            <span class="n">gamma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">lin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">win</span><span class="o">.</span><span class="n">monitor</span><span class="o">.</span><span class="n">linearizeLums</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">LUT</span><span class="p">[</span><span class="n">startII</span><span class="p">:</span><span class="n">endII</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">lin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">LUT</span><span class="p">[</span><span class="n">startII</span><span class="p">:</span><span class="n">endII</span><span class="p">,</span> <span class="p">:],</span>
                                                 <span class="n">overrideGamma</span><span class="o">=</span><span class="n">gamma</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">lin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">win</span><span class="o">.</span><span class="n">monitor</span><span class="o">.</span><span class="n">lineariseLums</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">LUT</span><span class="p">[</span><span class="n">startII</span><span class="p">:</span><span class="n">endII</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">lin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">LUT</span><span class="p">[</span><span class="n">startII</span><span class="p">:</span><span class="n">endII</span><span class="p">,</span> <span class="p">:],</span>
                                                     <span class="n">overrideGamma</span><span class="o">=</span><span class="n">gamma</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="k">pass</span>

        <span class="c1"># update the bits++ box with new LUT</span>
        <span class="c1"># get bits into correct order, shape and add to header</span>
        <span class="c1"># go from ubyte to uint16</span>
        <span class="n">ramp16</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">LUT</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="mi">16</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)</span>
        <span class="n">ramp16</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ramp16</span><span class="p">,</span> <span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="c1"># set most significant bits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandLUT</span><span class="p">[</span><span class="mi">12</span><span class="p">::</span><span class="mi">2</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ramp16</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="c1"># set least significant bits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandLUT</span><span class="p">[</span><span class="mi">13</span><span class="p">::</span><span class="mi">2</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">ramp16</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">&amp;</span> <span class="mi">255</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandLUTstr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandLUT</span><span class="o">.</span><span class="n">tostring</span><span class="p">()</span></div>


<div class="viewcode-block" id="BitsPlusPlus.setContrast">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.BitsPlusPlus.setContrast">[docs]</a>
    <span class="k">def</span> <span class="nf">setContrast</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">contrast</span><span class="p">,</span> <span class="n">LUTrange</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">gammaCorrect</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the contrast of the LUT for &#39;bits++&#39; mode only</span>
<span class="sd">        :Parameters:</span>

<span class="sd">            contrast : float in the range 0:1</span>
<span class="sd">                The contrast for the range being set</span>

<span class="sd">            LUTrange : float or array</span>
<span class="sd">                If a float is given then this is the fraction of the LUT</span>
<span class="sd">                to be used. If an array of floats is given, these will</span>
<span class="sd">                specify the start / stop points as fractions of the LUT.</span>
<span class="sd">                If an array of ints (0-255) is given these determine the</span>
<span class="sd">                start stop *indices* of the LUT</span>

<span class="sd">        Examples:</span>
<span class="sd">            - `setContrast(1.0,0.5)` to set the central 50% of the LUT so that a stimulus with</span>
<span class="sd">                contr=0.5 will actually be drawn with contrast 1.0</span>
<span class="sd">            - `setContrast(1.0,[0.25,0.5])`</span>
<span class="sd">            - or `setContrast(1.0,[63,127])` to set the lower-middle quarter of the LUT</span>
<span class="sd">                (which might be useful in LUT animation paradigms)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contrast</span> <span class="o">=</span> <span class="n">contrast</span>
        <span class="k">if</span> <span class="n">gammaCorrect</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">gammaCorrect</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;hardware&quot;</span><span class="p">]:</span>
                <span class="n">gammaCorrect</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">gammaCorrect</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># setLUT uses contrast automatically</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setLUT</span><span class="p">(</span><span class="n">newLUT</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">gammaCorrect</span><span class="o">=</span><span class="n">gammaCorrect</span><span class="p">,</span> <span class="n">LUTrange</span><span class="o">=</span><span class="n">LUTrange</span><span class="p">)</span></div>


<div class="viewcode-block" id="BitsPlusPlus.setGamma">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.BitsPlusPlus.setGamma">[docs]</a>
    <span class="k">def</span> <span class="nf">setGamma</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">newGamma</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the LUT to have the requested gamma value</span>
<span class="sd">        Currently also resets the LUT to be a linear contrast</span>
<span class="sd">        ramp spanning its full range. May change this to read</span>
<span class="sd">        the current LUT, undo previous gamma and then apply</span>
<span class="sd">        new one?&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span> <span class="o">=</span> <span class="n">newGamma</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setLUT</span><span class="p">()</span>  <span class="c1"># easiest way to update</span></div>


    <span class="c1">#=================================================#</span>
    <span class="c1"># Bits Clock Functions                            #</span>
    <span class="c1">#=================================================#</span>

<div class="viewcode-block" id="BitsPlusPlus.resetClock">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.BitsPlusPlus.resetClock">[docs]</a>
    <span class="k">def</span> <span class="nf">resetClock</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Issues a clock reset code using 1 screen flip</span>
<span class="sd">        if the next frame(s) is dropped the reset will be </span>
<span class="sd">        re-issued thus keeping timing good.</span>
<span class="sd">        </span>
<span class="sd">        Resets continue to be issued on each video frame until</span>
<span class="sd">        the next win.flip so you need to have regular win.flips for</span>
<span class="sd">        this function to work properly.</span>
<span class="sd">        </span>
<span class="sd">        Example:</span>
<span class="sd">            bits.resetClock()</span>
<span class="sd">            drawImage()</span>
<span class="sd">            bits.win.flip()</span>
<span class="sd">            </span>
<span class="sd">            </span>
<span class="sd">        Will issue clock resets while the image is being drawn then</span>
<span class="sd">        display the image and allow the clock to continue from the</span>
<span class="sd">        same frame.</span>
<span class="sd">        </span>
<span class="sd">        Example:</span>
<span class="sd">            bits.resetClock()</span>
<span class="sd">            bits.RTBoxWait()</span>
<span class="sd">            bits.win.flip()</span>
<span class="sd">            </span>
<span class="sd">        Will issue clock resets until a button is pressed.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clockReset</span><span class="o">=</span><span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">win</span><span class="o">.</span><span class="n">flip</span><span class="p">()</span> <span class="c1"># Send reset signal this frame, reset will happen next frame. </span></div>

                         <span class="c1"># If next winflip is late the reset flag should latch thus </span>
                         <span class="c1"># resetting clock until the next winflip</span>


<div class="viewcode-block" id="BitsPlusPlus.primeClock">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.BitsPlusPlus.primeClock">[docs]</a>
    <span class="k">def</span> <span class="nf">primeClock</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Primes the clock to reset at the next screen </span>
<span class="sd">        flip - note only 1 clock reset signal will be issued</span>
<span class="sd">        but if the frame(s) after the reset frame is </span>
<span class="sd">        dropped the reset will be re-issued thus keeping timing good.</span>
<span class="sd">        </span>
<span class="sd">        Resets continute to be issued on each video frame until</span>
<span class="sd">        the next win.flip so you need to have regular win.flips for</span>
<span class="sd">        this function to work properly.</span>
<span class="sd">        </span>
<span class="sd">        Example::</span>

<span class="sd">            bits.primeClock()</span>
<span class="sd">            drawImage</span>
<span class="sd">            while not response</span>
<span class="sd">                #do some processing</span>
<span class="sd">                bits.win.flip()</span>
<span class="sd">        </span>
<span class="sd">        Will get a clock reset signal ready but won&#39;t issue it until the first win.flip in the loop.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clockReset</span><span class="o">=</span><span class="kc">True</span></div>

    
<div class="viewcode-block" id="BitsPlusPlus.syncClocks">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.BitsPlusPlus.syncClocks">[docs]</a>
    <span class="k">def</span> <span class="nf">syncClocks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">t</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Synchronise the Bits/RTBox Clock with the host clock </span>
<span class="sd">        Given by t.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clockReset</span><span class="o">=</span><span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">win</span><span class="o">.</span><span class="n">flip</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clockReset</span><span class="o">=</span><span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">win</span><span class="o">.</span><span class="n">flip</span><span class="p">()</span>
        <span class="n">t</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span></div>


    <span class="c1">#=================================================#</span>
    <span class="c1"># Bits Trigger and Stereo Goggle Functions        #</span>
    <span class="c1">#=================================================#</span>

<div class="viewcode-block" id="BitsPlusPlus.getPackets">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.BitsPlusPlus.getPackets">[docs]</a>
    <span class="k">def</span> <span class="nf">getPackets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the number of packets available for trigger pulses.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_NumberPackets</span></div>


<div class="viewcode-block" id="BitsPlusPlus.setTrigger">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.BitsPlusPlus.setTrigger">[docs]</a>
    <span class="k">def</span> <span class="nf">setTrigger</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">triggers</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">onTime</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
                   <span class="n">duration</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="mh">0xFFFF</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Quick way to set up triggers.</span>
<span class="sd">            </span>
<span class="sd">            Triggers is a binary word that determines which </span>
<span class="sd">            triggers will be turned on.</span>
<span class="sd">            </span>
<span class="sd">            onTime specifies the start time of the trigger within</span>
<span class="sd">            the frame (in S with 100uS resolution)</span>
<span class="sd">            </span>
<span class="sd">            Duration specifies how long the trigger will last.</span>
<span class="sd">            (in S with 100uS resolution).</span>
<span class="sd">            </span>
<span class="sd">            Note that mask only protects the digital output lines</span>
<span class="sd">            set by other activities in the Bits. Not other triggers.</span>
<span class="sd">            </span>
<span class="sd">            Example::</span>
<span class="sd">                bits.setTrigger(0b0000000010, 2.0, 4.0, 0b0111111111)</span>
<span class="sd">                bits.startTrigger()</span>


<span class="sd">            Will issue a 4ms long high-going pulse, 2ms after the start </span>
<span class="sd">            of each frame on DOUT1 while protecting the value of DOUT 9.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Convert on time and duration into device units.</span>
        <span class="n">sOnTime</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">onTime</span><span class="o">*</span><span class="mf">10000.0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">sDuration</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">duration</span><span class="o">*</span><span class="mf">10000.0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="c1"># preallocate an empty data packet</span>
        <span class="n">packet</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_NumberPackets</span>
        <span class="c1"># Set some elements of the packet equal to the desired trigger pattern.</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sOnTime</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">sOnTime</span> <span class="o">+</span> <span class="n">sDuration</span><span class="p">)</span> <span class="p">):</span>
            <span class="n">packet</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">triggers</span>
        <span class="c1"># Set up the actual trigger headers.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setTriggerList</span><span class="p">(</span><span class="n">triggerList</span><span class="o">=</span><span class="n">packet</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span></div>


<div class="viewcode-block" id="BitsPlusPlus.setTriggerList">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.BitsPlusPlus.setTriggerList">[docs]</a>
    <span class="k">def</span> <span class="nf">setTriggerList</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">triggerList</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="mh">0xFFFF</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Sets up Trigger pulses in Bits++ using the fine grained</span>
<span class="sd">            method that can control every trigger line at 100uS</span>
<span class="sd">            intervals.</span>
<span class="sd">           </span>
<span class="sd">            TriggerList should contain 1 entry for every 100uS </span>
<span class="sd">            packet (see getPackets) the binary word in each entry </span>
<span class="sd">            specifies which trigger line will be active during that</span>
<span class="sd">            time slot.</span>
<span class="sd">        </span>
<span class="sd">            Note that mask only protects the digital output lines</span>
<span class="sd">            set by other activities in the Bits. Not other triggers.</span>
<span class="sd">            </span>
<span class="sd">            Example::</span>

<span class="sd">                packet = [0]*self._NumberPackets</span>
<span class="sd">                packet[0] = 0b0000000010</span>
<span class="sd">                bits.setTriggerList(packet)</span>
<span class="sd">            </span>
<span class="sd">            Will sens a 100us pulse on DOUT1 at the start of the frame.</span>
<span class="sd">            </span>
<span class="sd">             Example 2::</span>

<span class="sd">                packet = [0]*self._NumberPackets</span>
<span class="sd">                packet[10] = 0b0000000010</span>
<span class="sd">                packet[20] = 0b0000000001</span>
<span class="sd">                bits.setTriggerList(packet)</span>
<span class="sd">                bits.startTrigger()</span>
<span class="sd">            </span>
<span class="sd">            Will sens a 100us pulse on DOUT1 1000us after the start of the </span>
<span class="sd">            frame and a second 100us pusle on DOUT0 2000us after the start of</span>
<span class="sd">            the frame.</span>
<span class="sd">            </span>
<span class="sd">            Triggers will continue until stopTrigger is called.</span>
<span class="sd">            </span>
<span class="sd">        &quot;&quot;&quot;</span>
                                                                               
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">triggerList</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_NumberPackets</span><span class="p">:</span>
            <span class="n">warning</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;setTriggerList: TriggerList does not &quot;</span>
                       <span class="s2">&quot;contain enough data&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="n">warning</span><span class="p">)</span>
        
        <span class="c1"># Constants for FE1 via D25 connector goggle settings.</span>
        <span class="n">bothOpen</span> <span class="o">=</span> <span class="mi">16</span>
        <span class="n">leftOpen</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">rightOpen</span> <span class="o">=</span> <span class="mi">32</span>
        <span class="n">bothClosed</span> <span class="o">=</span> <span class="mi">48</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gogglesGo</span><span class="p">:</span> <span class="c1"># Force mask to include goggles</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="mb">0b1111111111001111</span><span class="p">)</span> <span class="o">+</span><span class="mi">48</span>
        <span class="c1"># For every item in data packet representing trigger values.</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_NumberPackets</span><span class="p">):</span>
            <span class="c1"># Select the item</span>
            <span class="n">trig</span><span class="o">=</span><span class="n">triggerList</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="c1"># Mask out the original tirggers and add in the four possible</span>
            <span class="c1"># goggle states.</span>
            <span class="n">trigBothOpen</span> <span class="o">=</span> <span class="p">(</span><span class="n">trig</span> <span class="o">&amp;</span> <span class="mb">0b1111111111001111</span><span class="p">)</span> <span class="o">+</span> <span class="n">bothOpen</span>
            <span class="n">trigLeftOpen</span> <span class="o">=</span> <span class="p">(</span><span class="n">trig</span> <span class="o">&amp;</span> <span class="mb">0b1111111111001111</span><span class="p">)</span> <span class="o">+</span> <span class="n">leftOpen</span>
            <span class="n">trigRightOpen</span> <span class="o">=</span> <span class="p">(</span><span class="n">trig</span> <span class="o">&amp;</span> <span class="mb">0b1111111111001111</span><span class="p">)</span> <span class="o">+</span> <span class="n">rightOpen</span>
            <span class="n">trigBothClosed</span> <span class="o">=</span> <span class="p">(</span><span class="n">trig</span> <span class="o">&amp;</span> <span class="mb">0b1111111111001111</span><span class="p">)</span> <span class="o">+</span> <span class="n">bothClosed</span>
            <span class="c1"># Set up the TLock Memory address indexes for the trigger alone</span>
            <span class="c1"># and the trigger with all possible goggle states.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandTrig</span><span class="p">[</span><span class="mi">19</span><span class="o">+</span><span class="n">index</span><span class="o">*</span><span class="mi">2</span><span class="p">,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">index</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandGogLeftOpen</span><span class="p">[</span><span class="mi">19</span><span class="o">+</span><span class="n">index</span><span class="o">*</span><span class="mi">2</span><span class="p">,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">index</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandGogRightOpen</span><span class="p">[</span><span class="mi">19</span><span class="o">+</span><span class="n">index</span><span class="o">*</span><span class="mi">2</span><span class="p">,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">index</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandGogBothOpen</span><span class="p">[</span><span class="mi">19</span><span class="o">+</span><span class="n">index</span><span class="o">*</span><span class="mi">2</span><span class="p">,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">index</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandGogBothClosed</span><span class="p">[</span><span class="mi">19</span><span class="o">+</span><span class="n">index</span><span class="o">*</span><span class="mi">2</span><span class="p">,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">index</span>
            <span class="c1"># Set the data payload within the TLock for the trigger alone.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandTrig</span><span class="p">[</span><span class="mi">19</span><span class="o">+</span><span class="n">index</span><span class="o">*</span><span class="mi">2</span><span class="p">,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">trig</span> <span class="o">/</span> <span class="mi">256</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandTrig</span><span class="p">[</span><span class="mi">19</span><span class="o">+</span><span class="n">index</span><span class="o">*</span><span class="mi">2</span><span class="p">,:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">remainder</span><span class="p">(</span><span class="n">trig</span><span class="p">,</span><span class="mi">256</span><span class="p">))</span>
            <span class="c1"># Set the data payloads for the triggers with all possible goggle states.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandGogLeftOpen</span><span class="p">[</span><span class="mi">19</span><span class="o">+</span><span class="n">index</span><span class="o">*</span><span class="mi">2</span><span class="p">,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                                            <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">trigLeftOpen</span> <span class="o">/</span> <span class="mi">256</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandGogLeftOpen</span><span class="p">[</span><span class="mi">19</span><span class="o">+</span><span class="n">index</span><span class="o">*</span><span class="mi">2</span><span class="p">,:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                                            <span class="n">np</span><span class="o">.</span><span class="n">remainder</span><span class="p">(</span><span class="n">trigLeftOpen</span><span class="p">,</span> <span class="mi">256</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandGogRightOpen</span><span class="p">[</span><span class="mi">19</span><span class="o">+</span><span class="n">index</span><span class="o">*</span><span class="mi">2</span><span class="p">,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                                            <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">trigRightOpen</span> <span class="o">/</span> <span class="mi">256</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandGogRightOpen</span><span class="p">[</span><span class="mi">19</span><span class="o">+</span><span class="n">index</span><span class="o">*</span><span class="mi">2</span><span class="p">,:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                                            <span class="n">np</span><span class="o">.</span><span class="n">remainder</span><span class="p">(</span><span class="n">trigRightOpen</span><span class="p">,</span> <span class="mi">256</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandGogBothOpen</span><span class="p">[</span><span class="mi">19</span><span class="o">+</span><span class="n">index</span><span class="o">*</span><span class="mi">2</span><span class="p">,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                                            <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">trigBothOpen</span> <span class="o">/</span> <span class="mi">256</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandGogBothOpen</span><span class="p">[</span><span class="mi">19</span><span class="o">+</span><span class="n">index</span><span class="o">*</span><span class="mi">2</span><span class="p">,:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                                            <span class="n">np</span><span class="o">.</span><span class="n">remainder</span><span class="p">(</span><span class="n">trigBothOpen</span><span class="p">,</span> <span class="mi">256</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandGogBothClosed</span><span class="p">[</span><span class="mi">19</span><span class="o">+</span><span class="n">index</span><span class="o">*</span><span class="mi">2</span><span class="p">,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                                            <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">trigBothClosed</span> <span class="o">/</span> <span class="mi">256</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandGogBothClosed</span><span class="p">[</span><span class="mi">19</span><span class="o">+</span><span class="n">index</span><span class="o">*</span><span class="mi">2</span><span class="p">,:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                                            <span class="n">np</span><span class="o">.</span><span class="n">remainder</span><span class="p">(</span><span class="n">trigBothClosed</span><span class="p">,</span> <span class="mi">256</span><span class="p">))</span>
        <span class="c1"># Set the hardware mask in each TLock.                            </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandTrig</span><span class="p">[</span><span class="mi">17</span><span class="p">,:,</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">mask</span><span class="o">/</span><span class="mi">256</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandTrig</span><span class="p">[</span><span class="mi">17</span><span class="p">,:,</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">remainder</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span><span class="mi">256</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandGogLeftOpen</span><span class="p">[</span><span class="mi">17</span><span class="p">,:,</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">mask</span><span class="o">/</span><span class="mi">256</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandGogLeftOpen</span><span class="p">[</span><span class="mi">17</span><span class="p">,:,</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">remainder</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span><span class="mi">256</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandGogRightOpen</span><span class="p">[</span><span class="mi">17</span><span class="p">,:,</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">mask</span><span class="o">/</span><span class="mi">256</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandGogRightOpen</span><span class="p">[</span><span class="mi">17</span><span class="p">,:,</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">remainder</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span><span class="mi">256</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandGogBothOpen</span><span class="p">[</span><span class="mi">17</span><span class="p">,:,</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">mask</span><span class="o">/</span><span class="mi">256</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandGogBothOpen</span><span class="p">[</span><span class="mi">17</span><span class="p">,:,</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">remainder</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span><span class="mi">256</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandGogBothClosed</span><span class="p">[</span><span class="mi">17</span><span class="p">,:,</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">mask</span><span class="o">/</span><span class="mi">256</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandGogBothClosed</span><span class="p">[</span><span class="mi">17</span><span class="p">,:,</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">remainder</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span><span class="mi">256</span><span class="p">))</span>
        
        <span class="c1"># Turn the trigger only payload into a string </span>
        <span class="c1"># The goggles payloads are dealt with elsewhere.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandTrigStr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandTrig</span><span class="o">.</span><span class="n">tostring</span><span class="p">()</span>
        
        <span class="c1"># Any attempt to set the triggers should un-protect them</span>
        <span class="c1"># since by definition the protected values are no longer valid.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">triggerProtected</span> <span class="o">=</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="BitsPlusPlus.sendTrigger">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.BitsPlusPlus.sendTrigger">[docs]</a>
    <span class="k">def</span> <span class="nf">sendTrigger</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">triggers</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">onTime</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                      <span class="n">mask</span><span class="o">=</span><span class="mi">65535</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Sends a single trigger using up 1 win.flip.</span>
<span class="sd">            The trigger will be sent on the following frame.</span>
<span class="sd">        </span>
<span class="sd">            The triggers will continue until after the next win.flip.</span>
<span class="sd">            </span>
<span class="sd">            Actions are always 1 frame after the request.</span>
<span class="sd">        </span>
<span class="sd">            May do odd things if Goggles and Analog are also</span>
<span class="sd">            in use.</span>
<span class="sd">            </span>
<span class="sd">            Example::</span>

<span class="sd">                bits.sendTrigger(0b0000000010, 2.0, 4.0)</span>
<span class="sd">                bits.win.flip()</span>
<span class="sd">            </span>
<span class="sd">            Will send a 4ms puilse on DOUT1 2ms after the start of the frame.</span>
<span class="sd">            Due to the following win.flip() the pulse should last for 1 frame only.</span>
<span class="sd">            </span>
<span class="sd">            Triggers will continue until stopTrigger is called.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setTrigger</span><span class="p">(</span><span class="n">triggers</span><span class="p">,</span><span class="n">onTime</span><span class="p">,</span><span class="n">duration</span><span class="p">,</span><span class="n">mask</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="o">=</span><span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">win</span><span class="o">.</span><span class="n">flip</span><span class="p">()</span> <span class="c1"># Send the trigger but trigger not acted on until the next frame. </span>
        <span class="c1">#If next winflip is late the trigger will be repeated until it is cleared by the next winflip</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="o">=</span><span class="kc">False</span></div>

        
<div class="viewcode-block" id="BitsPlusPlus.startTrigger">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.BitsPlusPlus.startTrigger">[docs]</a>
    <span class="k">def</span> <span class="nf">startTrigger</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Start sending triggers on the next win flip </span>
<span class="sd">            and continue until stopped by stopTrigger</span>
<span class="sd">            Triggers start 1 frame after the frame on which </span>
<span class="sd">            the first trigger is sent.</span>
<span class="sd">            </span>
<span class="sd">            Example::</span>

<span class="sd">                bits.setTrigger(0b0000000010, 2.0, 4.0, 0b0111111111)</span>
<span class="sd">                bits.startTrigger()</span>
<span class="sd">                while imageOn:</span>
<span class="sd">                    #do some processing</span>
<span class="sd">                    continue</span>
<span class="sd">                bits.stopTrigger()</span>
<span class="sd">                bits.win.flip()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># If triggers have been protected from another TLock action</span>
        <span class="c1"># we will need to restore them first.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">triggerProtected</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_restoreTrigger</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">triggerProtected</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="o">=</span><span class="kc">True</span></div>

        
<div class="viewcode-block" id="BitsPlusPlus.stopTrigger">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.BitsPlusPlus.stopTrigger">[docs]</a>
    <span class="k">def</span> <span class="nf">stopTrigger</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Stop sending triggers at the next win flip</span>
<span class="sd">        </span>
<span class="sd">        Example:</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">                bits.setTrigger(0b0000000010, 2.0, 4.0, 0b0111111111)</span>
<span class="sd">                bits.startTrigger()</span>
<span class="sd">                while imageOn:</span>
<span class="sd">                    #do some processing</span>
<span class="sd">                    continue</span>
<span class="sd">                bits.stopTrigger()</span>
<span class="sd">                bits.win.flip()</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># This is a hack to get triggers to stop on the one</span>
        <span class="c1"># Bits++ box tested.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="o">=</span><span class="kc">False</span> <span class="c1"># Needed before protecting triggers.</span>
        <span class="c1"># Protect existing triggers. Also sets triggers to zero.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_protectTrigger</span><span class="p">()</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="o">=</span><span class="kc">True</span> <span class="c1"># Needed to send the zero trigger.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">win</span><span class="o">.</span><span class="n">flip</span><span class="p">()</span> <span class="c1"># Make sure zero trigger is sent.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="o">=</span><span class="kc">False</span> <span class="c1"># Now turn off triggers.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_restoreTrigger</span><span class="p">()</span> <span class="c1"># Recover old triggers for</span></div>

                               <span class="c1"># Future use</span>


<div class="viewcode-block" id="BitsPlusPlus.startGoggles">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.BitsPlusPlus.startGoggles">[docs]</a>
    <span class="k">def</span> <span class="nf">startGoggles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">left</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">right</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Starts CRS stereo goggles. Note if you are</span>
<span class="sd">        using FE-1 goggles you should start this before</span>
<span class="sd">        connecting the goggles.</span>

<span class="sd">        Left is the state of the left shutter on the</span>
<span class="sd">        first frame to be presented 0, False or</span>
<span class="sd">        &#39;closed&#39;=closed; 1, True or &#39;open&#39; = open,</span>

<span class="sd">        right is the state of the right shutter on the</span>
<span class="sd">        first frame to be presented 0, False or</span>
<span class="sd">        &#39;closed&#39;=closed; 1, True or &#39;open&#39; = open</span>
<span class="sd">        </span>
<span class="sd">        Note you can set the goggles to be both open </span>
<span class="sd">        or both closed on the same frame.</span>
<span class="sd">        </span>
<span class="sd">        The system will always toggle the state of </span>
<span class="sd">        each lens so as to not damage FE-1 goggles.</span>
<span class="sd">        </span>
<span class="sd">        Example::</span>

<span class="sd">            bits.startGoggles(0,1)</span>
<span class="sd">            bits.win.flip()</span>
<span class="sd">            while not response</span>
<span class="sd">                bits.win.flip()</span>
<span class="sd">                #do some processing</span>
<span class="sd">            bits.stopGoggles()</span>
<span class="sd">            bits.win.flip()</span>
<span class="sd">            </span>
<span class="sd">        Starts toggling the goggles with the right eye open in sync with the</span>
<span class="sd">        first win.flip() within the loop. The open eye will alternate.</span>
<span class="sd">            </span>
<span class="sd">        Example::</span>

<span class="sd">            bits.startGoggles(1,1)</span>
<span class="sd">            bits.win.flip()</span>
<span class="sd">            while not response:</span>
<span class="sd">                bits.win.flip()</span>
<span class="sd">                #do some processing</span>
<span class="sd">            bits.stopGoggles()</span>
<span class="sd">            bits.win.flip()</span>
<span class="sd">            </span>
<span class="sd">        Starts toggling the goggle with both eyes open in sync with the first</span>
<span class="sd">        win.flip() within the loop. Eyes will alternate between both open and both closed.</span>
<span class="sd">        </span>
<span class="sd">        Note it is safe to leave the goggles toggling forever, ie to never call stopGoggles().</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Protect any existing trigger settings if required.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_protectTrigger</span><span class="p">()</span> <span class="c1"># Also sets triggers to zero.</span>
        <span class="k">if</span> <span class="n">left</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;closed&#39;</span><span class="p">,</span><span class="s1">&#39;Closed&#39;</span><span class="p">):</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">gogglesLeft</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="n">left</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">,</span><span class="s1">&#39;Open&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gogglesLeft</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gogglesLeft</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">left</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">right</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;closed&#39;</span><span class="p">,</span><span class="s1">&#39;Closed&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gogglesRight</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="n">right</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">,</span><span class="s1">&#39;Open&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gogglesRight</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gogglesRight</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">right</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gogglesGo</span> <span class="o">=</span> <span class="kc">True</span></div>

            
<div class="viewcode-block" id="BitsPlusPlus.stopGoggles">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.BitsPlusPlus.stopGoggles">[docs]</a>
    <span class="k">def</span> <span class="nf">stopGoggles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Stop the stereo goggles from toggling </span>
<span class="sd">        </span>
<span class="sd">        Example::</span>

<span class="sd">            bits.startGoggles(0,1)</span>
<span class="sd">            bits.win.flip()</span>
<span class="sd">            while not response:</span>
<span class="sd">                bits.win.flip()</span>
<span class="sd">                #do some processing</span>
<span class="sd">            bits.stopGoggles()</span>
<span class="sd">            bits.win.flip()</span>
<span class="sd">            </span>
<span class="sd">        Starts toggling the goggles with the right eye open in sync with the</span>
<span class="sd">        first win.flip(0) within the loop. The open eye will alternate.</span>

<span class="sd">        Note it is safer to leave the goggles toggling forever, ie to never call stopGoggles().</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Restore old triggers if goggles used without other triggers.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_restoreTrigger</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stopTrigger</span><span class="p">()</span> <span class="c1">#A hack for Bits++</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gogglesGo</span> <span class="o">=</span> <span class="kc">False</span></div>



<div class="viewcode-block" id="BitsPlusPlus.reset">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.BitsPlusPlus.reset">[docs]</a>
    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Deprecated: This was used on the old Bits++</span>
<span class="sd">        to power-cycle the box.</span>
<span class="sd">        It required the compiled dll, which only worked </span>
<span class="sd">        on windows and doesn&#39;t work with Bits# or Display++.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">reset</span><span class="p">()</span></div>


    <span class="c1">#==========================================#</span>
    <span class="c1"># Helper functions for LUTs and Triggers   #</span>
    <span class="c1"># Should not be needed by user             #</span>
    <span class="c1">#==========================================#</span>

    <span class="k">def</span> <span class="nf">_protectTrigger</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; If Goggles (or analog) outputs are used when the</span>
<span class="sd">        digital triggers are off we need to make a set of blank </span>
<span class="sd">        triggers first. But the user might have set up triggers</span>
<span class="sd">        in waiting for a later time. So this will protect them.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># No need to do this if triggers are active anyway.</span>
        <span class="c1"># or if they are already being protected.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">triggerProtected</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_keepTrig</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_HEADandTrig</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_keepGogLeftOpen</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_HEADandGogLeftOpen</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_keepGogRightOpen</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_HEADandGogRightOpen</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_keepGogBothOpen</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_HEADandGogBothOpen</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_keepGogBothClosed</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_HEADandGogBothClosed</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setTrigger</span><span class="p">()</span>
            <span class="c1"># Set flag to tell trigger start that it has to recover its </span>
            <span class="c1"># trigger headers.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">triggerProtected</span> <span class="o">=</span> <span class="kc">True</span>
        
    <span class="k">def</span> <span class="nf">_restoreTrigger</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Restores the triggers to previous settings</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># No need to do this if triggers are running as will have been</span>
        <span class="c1"># recovered already if required.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandTrig</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_keepTrig</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandTrigStr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandTrig</span><span class="o">.</span><span class="n">tostring</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandGogLeftOpen</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_keepGogLeftOpen</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandGogRightOpen</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_keepGogRightOpen</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandGogBothOpen</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_keepGogBothOpen</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandGogBothClosed</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_keepGogBothClosed</span><span class="p">)</span>
            <span class="c1"># Set flag to tell trigger start that it has no need to recover its </span>
            <span class="c1"># trigger headers.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">triggerProtected</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_drawLUTtoScreen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;(private) Used to set the LUT in &#39;bits++&#39; mode.</span>
<span class="sd">        Should not be needed by user if attached to a</span>
<span class="sd">        :class:`~psychopy.visual.Window` since this will automatically</span>
<span class="sd">        draw the LUT as part of the screen refresh.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># push the projection matrix and set to orthographic</span>
        <span class="n">GL</span><span class="o">.</span><span class="n">glMatrixMode</span><span class="p">(</span><span class="n">GL</span><span class="o">.</span><span class="n">GL_PROJECTION</span><span class="p">)</span>
        <span class="n">GL</span><span class="o">.</span><span class="n">glPushMatrix</span><span class="p">()</span>
        <span class="n">GL</span><span class="o">.</span><span class="n">glLoadIdentity</span><span class="p">()</span>
        <span class="c1"># this also sets the 0,0 to be top-left</span>
        <span class="n">GL</span><span class="o">.</span><span class="n">glOrtho</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">win</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">win</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># but return to modelview for rendering</span>
        <span class="n">GL</span><span class="o">.</span><span class="n">glMatrixMode</span><span class="p">(</span><span class="n">GL</span><span class="o">.</span><span class="n">GL_MODELVIEW</span><span class="p">)</span>
        <span class="n">GL</span><span class="o">.</span><span class="n">glLoadIdentity</span><span class="p">()</span>

        <span class="c1"># draw the pixels</span>
        <span class="n">GL</span><span class="o">.</span><span class="n">glActiveTexture</span><span class="p">(</span><span class="n">GL</span><span class="o">.</span><span class="n">GL_TEXTURE0</span><span class="p">)</span>
        <span class="n">GL</span><span class="o">.</span><span class="n">glEnable</span><span class="p">(</span><span class="n">GL</span><span class="o">.</span><span class="n">GL_TEXTURE_2D</span><span class="p">)</span>
        <span class="n">GL</span><span class="o">.</span><span class="n">glBindTexture</span><span class="p">(</span><span class="n">GL</span><span class="o">.</span><span class="n">GL_TEXTURE_2D</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">GL</span><span class="o">.</span><span class="n">glActiveTexture</span><span class="p">(</span><span class="n">GL</span><span class="o">.</span><span class="n">GL_TEXTURE1</span><span class="p">)</span>
        <span class="n">GL</span><span class="o">.</span><span class="n">glEnable</span><span class="p">(</span><span class="n">GL</span><span class="o">.</span><span class="n">GL_TEXTURE_2D</span><span class="p">)</span>
        <span class="n">GL</span><span class="o">.</span><span class="n">glBindTexture</span><span class="p">(</span><span class="n">GL</span><span class="o">.</span><span class="n">GL_TEXTURE_2D</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">GL</span><span class="o">.</span><span class="n">glRasterPos2i</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">GL</span><span class="o">.</span><span class="n">glPixelStorei</span><span class="p">(</span><span class="n">GL</span><span class="o">.</span><span class="n">GL_UNPACK_ALIGNMENT</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">GL</span><span class="o">.</span><span class="n">glDrawPixels</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_HEADandLUT</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span>
                        <span class="n">GL</span><span class="o">.</span><span class="n">GL_RGB</span><span class="p">,</span> <span class="n">GL</span><span class="o">.</span><span class="n">GL_UNSIGNED_BYTE</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandLUTstr</span><span class="p">)</span>
        <span class="c1"># GL.glDrawPixels(524,1, GL.GL_RGB,GL.GL_UNSIGNED_BYTE,</span>
        <span class="c1">#    self._HEADandLUTstr)</span>
        <span class="c1"># return to 3D mode (go and pop the projection matrix)</span>
        <span class="n">GL</span><span class="o">.</span><span class="n">glMatrixMode</span><span class="p">(</span><span class="n">GL</span><span class="o">.</span><span class="n">GL_PROJECTION</span><span class="p">)</span>
        <span class="n">GL</span><span class="o">.</span><span class="n">glPopMatrix</span><span class="p">()</span>
        <span class="n">GL</span><span class="o">.</span><span class="n">glMatrixMode</span><span class="p">(</span><span class="n">GL</span><span class="o">.</span><span class="n">GL_MODELVIEW</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">_ResetClock</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;(private) Used to reset Bits hardware clock.</span>
<span class="sd">        Should not be needed by user if attached to a </span>
<span class="sd">        :class:`~psychopy.visual.Window`</span>
<span class="sd">        since this will automatically draw the </span>
<span class="sd">        reset code as part of the screen refresh.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#push the projection matrix and set to orthographic</span>
        <span class="n">GL</span><span class="o">.</span><span class="n">glMatrixMode</span><span class="p">(</span><span class="n">GL</span><span class="o">.</span><span class="n">GL_PROJECTION</span><span class="p">)</span>
        <span class="n">GL</span><span class="o">.</span><span class="n">glPushMatrix</span><span class="p">()</span>
        <span class="n">GL</span><span class="o">.</span><span class="n">glLoadIdentity</span><span class="p">()</span>
        <span class="n">GL</span><span class="o">.</span><span class="n">glOrtho</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">win</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">win</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="p">)</span>    <span class="c1">#this also sets the 0,0 to be top-left</span>
        <span class="c1">#but return to modelview for rendering</span>
        <span class="n">GL</span><span class="o">.</span><span class="n">glMatrixMode</span><span class="p">(</span><span class="n">GL</span><span class="o">.</span><span class="n">GL_MODELVIEW</span><span class="p">)</span>
        <span class="n">GL</span><span class="o">.</span><span class="n">glLoadIdentity</span><span class="p">()</span>

        <span class="c1"># unload texture</span>
        <span class="n">GL</span><span class="o">.</span><span class="n">glActiveTexture</span><span class="p">(</span><span class="n">GL</span><span class="o">.</span><span class="n">GL_TEXTURE0</span><span class="p">)</span>
        <span class="n">GL</span><span class="o">.</span><span class="n">glEnable</span><span class="p">(</span><span class="n">GL</span><span class="o">.</span><span class="n">GL_TEXTURE_2D</span><span class="p">)</span>
        <span class="n">GL</span><span class="o">.</span><span class="n">glBindTexture</span><span class="p">(</span><span class="n">GL</span><span class="o">.</span><span class="n">GL_TEXTURE_2D</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="c1"># unload mask</span>
        <span class="n">GL</span><span class="o">.</span><span class="n">glActiveTexture</span><span class="p">(</span><span class="n">GL</span><span class="o">.</span><span class="n">GL_TEXTURE1</span><span class="p">)</span>
        <span class="n">GL</span><span class="o">.</span><span class="n">glEnable</span><span class="p">(</span><span class="n">GL</span><span class="o">.</span><span class="n">GL_TEXTURE_2D</span><span class="p">)</span>
        <span class="n">GL</span><span class="o">.</span><span class="n">glBindTexture</span><span class="p">(</span><span class="n">GL</span><span class="o">.</span><span class="n">GL_TEXTURE_2D</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="c1"># draw the pixels</span>
        <span class="n">GL</span><span class="o">.</span><span class="n">glRasterPos2i</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">GL</span><span class="o">.</span><span class="n">glPixelStorei</span><span class="p">(</span><span class="n">GL</span><span class="o">.</span><span class="n">GL_UNPACK_ALIGNMENT</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">GL</span><span class="o">.</span><span class="n">glDrawPixels</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_HEADandClock</span><span class="p">),</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">GL</span><span class="o">.</span><span class="n">GL_RGB</span><span class="p">,</span><span class="n">GL</span><span class="o">.</span><span class="n">GL_UNSIGNED_BYTE</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandClockstr</span><span class="p">)</span>
        <span class="c1">#return to 3D mode (go and pop the projection matrix)</span>
        <span class="n">GL</span><span class="o">.</span><span class="n">glMatrixMode</span><span class="p">(</span> <span class="n">GL</span><span class="o">.</span><span class="n">GL_PROJECTION</span> <span class="p">)</span>
        <span class="n">GL</span><span class="o">.</span><span class="n">glPopMatrix</span><span class="p">()</span>
        <span class="n">GL</span><span class="o">.</span><span class="n">glMatrixMode</span><span class="p">(</span> <span class="n">GL</span><span class="o">.</span><span class="n">GL_MODELVIEW</span> <span class="p">)</span>
        <span class="c1"># ensures that only 1 clock reset pulse will be issed at a time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clockReset</span><span class="o">=</span><span class="kc">False</span> 

    <span class="k">def</span> <span class="nf">_drawTrigtoScreen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sendStr</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;(private) Used to send a trigger pulse.</span>
<span class="sd">        Should not be needed by user if attached to a </span>
<span class="sd">        :class:`~psychopy.visual.Window`</span>
<span class="sd">        since this will automatically draw the trigger code as </span>
<span class="sd">        part of the screen refresh.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">sendStr</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sendStr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandTrigStr</span>
        
        <span class="c1">#push the projection matrix and set to orthographic</span>
        <span class="n">GL</span><span class="o">.</span><span class="n">glMatrixMode</span><span class="p">(</span><span class="n">GL</span><span class="o">.</span><span class="n">GL_PROJECTION</span><span class="p">)</span>
        <span class="n">GL</span><span class="o">.</span><span class="n">glPushMatrix</span><span class="p">()</span>
        <span class="n">GL</span><span class="o">.</span><span class="n">glLoadIdentity</span><span class="p">()</span>
        <span class="n">GL</span><span class="o">.</span><span class="n">glOrtho</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">win</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">win</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="p">)</span>    <span class="c1">#this also sets the 0,0 to be top-left</span>
        <span class="c1">#but return to modelview for rendering</span>
        <span class="n">GL</span><span class="o">.</span><span class="n">glMatrixMode</span><span class="p">(</span><span class="n">GL</span><span class="o">.</span><span class="n">GL_MODELVIEW</span><span class="p">)</span>
        <span class="n">GL</span><span class="o">.</span><span class="n">glLoadIdentity</span><span class="p">()</span>

        <span class="c1">#draw the pixels</span>
        <span class="n">GL</span><span class="o">.</span><span class="n">glActiveTexture</span><span class="p">(</span><span class="n">GL</span><span class="o">.</span><span class="n">GL_TEXTURE0</span><span class="p">)</span>
        <span class="n">GL</span><span class="o">.</span><span class="n">glEnable</span><span class="p">(</span><span class="n">GL</span><span class="o">.</span><span class="n">GL_TEXTURE_2D</span><span class="p">)</span>
        <span class="n">GL</span><span class="o">.</span><span class="n">glBindTexture</span><span class="p">(</span><span class="n">GL</span><span class="o">.</span><span class="n">GL_TEXTURE_2D</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">GL</span><span class="o">.</span><span class="n">glActiveTexture</span><span class="p">(</span><span class="n">GL</span><span class="o">.</span><span class="n">GL_TEXTURE1</span><span class="p">)</span>
        <span class="n">GL</span><span class="o">.</span><span class="n">glEnable</span><span class="p">(</span><span class="n">GL</span><span class="o">.</span><span class="n">GL_TEXTURE_2D</span><span class="p">)</span>
        <span class="n">GL</span><span class="o">.</span><span class="n">glBindTexture</span><span class="p">(</span><span class="n">GL</span><span class="o">.</span><span class="n">GL_TEXTURE_2D</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">GL</span><span class="o">.</span><span class="n">glRasterPos2i</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">GL</span><span class="o">.</span><span class="n">glPixelStorei</span><span class="p">(</span><span class="n">GL</span><span class="o">.</span><span class="n">GL_UNPACK_ALIGNMENT</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">GL</span><span class="o">.</span><span class="n">glDrawPixels</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_HEADandTrig</span><span class="p">),</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">GL</span><span class="o">.</span><span class="n">GL_RGB</span><span class="p">,</span><span class="n">GL</span><span class="o">.</span><span class="n">GL_UNSIGNED_BYTE</span><span class="p">,</span>
            <span class="n">sendStr</span><span class="p">)</span>
        <span class="n">GL</span><span class="o">.</span><span class="n">glMatrixMode</span><span class="p">(</span> <span class="n">GL</span><span class="o">.</span><span class="n">GL_PROJECTION</span> <span class="p">)</span>
        <span class="n">GL</span><span class="o">.</span><span class="n">glPopMatrix</span><span class="p">()</span>
        <span class="n">GL</span><span class="o">.</span><span class="n">glMatrixMode</span><span class="p">(</span> <span class="n">GL</span><span class="o">.</span><span class="n">GL_MODELVIEW</span> <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_Goggles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;(private) Used to set control the goggles.</span>
<span class="sd">        Should not be needed by user if attached to a </span>
<span class="sd">        :class:`~psychopy.visual.Window`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Work out current goggles state value.</span>
        <span class="n">gogglesState</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gogglesRight</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">gogglesLeft</span>

        <span class="c1"># Toggle the goggle states ready for the next win flip</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gogglesLeft</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">gogglesLeft</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gogglesRight</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">gogglesRight</span>
 
        <span class="c1"># Use gogleState to load the desired goggle trigger pattern into.</span>
        <span class="c1"># the TLock and draw this trigger.</span>
        <span class="k">if</span> <span class="n">gogglesState</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_drawTrigtoScreen</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_HEADandGogBothOpen</span><span class="o">.</span><span class="n">tostring</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">gogglesState</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_drawTrigtoScreen</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_HEADandGogLeftOpen</span><span class="o">.</span><span class="n">tostring</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">gogglesState</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_drawTrigtoScreen</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_HEADandGogRightOpen</span><span class="o">.</span><span class="n">tostring</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">gogglesState</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_drawTrigtoScreen</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_HEADandGogBothClosed</span><span class="o">.</span><span class="n">tostring</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">_setupShaders</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;creates and stores the shader programs needed for mono++ and</span>
<span class="sd">        color++ modes</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">haveShaders</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_shaders</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">shCompile</span> <span class="o">=</span> <span class="n">shaders</span><span class="o">.</span><span class="n">compileProgram</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_shaders</span><span class="p">[</span><span class="s1">&#39;mono++&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">shCompile</span><span class="p">(</span><span class="n">shaders</span><span class="o">.</span><span class="n">vertSimple</span><span class="p">,</span>
                                            <span class="n">shaders</span><span class="o">.</span><span class="n">bitsMonoModeFrag</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_shaders</span><span class="p">[</span><span class="s1">&#39;color++&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">shCompile</span><span class="p">(</span><span class="n">shaders</span><span class="o">.</span><span class="n">vertSimple</span><span class="p">,</span>
                                             <span class="n">shaders</span><span class="o">.</span><span class="n">bitsColorModeFrag</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_prepareFBOrender</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;mono++&#39;</span><span class="p">:</span>
            <span class="n">GL</span><span class="o">.</span><span class="n">glUseProgram</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_shaders</span><span class="p">[</span><span class="s1">&#39;mono++&#39;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;color++&#39;</span><span class="p">:</span>
            <span class="n">GL</span><span class="o">.</span><span class="n">glUseProgram</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_shaders</span><span class="p">[</span><span class="s1">&#39;color++&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">GL</span><span class="o">.</span><span class="n">glUseProgram</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">win</span><span class="o">.</span><span class="n">_progFBOtoFrame</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_finishFBOrender</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">GL</span><span class="o">.</span><span class="n">glUseProgram</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_afterFBOrender</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">GL</span><span class="o">.</span><span class="n">glDisable</span><span class="p">(</span><span class="n">GL</span><span class="o">.</span><span class="n">GL_BLEND</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;bits&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_drawLUTtoScreen</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gogglesGo</span><span class="p">:</span> <span class="c1"># Will also send triggers if started</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_Goggles</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_drawTrigtoScreen</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">clockReset</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ResetClock</span><span class="p">()</span>
        <span class="n">GL</span><span class="o">.</span><span class="n">glEnable</span><span class="p">(</span><span class="n">GL</span><span class="o">.</span><span class="n">GL_BLEND</span><span class="p">)</span></div>



<div class="viewcode-block" id="BitsSharp">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.BitsSharp">[docs]</a>
<span class="k">class</span> <span class="nc">BitsSharp</span><span class="p">(</span><span class="n">BitsPlusPlus</span><span class="p">,</span> <span class="n">serialdevice</span><span class="o">.</span><span class="n">SerialDevice</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A class to support functions of the Bits# (and most Display++ functions</span>
<span class="sd">    This device uses the CDC (serial port) connection to the Bits box.</span>
<span class="sd">    To use it you must have followed the instructions from CRS Ltd. to get</span>
<span class="sd">    your box into the CDC communication mode.</span>
<span class="sd">    Typical usage (also see demo in Coder view demos&gt;hardware&gt;BitsBox ):</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        from psychopy import visual</span>
<span class="sd">        from psychopy.hardware import crs</span>
<span class="sd">        # we need to be rendering to framebuffer</span>
<span class="sd">        win = visual.Window([1024,768], useFBO=True)</span>
<span class="sd">        bits = crs.BitsSharp(win, mode = &#39;mono++&#39;)</span>
<span class="sd">        # You can continue using your window as normal and OpenGL shaders</span>
<span class="sd">        # will convert the output as needed</span>
<span class="sd">        print(bits.info)</span>
<span class="sd">        if not bits.OK:</span>
<span class="sd">            print(&#39;failed to connect to Bits box&#39;)</span>
<span class="sd">            core.quit()</span>
<span class="sd">        core.wait(0.1)</span>
<span class="sd">        # now, you can change modes using</span>
<span class="sd">        bits.mode = &#39;mono++&#39; # &#39;color++&#39;, &#39;mono++&#39;, &#39;bits++&#39;, &#39;status&#39;</span>

<span class="sd">    Note that the firmware in Bits# boxes varies over time and some features of</span>
<span class="sd">    this class may not work for all firmware versions. Also Bits# boxes can be</span>
<span class="sd">    configured in various ways via their config.xml file so this class makes certain</span>
<span class="sd">    assumptions about the configuration. In particular it is assumed that all</span>
<span class="sd">    digital inputs, triggers and analog inputs are reported as part of status</span>
<span class="sd">    updates. If some of these report are disabled in your config.xml file </span>
<span class="sd">    then &#39;status&#39; and &#39;event&#39; commands in this class may not work.</span>
<span class="sd">    </span>
<span class="sd">    RTBox commands that reset the key mapping have been found not to work</span>
<span class="sd">    one some firmware</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;CRS Bits#&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">win</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">portName</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> 
                         <span class="n">checkConfigLevel</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                         <span class="n">gammaCorrect</span><span class="o">=</span><span class="s1">&#39;hardware&#39;</span><span class="p">,</span>
                         <span class="n">gamma</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">noComms</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        win : a PsychoPy :class:`~psychopy.visual.Window` object, required</span>

<span class="sd">        portName : str or int</span>
<span class="sd">            the (virtual) serial port to which the device is</span>
<span class="sd">            connected. If None then PsychoPy will search available</span>
<span class="sd">            serial ports and test communication (on OSX, the first</span>
<span class="sd">            match of `/dev/tty.usbmodemfa*` will be used and on</span>
<span class="sd">            linux `/dev/ttyS0` will be used</span>

<span class="sd">        mode : &#39;bits++&#39;, &#39;color++&#39;, &#39;mono++&#39;, &#39;status&#39;</span>

<span class="sd">        checkConfigLevel : int</span>

<span class="sd">            Allows you to specify how much checking of the device is</span>
<span class="sd">            done to ensure a valid identity look-up table. If you specify</span>
<span class="sd">            one level and it fails then the check will be escalated to</span>
<span class="sd">            the next level (e.g. if we check level 1 and find that it</span>
<span class="sd">            fails we try to find a new LUT):</span>

<span class="sd">                - 0 don&#39;t check at all</span>
<span class="sd">                - 1 check that the graphics driver and OS version haven&#39;t</span>
<span class="sd">                    changed since last LUT calibration</span>
<span class="sd">                - 2 check that the current LUT calibration still provides</span>
<span class="sd">                    identity (requires switch to status mode)</span>
<span class="sd">                - 3 search for a new identity look-up table (requires</span>
<span class="sd">                    switch to status mode)</span>

<span class="sd">        gammaCorrect : string</span>

<span class="sd">            G overning how gamma correction is performed:</span>
<span class="sd">            - &#39;hardware&#39;: use the gamma correction file stored on the</span>
<span class="sd">              hardware</span>
<span class="sd">            - &#39;FBO&#39;: gamma correct using shaders when rendering the FBO</span>
<span class="sd">              to back buffer</span>
<span class="sd">            - &#39;bitsMode&#39;: in bits++ mode there is a user-controlled LUT</span>
<span class="sd">              that we can use for gamma correction</span>

<span class="sd">        noComms : bool</span>
<span class="sd">            If True then don&#39;t try to communicate with the device at all</span>
<span class="sd">            (passive mode). This can be useful if you want to debug the</span>
<span class="sd">            system without actually having a Bits# connected.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># import pyglet.GL late so that we can import bits.py without it</span>
        <span class="c1"># initially</span>
        <span class="k">global</span> <span class="n">GL</span><span class="p">,</span> <span class="n">visual</span>
        <span class="kn">from</span> <span class="nn">psychopy</span> <span class="kn">import</span> <span class="n">visual</span>
        <span class="kn">import</span> <span class="nn">pyglet.gl</span> <span class="k">as</span> <span class="nn">GL</span>

        <span class="k">if</span> <span class="n">noComms</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">noComms</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">OK</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sendMessage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nullSendMessage</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">getResponse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nullGetResponse</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">noComms</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="c1"># look for device on valid serial ports</span>
            <span class="c1"># parity=&quot;N&quot;,  # &#39;N&#39;one, &#39;E&#39;ven, &#39;O&#39;dd, &#39;M&#39;ask,</span>
            <span class="n">serialdevice</span><span class="o">.</span><span class="n">SerialDevice</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">portName</span><span class="p">,</span>
                                               <span class="n">baudrate</span><span class="o">=</span><span class="mi">19200</span><span class="p">,</span>
                                               <span class="n">byteSize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">stopBits</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                               <span class="n">parity</span><span class="o">=</span><span class="s2">&quot;N&quot;</span><span class="p">,</span>
                                               <span class="n">eol</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
                                               <span class="n">maxAttempts</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                               <span class="n">pauseDuration</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                                               <span class="n">checkAwake</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">OK</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">win</span> <span class="o">=</span> <span class="n">win</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">noComms</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">frameRate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">win</span><span class="o">.</span><span class="n">getActualFrameRate</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span><span class="o">=</span><span class="s1">&#39;a&#39;</span>
            <span class="k">while</span> <span class="n">msg</span><span class="p">:</span>
                <span class="n">msg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="s1">&#39;$VideoFrameRate</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pause</span><span class="p">()</span>
            <span class="n">msg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="n">msg2</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">frameRate</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">msg2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_setHeaders</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frameRate</span><span class="p">)</span>
        <span class="c1"># flag for controlling analog outputs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">analog</span> <span class="o">=</span> <span class="kc">False</span>
        
        <span class="c1"># replace window methods with our custom ones</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">win</span><span class="o">.</span><span class="n">_prepareFBOrender</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepareFBOrender</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">win</span><span class="o">.</span><span class="n">_finishFBOrender</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_finishFBOrender</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">win</span><span class="o">.</span><span class="n">_afterFBOrender</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_afterFBOrender</span>

        <span class="c1"># Bits++ doesn&#39;t do its own correction so we need to</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gammaCorrect</span> <span class="o">=</span> <span class="n">gammaCorrect</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span> <span class="o">=</span> <span class="n">gamma</span>
        <span class="c1"># we have a confirmed connection. Now check details about device and</span>
        <span class="c1"># system</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;info&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getInfo</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">win</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">win</span><span class="p">,</span> <span class="s1">&#39;_prepareFBOrender&#39;</span><span class="p">):</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;BitsSharp was given an object as win &quot;</span>
                              <span class="s2">&quot;argument but this is not a visual.Window&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">win</span><span class="o">.</span><span class="n">_prepareFBOrender</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepareFBOrender</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">win</span><span class="o">.</span><span class="n">_finishFBOrender</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_finishFBOrender</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_setupShaders</span><span class="p">()</span>
            <span class="c1"># now check that we have a valid configuration of the box</span>
            <span class="k">if</span> <span class="n">checkConfigLevel</span><span class="p">:</span>
                <span class="n">ok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">checkConfigLevel</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">win</span><span class="o">.</span><span class="n">gammaRamp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">identityLUT</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># makes no sense if we have a window?</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> was not given any PsychoPy win&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="p">))</span>
  
        <span class="c1"># members for controlling the RTBox functionality</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">RTBoxMode</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;CB6&#39;</span><span class="p">,</span><span class="s1">&#39;down&#39;</span><span class="p">,</span><span class="s1">&#39;trigger&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">RTBoxEnabled</span> <span class="o">=</span> <span class="kc">False</span>
        
        <span class="c1"># Make sure that RTBox event logging is off</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">RTBoxDisable</span><span class="p">()</span>
        
        <span class="c1"># members for storing RTBox button presses</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">RTButtons</span><span class="o">=</span><span class="p">[]</span> <span class="c1"># list of button presses</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nRTPresses</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># number of button presses recorded</span>

        <span class="c1"># members for controlling the statusBox functionality</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statusBoxMode</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;CB6&#39;</span><span class="p">,</span><span class="s1">&#39;down&#39;</span><span class="p">,</span><span class="s1">&#39;trigger&#39;</span><span class="p">,</span><span class="s1">&#39;analog&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statusBoxEnabled</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statusButtonMap</span> <span class="o">=</span> <span class="p">[</span><span class="mi">99</span><span class="p">]</span><span class="o">*</span><span class="mi">23</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statusBoxThreshold</span> <span class="o">=</span> <span class="mf">9999.99</span>

        <span class="c1"># members for storing statusBox presses</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statusButtons</span><span class="o">=</span><span class="p">[]</span> <span class="c1"># list of button presses</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nStatusPresses</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># number of button presses recorded</span>
        
        <span class="c1"># members for controlling status logging and reporting</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statusDINBase</span> <span class="o">=</span> <span class="mb">0b1111111111</span>   <span class="c1">#initial values for ditgial ins</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statusIRBase</span> <span class="o">=</span> <span class="mb">0b111111</span>        <span class="c1">#initial values for CB6 IR box</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statusTrigInBase</span> <span class="o">=</span> <span class="mi">0</span>           <span class="c1">#initial values for TrigIn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statusADCBase</span> <span class="o">=</span> <span class="mi">0</span>              <span class="c1">#initial value for ADCs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statusThreshold</span> <span class="o">=</span> <span class="mf">9999.99</span>      <span class="c1">#threshold for ADC change</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statusMode</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;up&#39;</span><span class="p">,</span><span class="s1">&#39;down&#39;</span><span class="p">]</span>     <span class="c1">#Direction of events to be reported</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statusEnabled</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_statusSize</span> <span class="o">=</span> <span class="mi">111</span>
        
        <span class="c1"># members for storing status logs and reports</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statusQ</span><span class="o">=</span><span class="n">Queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">(</span><span class="mi">70000</span><span class="p">)</span> <span class="c1"># sets up a queue in which to store bits status events</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statusValues</span><span class="o">=</span><span class="p">[]</span> <span class="c1"># full list of values recorded while logging the Bits# status</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status_nValues</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1">#number of status values recorded</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statusEvents</span><span class="o">=</span><span class="p">[]</span> <span class="c1"># list of meaningful events extracted from log</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status_nEvents</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1">#number of events recorded</span>

    <span class="c1">#==============================================#</span>
    <span class="c1"># Some overloads as Bits++ and Bits# appear to #</span>
    <span class="c1"># function slightly differently when it comes  #</span>
    <span class="c1"># to triggers                                  #</span>
    <span class="c1">#==============================================#</span>
    
<div class="viewcode-block" id="BitsSharp.stopTrigger">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.BitsSharp.stopTrigger">[docs]</a>
    <span class="k">def</span> <span class="nf">stopTrigger</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Stop sending triggers at the next win flip.</span>
<span class="sd">        </span>
<span class="sd">        Example::</span>

<span class="sd">            bits.setTrigger(0b0000000010, 2.0, 4.0, 0b0111111111)</span>
<span class="sd">            bits.startTrigger()</span>
<span class="sd">            while imageOn:</span>
<span class="sd">                #do some processing</span>
<span class="sd">                continue</span>
<span class="sd">            bits.stopTrigger()</span>
<span class="sd">            bits.win.flip()</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Simply stops sending TLock triggers as the next win flip.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="o">=</span><span class="kc">False</span></div>


<div class="viewcode-block" id="BitsSharp.stopGoggles">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.BitsSharp.stopGoggles">[docs]</a>
    <span class="k">def</span> <span class="nf">stopGoggles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Stop the stereo goggles from toggling </span>
<span class="sd">        </span>
<span class="sd">        Example::</span>

<span class="sd">            bits.startGoggles(0,1)</span>
<span class="sd">            bits.win.flip()</span>
<span class="sd">            while not response</span>
<span class="sd">                bits.win.flip()</span>
<span class="sd">                #do some processing</span>
<span class="sd">            bits.stopGoggles()</span>
<span class="sd">            bits.win.flip()</span>

<span class="sd">        Starts toggling the goggles with the right eye open in sync with the</span>
<span class="sd">        first win.flip(0) within the loop. The open eye will alternate.</span>

<span class="sd">        Note it is safer to leave the goggles toggling forever, ie to never call stopGoggles().</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Restore any protected triggers if required and stop sending.</span>
        <span class="c1"># TLock for goggles at next win flip.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_restoreTrigger</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gogglesGo</span> <span class="o">=</span> <span class="kc">False</span></div>


    <span class="c1">#===================================================#</span>
    <span class="c1"># Some empty methods that we can use to replace     #</span>
    <span class="c1"># serial methods if noComms                         #</span>
    <span class="c1">#===================================================#</span>
    
    <span class="k">def</span> <span class="nf">_nullSendMessage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">autoLog</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_nullGetResponse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="c1">#================================#</span>
    <span class="c1"># Basic functionality            #</span>
    <span class="c1">#================================#</span>

    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;If the user discards this object then close the serial port</span>
<span class="sd">        so it is released.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">com</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>

<div class="viewcode-block" id="BitsSharp.isAwake">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.BitsSharp.isAwake">[docs]</a>
    <span class="k">def</span> <span class="nf">isAwake</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test whether we have an active connection on the virtual serial</span>
<span class="sd">        port</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getInfo</span><span class="p">()</span>
        <span class="c1"># if we got a productType then this is a bits device</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;ProductType&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span></div>


<div class="viewcode-block" id="BitsSharp.getInfo">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.BitsSharp.getInfo">[docs]</a>
    <span class="k">def</span> <span class="nf">getInfo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Returns a python dictionary of info about the Bits Sharp box</span>
<span class="sd">        </span>
<span class="sd">            Example::</span>
<span class="sd">                info=bits.getInfo</span>
<span class="sd">                print(info[&#39;ProductType&#39;])</span>
<span class="sd">            </span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">noComms</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;ProductType&#39;</span><span class="p">:</span> <span class="s1">&#39;Bits#&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;SerialNumber&#39;</span><span class="p">:</span> <span class="s1">&#39;n/a&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;FirmwareDate&#39;</span><span class="p">:</span> <span class="s1">&#39;n/a&#39;</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;$Stop</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>  <span class="c1"># clear input buffer</span>
        
        
        <span class="n">info</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># get product (&#39;Bits_Sharp&#39;?)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;$ProductType</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="s1">&#39;ProductType&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;#ProductType;&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="s1">&#39;ProductType&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;ProductType&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;;</span><span class="se">\n\r</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="c1"># get serial number</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;$SerialNumber</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="s1">&#39;SerialNumber&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;#SerialNumber;&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="s1">&#39;SerialNumber&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;SerialNumber&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00\n\r</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="c1"># get firmware date</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;$FirmwareDate</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="s1">&#39;FirmwareDate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;#FirmwareDate;&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="s1">&#39;FirmwareDate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;FirmwareDate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;;</span><span class="se">\n\r</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">info</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get/set the mode of the BitsSharp to one of:</span>
<span class="sd">            &quot;bits++&quot;</span>
<span class="sd">            &quot;mono++&quot; </span>
<span class="sd">            &quot;color++&quot; </span>
<span class="sd">            &quot;status&quot;</span>
<span class="sd">            &quot;storage&quot;</span>
<span class="sd">            &quot;auto&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span>

    <span class="nd">@mode</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">mode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">requiresFBO</span> <span class="o">=</span> <span class="s1">&#39;mode requires a PsychoPy Window with useFBO=True&#39;</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="p">(</span><span class="s1">&#39;mode&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span> <span class="ow">and</span> <span class="n">value</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">:</span>
            <span class="k">return</span>  <span class="c1"># nothing to do here. Move along please</span>
        <span class="k">elif</span> <span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;status&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;$statusScreen</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;status&#39;</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="s1">&#39;storage&#39;</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;$USB_massStorage</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;massStorage&#39;</span>
        <span class="k">elif</span> <span class="n">value</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;bits&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;$BitsPlusPlus</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;bits++&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setLUT</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">value</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;mono&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">win</span><span class="o">.</span><span class="n">useFBO</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Mono++ &quot;</span> <span class="o">+</span> <span class="n">requiresFBO</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;$monoPlusPlus</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;mono++&#39;</span>
        <span class="k">elif</span> <span class="n">value</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;colo&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">win</span><span class="o">.</span><span class="n">useFBO</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Color++ &quot;</span> <span class="o">+</span> <span class="n">requiresFBO</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;$colorPlusPlus</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;color++&#39;</span>
        <span class="k">elif</span> <span class="n">value</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;auto&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">win</span><span class="o">.</span><span class="n">useFBO</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Auto++ &quot;</span> <span class="o">+</span> <span class="n">requiresFBO</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;$autoPlusPlus</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;auto++&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Bits# doesn&#39;t know how to use mode &quot;</span>
                   <span class="s2">&quot;</span><span class="si">%r</span><span class="s2">. Should be &#39;mono++&#39;, &#39;color++&#39; etc&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="n">msg</span> <span class="o">%</span> <span class="n">value</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Switched </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1"> mode&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;ProductType&#39;</span><span class="p">],</span>
                                                 <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]))</span>

<div class="viewcode-block" id="BitsSharp.setLUT">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.BitsSharp.setLUT">[docs]</a>
    <span class="k">def</span> <span class="nf">setLUT</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">newLUT</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">gammaCorrect</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">LUTrange</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
               <span class="n">contrast</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;SetLUT is only really needed for bits++ mode of bits# to set the</span>
<span class="sd">        look-up table (256 values with 14bits each).</span>
<span class="sd">        For the BitsPlusPlus device the default is to perform gamma</span>
<span class="sd">        correction here but on the BitsSharp it seems better to have the</span>
<span class="sd">        device perform that itself as the last step so gamma correction is</span>
<span class="sd">        off here by default.</span>
<span class="sd">        If no contrast has yet been set (it isn&#39;t needed for other modes)</span>
<span class="sd">        then it will be set to 1 here.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">contrast</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># we were given a new contrast value so use it:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">contrast</span> <span class="o">=</span> <span class="n">contrast</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;contrast&#39;</span><span class="p">):</span>
            <span class="c1"># we don&#39;t have one yet so create a default</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">contrast</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">BitsPlusPlus</span><span class="o">.</span><span class="n">setLUT</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">newLUT</span><span class="p">,</span> <span class="n">gammaCorrect</span><span class="p">,</span> <span class="n">LUTrange</span><span class="p">)</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">temporalDithering</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Temporal dithering can be set to True or False</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;temporalDithering&#39;</span><span class="p">]</span>

    <span class="nd">@temporalDithering</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">temporalDithering</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;$TemporalDithering=[ON]</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;$TemporalDithering=[OFF]</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;temporalDithering&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">gammaCorrectFile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get / set the gamma correction file to be used</span>
<span class="sd">        (as stored on the device)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;gammaCorrectFile&#39;</span><span class="p">]</span>

    <span class="nd">@gammaCorrectFile</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">gammaCorrectFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;$enableGammaCorrection=[</span><span class="si">%s</span><span class="s1">]</span><span class="se">\r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">value</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;gammaCorrectFile&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">monitorEDID</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get / set the EDID file for the monitor.</span>
<span class="sd">        The edid files will be located in the EDID subdirectory of the</span>
<span class="sd">        flash disk. The file `automatic.edid` will be the file read from</span>
<span class="sd">        the connected monitor.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;monitorEDID&#39;</span><span class="p">]</span>

    <span class="nd">@monitorEDID</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">monitorEDID</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;$setMonitorType=[</span><span class="si">%s</span><span class="s1">]</span><span class="se">\r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">value</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;monitorEDID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

<div class="viewcode-block" id="BitsSharp.beep">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.BitsSharp.beep">[docs]</a>
    <span class="k">def</span> <span class="nf">beep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span> <span class="n">dur</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Make a beep of a given frequency and duration</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;$Beep=[</span><span class="si">%i</span><span class="s1">, </span><span class="si">%.4f</span><span class="s1">]</span><span class="se">\r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">dur</span><span class="p">))</span></div>


<div class="viewcode-block" id="BitsSharp.getVideoLine">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.BitsSharp.getVideoLine">[docs]</a>
    <span class="k">def</span> <span class="nf">getVideoLine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lineN</span><span class="p">,</span> <span class="n">nPixels</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">nAttempts</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the r,g,b values for a number of pixels on a particular</span>
<span class="sd">        video line</span>

<span class="sd">        :param lineN: the line number you want to read</span>
<span class="sd">        :param nPixels: the number of pixels you want to read</span>
<span class="sd">        :param nAttempts: the first time you call this function it has</span>
<span class="sd">            to get to status mode. In this case it sometimes takes a few</span>
<span class="sd">            attempts to make the call work</span>

<span class="sd">        :return: an Nx3 numpy array of uint8 values</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># define sub-function oneAttempt</span>
        <span class="k">def</span> <span class="nf">oneAttempt</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">com</span><span class="o">.</span><span class="n">flushInput</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;$GetVideoLine=[</span><span class="si">%i</span><span class="s1">, </span><span class="si">%i</span><span class="s1">]</span><span class="se">\r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">lineN</span><span class="p">,</span> <span class="n">nPixels</span><span class="p">))</span>
            <span class="c1"># the box implicitly ends up in status mode</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;status&#39;</span>
            <span class="c1"># prepare to read</span>
            <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">raw</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">nPixels</span> <span class="o">*</span> <span class="mi">3</span><span class="p">):</span>
                <span class="n">raw</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
                <span class="n">vals</span> <span class="o">=</span> <span class="n">raw</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span> <span class="o">&gt;</span> <span class="n">timeout</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;getVideoLine() timed out: only found </span><span class="si">%i</span><span class="s2"> pixels&quot;</span>
                           <span class="s2">&quot; in </span><span class="si">%.2f</span><span class="s2"> s&quot;</span><span class="p">)</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vals</span><span class="p">),</span> <span class="n">timeout</span><span class="p">))</span>
                    <span class="k">return</span> <span class="p">[]</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>

        <span class="c1"># call oneAttempt a few times</span>
        <span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nAttempts</span><span class="p">):</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="n">oneAttempt</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vals</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">vals</span>
        <span class="k">return</span> <span class="kc">None</span></div>

        
    <span class="c1">#==============================================================#</span>
    <span class="c1"># Bits# and Display++ comms functions                          #</span>
    <span class="c1">#==============================================================#</span>

<div class="viewcode-block" id="BitsSharp.read">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.BitsSharp.read">[docs]</a>
    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the current waiting characters from the serial port</span>
<span class="sd">        if there are any.</span>
<span class="sd">        </span>
<span class="sd">        Mostly used internally but may be needed by user. Note the</span>
<span class="sd">        return message depends on what state the device is in and will</span>
<span class="sd">        need to be decoded. See the Bits# manual but also the other functions</span>
<span class="sd">        herein that do the decoding for you.</span>
<span class="sd">        </span>
<span class="sd">        Example:</span>
<span class="sd">            message = bits.read()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">noComms</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">com</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span>
        <span class="n">nChars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inWaiting</span><span class="p">()</span>
        <span class="n">raw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">com</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">nChars</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">raw</span><span class="p">:</span>
            <span class="c1"># don&#39;t bother if we found nothing on input</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Got BitsSharp reply: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">raw</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">raw</span></div>

        
<div class="viewcode-block" id="BitsSharp.flush">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.BitsSharp.flush">[docs]</a>
    <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Flushes the serial input buffer</span>
<span class="sd">        Its good to do this before and after data collection,</span>
<span class="sd">        And generally quite often.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inWaiting</span><span class="p">()</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">msg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mf">0.001</span><span class="p">)</span></div>


    <span class="c1">#=============================================================#</span>
    <span class="c1"># Helper functions for comms                                  #</span>
    <span class="c1">#=============================================================#</span>

    <span class="k">def</span> <span class="nf">_inWaiting</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Helper function to determine how many bytes are waiting on</span>
<span class="sd">        the serial port.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">noComms</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">com</span><span class="o">.</span><span class="n">inWaiting</span><span class="p">()</span>
    
    <span class="c1">#=============================================================#</span>
    <span class="c1"># overload of _afterFBOrender for Bits# and Display++         #</span>
    <span class="c1">#=============================================================#</span>
    
    <span class="k">def</span> <span class="nf">_afterFBOrender</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">GL</span><span class="o">.</span><span class="n">glDisable</span><span class="p">(</span><span class="n">GL</span><span class="o">.</span><span class="n">GL_BLEND</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;bits&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_drawLUTtoScreen</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gogglesGo</span><span class="p">:</span> <span class="c1"># Will also send triggers if requested</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_Goggles</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">analog</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_drawTrigtoScreen</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">clockReset</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ResetClock</span><span class="p">()</span>
        <span class="n">GL</span><span class="o">.</span><span class="n">glEnable</span><span class="p">(</span><span class="n">GL</span><span class="o">.</span><span class="n">GL_BLEND</span><span class="p">)</span>


    <span class="c1">#====================================================#</span>
    <span class="c1"># Analog functions send voltages via the DAC outputs #</span>
    <span class="c1"># But we also need to overload the setTrigger        #</span>
    <span class="c1"># functions to protect the analog settings.          #</span>
    <span class="c1">#====================================================#</span>
    
<div class="viewcode-block" id="BitsSharp.setTrigger">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.BitsSharp.setTrigger">[docs]</a>
    <span class="k">def</span> <span class="nf">setTrigger</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">triggers</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">onTime</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                     <span class="n">mask</span><span class="o">=</span><span class="mh">0xFFFF</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Quick way to set up triggers.</span>
<span class="sd">            </span>
<span class="sd">            Triggers is a binary word that determines which </span>
<span class="sd">            triggers will be turned on.</span>
<span class="sd">            </span>
<span class="sd">            onTime specifies the start time of the trigger within</span>
<span class="sd">            the frame (in S with 100uS resolution)</span>
<span class="sd">            </span>
<span class="sd">            Duration specifies how long the trigger will last.</span>
<span class="sd">            (in S with 100uS resolution).</span>
<span class="sd">            </span>
<span class="sd">            Note that mask only protects the digital output lines</span>
<span class="sd">            set by other activities in the Bits. Not other triggers.</span>
<span class="sd">            </span>
<span class="sd">            Example:</span>

<span class="sd">            ```</span>
<span class="sd">            bits.setTrigger(0b0000000010, 2.0, 4.0, 0b0111111111)</span>
<span class="sd">            bits.startTrigger()</span>
<span class="sd">            ```</span>

<span class="sd">            Will issue a 4ms long high-going pulse, 2ms after the start </span>
<span class="sd">            of each frame on DOUT1 while protecting the value of DOUT 9.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c1"># Protect the analog output settings. </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_protectAnalog</span><span class="p">()</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">BitsSharp</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setTrigger</span><span class="p">(</span><span class="n">triggers</span><span class="p">,</span> 
                                            <span class="n">onTime</span><span class="p">,</span> 
                                            <span class="n">duration</span><span class="p">,</span> 
                                            <span class="n">mask</span><span class="p">)</span>
        
        <span class="c1"># Restore the analog output settings.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_restoreAnalog</span></div>

        
<div class="viewcode-block" id="BitsSharp.setTriggerList">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.BitsSharp.setTriggerList">[docs]</a>
    <span class="k">def</span> <span class="nf">setTriggerList</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">triggerList</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="mh">0xFFFF</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Overaload of Bits# and Display++ </span>
<span class="sd">            Sets up Trigger pulses via the list method </span>
<span class="sd">            while preserving the analog output settings.</span>
<span class="sd">        </span>
<span class="sd">            Sets up Trigger pulses in Bist++ using the fine grained</span>
<span class="sd">            method that can control every trigger line at 100uS</span>
<span class="sd">            intervals.</span>
<span class="sd">           </span>
<span class="sd">            TriggerList should contain 1 entry for every 100uS </span>
<span class="sd">            packet (see getPackets) the binary word in each entry </span>
<span class="sd">            specifies which trigger line will be active during that</span>
<span class="sd">            time slot.</span>
<span class="sd">        </span>
<span class="sd">            Note that mask only protects the digital output lines</span>
<span class="sd">            set by other activities in the Bits. Not other triggers.</span>
<span class="sd">            </span>
<span class="sd">            Example:</span>
<span class="sd">                packet = [0]*self._NumberPackets</span>
<span class="sd">                packet[0] = 0b0000000010</span>
<span class="sd">                bits.setTriggerList(packet)</span>
<span class="sd">            </span>
<span class="sd">            Will sens a 100us pulse on DOUT1 at the start of the frame.</span>
<span class="sd">            </span>
<span class="sd">             Example 2:</span>
<span class="sd">                packet = [0]*self._NumberPackets</span>
<span class="sd">                packet[10] = 0b0000000010</span>
<span class="sd">                packet[20] = 0b0000000001</span>
<span class="sd">                bits.setTriggerList(packet)</span>
<span class="sd">                bits.statrtTrigger()</span>
<span class="sd">            </span>
<span class="sd">            Will sens a 100us pulse on DOUT1 1000us after the start of the </span>
<span class="sd">            frame and a second 100us pusle on DOUT0 2000us after the start of</span>
<span class="sd">            the frame.</span>
<span class="sd">            </span>
<span class="sd">            Triggers will continue until stopTrigger is called.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c1"># Protect the analog output settings.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_protectAnalog</span><span class="p">()</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">BitsSharp</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setTriggerList</span><span class="p">(</span><span class="n">triggerList</span><span class="p">,</span> 
                                            <span class="n">mask</span><span class="p">)</span>
        
        <span class="c1"># Restore the analog output settings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_restoreAnalog</span></div>

    
<div class="viewcode-block" id="BitsSharp.setAnalog">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.BitsSharp.setAnalog">[docs]</a>
    <span class="k">def</span> <span class="nf">setAnalog</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">AOUT1</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">AOUT2</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sets up Analog outputs in Bits# </span>
<span class="sd">        AOUT1 and AOUT2 are the two analog values required in volts.</span>
<span class="sd">        Analog commands are issued at the next win.flip() and</span>
<span class="sd">        actioned 1 video frame later.</span>
<span class="sd">        </span>
<span class="sd">        Example:</span>
<span class="sd">            bits.set Analog(4.5,-2.2)</span>
<span class="sd">            bits.startAnalog()</span>
<span class="sd">            bits.win.flip()</span>
<span class="sd">            </span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Convert AOUT1 from volts to device units.</span>
        <span class="n">AOUT1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mf">32767.0</span><span class="o">*</span><span class="n">AOUT1</span><span class="o">/</span><span class="mf">5.0</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">AOUT1</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">AOUT1</span> <span class="o">=</span> <span class="mi">65535</span> <span class="o">+</span> <span class="n">AOUT1</span>
        <span class="c1"># Add analog values to the Tlock payloads</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandTrig</span><span class="p">[</span><span class="mi">11</span><span class="p">,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">AOUT1</span> <span class="o">/</span> <span class="mi">256</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandTrig</span><span class="p">[</span><span class="mi">11</span><span class="p">,:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">remainder</span><span class="p">(</span><span class="n">AOUT1</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandGogLeftOpen</span><span class="p">[</span><span class="mi">11</span><span class="p">,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">AOUT1</span> <span class="o">/</span> <span class="mi">256</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandGogLeftOpen</span><span class="p">[</span><span class="mi">11</span><span class="p">,:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">remainder</span><span class="p">(</span><span class="n">AOUT1</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandGogRightOpen</span><span class="p">[</span><span class="mi">11</span><span class="p">,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">AOUT1</span> <span class="o">/</span> <span class="mi">256</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandGogRightOpen</span><span class="p">[</span><span class="mi">11</span><span class="p">,:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">remainder</span><span class="p">(</span><span class="n">AOUT1</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandGogBothOpen</span><span class="p">[</span><span class="mi">11</span><span class="p">,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">AOUT1</span> <span class="o">/</span> <span class="mi">256</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandGogBothOpen</span><span class="p">[</span><span class="mi">11</span><span class="p">,:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">remainder</span><span class="p">(</span><span class="n">AOUT1</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandGogBothClosed</span><span class="p">[</span><span class="mi">11</span><span class="p">,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">AOUT1</span> <span class="o">/</span> <span class="mi">256</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandGogBothClosed</span><span class="p">[</span><span class="mi">11</span><span class="p">,:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">remainder</span><span class="p">(</span><span class="n">AOUT1</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span>
        
        <span class="c1"># Convert AOUT2 from volts to device units.</span>
        <span class="n">AOUT2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mf">32767.0</span><span class="o">*</span><span class="n">AOUT2</span> <span class="o">/</span> <span class="mf">5.0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">AOUT2</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">AOUT2</span> <span class="o">=</span> <span class="mi">65535</span> <span class="o">+</span> <span class="n">AOUT2</span>
        <span class="c1"># Add analog values to the Tlock payloads</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandTrig</span><span class="p">[</span><span class="mi">13</span><span class="p">,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">AOUT2</span> <span class="o">/</span> <span class="mi">256</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandTrig</span><span class="p">[</span><span class="mi">13</span><span class="p">,:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">remainder</span><span class="p">(</span><span class="n">AOUT2</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandGogLeftOpen</span><span class="p">[</span><span class="mi">13</span><span class="p">,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">AOUT2</span> <span class="o">/</span> <span class="mi">256</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandGogLeftOpen</span><span class="p">[</span><span class="mi">13</span><span class="p">,:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">remainder</span><span class="p">(</span><span class="n">AOUT2</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandGogRightOpen</span><span class="p">[</span><span class="mi">13</span><span class="p">,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">AOUT2</span> <span class="o">/</span> <span class="mi">256</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandGogRightOpen</span><span class="p">[</span><span class="mi">13</span><span class="p">,:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">remainder</span><span class="p">(</span><span class="n">AOUT2</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandGogBothOpen</span><span class="p">[</span><span class="mi">13</span><span class="p">,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">AOUT2</span> <span class="o">/</span> <span class="mi">256</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandGogBothOpen</span><span class="p">[</span><span class="mi">13</span><span class="p">,:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">remainder</span><span class="p">(</span><span class="n">AOUT2</span><span class="p">,</span><span class="mi">256</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandGogBothClosed</span><span class="p">[</span><span class="mi">13</span><span class="p">,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">AOUT2</span> <span class="o">/</span> <span class="mi">256</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandGogBothClosed</span><span class="p">[</span><span class="mi">13</span><span class="p">,:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">remainder</span><span class="p">(</span><span class="n">AOUT2</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span>

        <span class="c1"># Convert the trigger only payload to a string.</span>
        <span class="c1"># goggle payloads are dealt with later.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandTrigStr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandTrig</span><span class="o">.</span><span class="n">tostring</span><span class="p">()</span></div>

        
<div class="viewcode-block" id="BitsSharp.sendAnalog">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.BitsSharp.sendAnalog">[docs]</a>
    <span class="k">def</span> <span class="nf">sendAnalog</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">AOUT1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">AOUT2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;sends a single analog output pulse uses up 1 win flip.</span>
<span class="sd">        pulse will continue until next win flip called.</span>
<span class="sd">        Actions are always 1 frame behind the request.</span>
<span class="sd">        </span>
<span class="sd">        May conflict with trigger and goggle settings.</span>
<span class="sd">        </span>
<span class="sd">        Example:</span>
<span class="sd">            bits.sendAnalog(4.5,-2.0)</span>
<span class="sd">            bits.win.flip()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">:</span>    <span class="c1"># If digital triggers are not on.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_protectTrigger</span><span class="p">()</span> <span class="c1"># Protect any trigger settings.</span>
            <span class="c1"># and set up a blank trigger</span>
        <span class="c1"># Goggle setting always preserved.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setAnalog</span><span class="p">(</span><span class="n">AOUT1</span> <span class="o">=</span> <span class="n">AOUT1</span><span class="p">,</span> <span class="n">AOUT2</span> <span class="o">=</span> <span class="n">AOUT2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">analog</span><span class="o">=</span><span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">win</span><span class="o">.</span><span class="n">flip</span><span class="p">()</span> <span class="c1"># Send the pulse but not acted on until the next frame. </span>
                         <span class="c1"># If next winflip is late the trigger will be repeated until</span>
                         <span class="c1"># it is cleared by the next winflip</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">analog</span><span class="o">=</span><span class="kc">False</span> <span class="c1"># Cancel and future analogf outs.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_restoreTrigger</span><span class="p">()</span> <span class="c1"># Restore the old digital triggers.</span></div>


<div class="viewcode-block" id="BitsSharp.startAnalog">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.BitsSharp.startAnalog">[docs]</a>
    <span class="k">def</span> <span class="nf">startAnalog</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;will start sending analog signals on the</span>
<span class="sd">        next win flip and continue until stopped.</span>
<span class="sd">        </span>
<span class="sd">        Example:</span>
<span class="sd">            bits.set Analog(4.5,-2.2)</span>
<span class="sd">            bits.startAnalog()</span>
<span class="sd">            bits.win.flip()</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">:</span> <span class="c1"># If digital triggers are not on.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_protectTrigger</span><span class="p">()</span> <span class="c1"># Protect any trigger settings.</span>
            <span class="c1"># and set up a blank trigger</span>
        <span class="c1"># Goggle setting always preserved.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">analog</span><span class="o">=</span><span class="kc">True</span></div>

        
<div class="viewcode-block" id="BitsSharp.stopAnalog">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.BitsSharp.stopAnalog">[docs]</a>
    <span class="k">def</span> <span class="nf">stopAnalog</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;will stop sending analogs signals at the next win flip.</span>

<span class="sd">        Example::</span>

<span class="sd">            bits.set Analog(4.5,-2.2)</span>
<span class="sd">            bits.startAnalog()</span>
<span class="sd">            bits.win.flip()</span>
<span class="sd">            while not response:</span>
<span class="sd">                #do some processing.</span>
<span class="sd">                bits.win.flip()</span>
<span class="sd">            bits.stopAnalog()</span>
<span class="sd">            bits.win.flip()</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Restore any protected triggers if required and stop sending.</span>
        <span class="c1"># TLock for analog at next win flip.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_restoreTrigger</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">analog</span><span class="o">=</span><span class="kc">False</span></div>

        
    <span class="c1">#============================================================#</span>
    <span class="c1"># Helper functions for protecting the analog settings from   #</span>
    <span class="c1"># bits++ trigger functions                                   #</span>
    <span class="c1">#============================================================#</span>
    
    <span class="k">def</span> <span class="nf">_protectAnalog</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keepA1MS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandTrig</span><span class="p">[</span><span class="mi">11</span><span class="p">,:,</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keepA1LS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandTrig</span><span class="p">[</span><span class="mi">11</span><span class="p">,:,</span><span class="mi">2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keepA2MS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandTrig</span><span class="p">[</span><span class="mi">13</span><span class="p">,:,</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keepA2LS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandTrig</span><span class="p">[</span><span class="mi">13</span><span class="p">,:,</span><span class="mi">2</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">_restoreAnalog</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandGogLeftOpen</span><span class="p">[</span><span class="mi">11</span><span class="p">,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keepA1MS</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandGogLeftOpen</span><span class="p">[</span><span class="mi">11</span><span class="p">,:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keepA1LS</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandGogLeftOpen</span><span class="p">[</span><span class="mi">13</span><span class="p">,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keepA2MS</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandGogLeftOpen</span><span class="p">[</span><span class="mi">13</span><span class="p">,:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keepA2LS</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandGogRightOpen</span><span class="p">[</span><span class="mi">11</span><span class="p">,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keepA1MS</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandGogRightOpen</span><span class="p">[</span><span class="mi">11</span><span class="p">,:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keepA1LS</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandGogRightOpen</span><span class="p">[</span><span class="mi">13</span><span class="p">,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keepA2MS</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandGogRightOpen</span><span class="p">[</span><span class="mi">13</span><span class="p">,:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keepA2LS</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandGogBothOpen</span><span class="p">[</span><span class="mi">11</span><span class="p">,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keepA1MS</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandGogBothOpen</span><span class="p">[</span><span class="mi">11</span><span class="p">,:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keepA1LS</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandGogBothOpen</span><span class="p">[</span><span class="mi">13</span><span class="p">,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keepA2MS</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandGogBothOpen</span><span class="p">[</span><span class="mi">13</span><span class="p">,:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keepA2LS</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandGogBothClosed</span><span class="p">[</span><span class="mi">11</span><span class="p">,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keepA1MS</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandGogBothClosed</span><span class="p">[</span><span class="mi">11</span><span class="p">,:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keepA1LS</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandGogBothClosed</span><span class="p">[</span><span class="mi">13</span><span class="p">,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keepA2MS</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandGogBothClosed</span><span class="p">[</span><span class="mi">13</span><span class="p">,:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keepA2LS</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandTrig</span><span class="p">[</span><span class="mi">11</span><span class="p">,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keepA1MS</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandTrig</span><span class="p">[</span><span class="mi">11</span><span class="p">,:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keepA1LS</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandTrig</span><span class="p">[</span><span class="mi">13</span><span class="p">,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keepA2MS</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandTrig</span><span class="p">[</span><span class="mi">13</span><span class="p">,:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keepA2LS</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandTrigStr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_HEADandTrig</span><span class="o">.</span><span class="n">tostring</span><span class="p">()</span>

    <span class="c1">#============================================================#</span>
    <span class="c1">#    RTBox. Bits# and Display++ can mimic a RT Box physical  #</span>
    <span class="c1">#    Reaction time response box                              #</span>
    <span class="c1">#    see https://lobes.osu.edu/rt-box.php                    #</span>
    <span class="c1">#    These RTBox functions use the RTBox comms format to     #</span>
    <span class="c1">#    read button press and trigger events                    #</span>
    <span class="c1">#============================================================#</span>

<div class="viewcode-block" id="BitsSharp.RTBoxClear">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.BitsSharp.RTBoxClear">[docs]</a>
    <span class="k">def</span> <span class="nf">RTBoxClear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Flushes the serial input buffer.</span>
<span class="sd">        Its good to do this before and after data collection.</span>
<span class="sd">        This just calls flush() so is a wrapper for RTBox.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span></div>


<div class="viewcode-block" id="BitsSharp.setRTBoxMode">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.BitsSharp.setRTBoxMode">[docs]</a>
    <span class="k">def</span> <span class="nf">setRTBoxMode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;CB6&#39;</span><span class="p">,</span><span class="s1">&#39;Down&#39;</span><span class="p">,</span><span class="s1">&#39;Trigger&#39;</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Sets the RTBox mode data member - does not</span>
<span class="sd">        actually set the RTBox into this mode.</span>
<span class="sd">        </span>
<span class="sd">        Example:</span>
<span class="sd">            bits.setRTBoxMode([&#39;CB6&#39;,&#39;Down&#39;]) # set the mode</span>
<span class="sd">            bits.RTBoxEnable() # Enable RTBox emulation with</span>
<span class="sd">            # the preset mode.</span>
<span class="sd">        </span>
<span class="sd">        sets the RTBox mode settings for a CRS CB6 button box.</span>
<span class="sd">        and for detection of &#39;Down&#39; events only.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">RTBoxMode</span> <span class="o">=</span> <span class="n">mode</span></div>



<div class="viewcode-block" id="BitsSharp.RTBoxEnable">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.BitsSharp.RTBoxEnable">[docs]</a>
    <span class="k">def</span> <span class="nf">RTBoxEnable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">map</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Sets up the RTBox with preset or bespoke mappings </span>
<span class="sd">        and enables event detection.</span>
<span class="sd">        </span>
<span class="sd">        RTBox events can be mapped to a number of physical events on Bits#</span>
<span class="sd">        They can be mapped to digital input lines, tigers and</span>
<span class="sd">        CB6 IR input channels.</span>
<span class="sd">        </span>
<span class="sd">        Mode is a list of strings.</span>
<span class="sd">        Preset mappings  provided via mode:</span>

<span class="sd">        * `CB6` for the CRS CB6 IR response box.</span>
<span class="sd">        * `IO` for a three button box connected to Din0-2</span>
<span class="sd">        * `IO6` for a six button box connected to Din0-5</span>
<span class="sd">            </span>
<span class="sd">        If mode = None or is not set then the value of self.RTBoxMode is used.</span>

<span class="sd">        Bespoke Mappings over write preset ones.</span>
<span class="sd">        </span>
<span class="sd">        The format for map is a list of tuples with each tuple </span>
<span class="sd">        containing the name of the </span>
<span class="sd">        RT Box button to be mapped and its source </span>
<span class="sd">        eg (&#39;btn1&#39;,&#39;Din0&#39;) maps physical input Din0 to </span>
<span class="sd">        logical button btn1. </span>
<span class="sd">        </span>
<span class="sd">        Note the lowest number button event is Btn1</span>
<span class="sd">        </span>
<span class="sd">        RTBox has four logical buttons (btn1-4) and </span>
<span class="sd">        three auxiliary events (light, pulse and trigger)</span>
<span class="sd">        Buttons/events can be mapped to multiple physical</span>
<span class="sd">        inputs and stay mapped until reset.</span>
<span class="sd">        </span>
<span class="sd">        Mode is a list of string or list of strings that contains </span>
<span class="sd">        keywords to determine present mappings and modes for RTBox.</span>
<span class="sd">        </span>
<span class="sd">        * If mode includes &#39;Down&#39; button events will be detected when pressed.</span>
<span class="sd">        * If mode includes &#39;Up&#39; button events will be detected when released.</span>

<span class="sd">        You can detect both types of event but note that pulse, light and trigger events</span>
<span class="sd">        don&#39;t have an &#39;Up&#39; mode.</span>
<span class="sd">        </span>
<span class="sd">        If Trigger is included in mode the trigger event will be mapped to the trigIn connector.</span>

<span class="sd">        Example:</span>
<span class="sd">        .. code-block:: python</span>

<span class="sd">            bits.RTBoxEnable(mode = [&#39;Down&#39;]), map = [(&#39;btn1&#39;,&#39;Din0&#39;), (&#39;btn2&#39;,&#39;Din1&#39;)]</span>
<span class="sd">            </span>
<span class="sd">        enables the RTBox emulation to detect Down events on buttons 1 and 2 where they are</span>
<span class="sd">        mapped to DIN0 and DIN1.</span>

<span class="sd">        Example:</span>
<span class="sd">        .. code-block:: python</span>

<span class="sd">            bits.RTBoxEnable(mode = [&#39;Down&#39;,&#39;CB6&#39;])</span>
<span class="sd">        </span>
<span class="sd">        enables the RTBox emulation to detect Down events on the standard CB6 IR response box keys.</span>
<span class="sd">        </span>
<span class="sd">        If no key direction has been set (mode does not contain &#39;Up&#39; or &#39;Down&#39;) the default is &#39;Down&#39;.</span>

<span class="sd">        Note that the firmware in Bits# units varies over time and some </span>
<span class="sd">        features of this class may not work for all firmware versions. </span>
<span class="sd">        Also Bits# units can be configured in various ways via their </span>
<span class="sd">        config.xml file so this class makes certain assumptions about the</span>
<span class="sd">        configuration. Such variations may affect key mappings for RTBox</span>
<span class="sd">        commands.</span>
<span class="sd">        </span>
<span class="sd">        The ability to reset keys mappings has been found not to work</span>
<span class="sd">        on some Bits# firmware.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">noComms</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">statusEnabled</span><span class="p">:</span>
            <span class="n">warning</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Cannot use RTBox status logging &quot;</span>
                       <span class="s2">&quot; is on&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="n">warning</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">statusBoxEnabled</span><span class="p">:</span>
            <span class="n">warning</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Cannot use RTBox when statusBox is on &quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="n">warning</span><span class="p">)</span>

        <span class="c1"># If mode is not None then use the supplied Mode otherwise use the preset mode.</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">RTBoxMode</span> <span class="o">=</span> <span class="n">mode</span>
        <span class="c1"># If self.RTBoxMode has still not be set to something set it to the default: &#39;down&#39;,&#39;CB6&#39;,&#39;trigger&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">RTBoxMode</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setRTBoxMode</span>
        <span class="c1"># If &#39;Up&#39; is not in mode adds a &#39;Down&#39; just in case no direction has been set at all.</span>
        <span class="k">if</span> <span class="p">((</span><span class="s1">&#39;Up&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">RTBoxMode</span><span class="p">)</span>  
                <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;up&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">RTBoxMode</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">RTBoxMode</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Down&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">RTBoxResetKeys</span><span class="p">()</span> <span class="c1"># reset all the button - input mappings.</span>
        <span class="c1"># If map is not None the mapping provided will over ride any presets given</span>
        <span class="c1"># by mode, otherwise use the present mappings below.</span>
        <span class="k">if</span> <span class="nb">map</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;CB6&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">RTBoxMode</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;$btn1 =[IRButtonA]</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;$btn2 =[IRButtonB]</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;$btn3 =[IRButtonC]</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;$btn4 =[IRButtonD]</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;$light =[IRButtonE]</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;$pulse =[IRButtonF]</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="c1"># will now add pulse and light to mode</span>
                <span class="c1"># as required to read more than 4 inputs.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">RTBoxMode</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Pulse&#39;</span><span class="p">)</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">RTBoxMode</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Light&#39;</span><span class="p">)</span>
            <span class="c1"># For a 3 or 6 button box wired to the DINs</span>
            <span class="k">if</span> <span class="s1">&#39;IO&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">RTBoxMode</span><span class="p">:</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;$btn1 =[Din0]</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;$btn2 =[Din1]</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;$btn3 =[Din2]</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="c1"># Add 3 more buttons wired to the DINs</span>
            <span class="k">if</span> <span class="s1">&#39;IO6&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">RTBoxMode</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;$btn4 =[Din3]</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;$light =[Din4]</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;$pulse =[Din5]</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="c1"># will now add pulse and light to mode.</span>
                <span class="c1"># as required to read more than 4 inputs.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">RTBoxMode</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Pulse&#39;</span><span class="p">)</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">RTBoxMode</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Light&#39;</span><span class="p">)</span>
            <span class="c1"># Add the TrigIn input as a possible event.</span>
            <span class="k">if</span> <span class="p">((</span><span class="s1">&#39;Trigger&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">RTBoxMode</span><span class="p">)</span>
                 <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;trigger&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">RTBoxMode</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;$trigger =[TrigIn]</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">RTBoxSetKeys</span><span class="p">(</span><span class="nb">map</span><span class="p">)</span> <span class="c1"># Set up a bespoke mapping</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="s1">&#39;X&#39;</span><span class="p">)</span> <span class="c1"># Advanced mode turns timestamping on</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="n">msg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="c1"># Assumes that BitsSharp and Display++ return BOX as part of</span>
        <span class="c1"># their ID in respect of RTBox style commands.</span>
        <span class="k">if</span> <span class="sa">b</span><span class="s1">&#39;BOX&#39;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">:</span> 
            <span class="n">smsg</span><span class="o">=</span><span class="n">msg</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">RTBoxTimeBase</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">smsg</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># Get the timebase for timestamps</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Put RTBox into advanced mode: box ID = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Cannot get RTBox into &quot;</span>
                             <span class="s2">&quot;advanced mode - this is needed for timestamping&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">((</span><span class="s1">&#39;Down&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">RTBoxMode</span><span class="p">)</span>
                 <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;down&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">RTBoxMode</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">msg</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;D&#39;</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Put RTBox into key down mode&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Cannot get RTBox into key down mode&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">((</span><span class="s1">&#39;Up&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">RTBoxMode</span><span class="p">)</span>
                 <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;up&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">RTBoxMode</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="s1">&#39;U&#39;</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">msg</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;U&#39;</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Put RTBox into key up mode&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Cannot get RTBox into key up mode&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">((</span><span class="s1">&#39;Trigger&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">RTBoxMode</span><span class="p">)</span>
                 <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;trigger&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">RTBoxMode</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="s1">&#39;F&#39;</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">msg</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;F&#39;</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Put RTBox into TR mode&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Cannot get RTBox into TR mode&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">((</span><span class="s1">&#39;Light&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">RTBoxMode</span><span class="p">)</span>
                 <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;light&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">RTBoxMode</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="s1">&#39;O&#39;</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">msg</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;O&#39;</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Put RTBox into Light mode&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Cannot get RTBox into Light mode&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">((</span><span class="s1">&#39;Pulse&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">RTBoxMode</span><span class="p">)</span>
                 <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;pulse&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">RTBoxMode</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="s1">&#39;P&#39;</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">msg</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;P&#39;</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Put RTBox into Pulse mode&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Cannot get RTBox into Pulse mode&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">RTBoxEnabled</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;RTBox emulation enabled&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">RTBoxClear</span><span class="p">()</span></div>


<div class="viewcode-block" id="BitsSharp.RTBoxDisable">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.BitsSharp.RTBoxDisable">[docs]</a>
    <span class="k">def</span> <span class="nf">RTBoxDisable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Disables the detection of RTBox events.</span>
<span class="sd">        This is useful to stop the Bits# from reporting key presses</span>
<span class="sd">        When you no longer need them. Nad must be done before using any</span>
<span class="sd">        other data logging methods.</span>
<span class="sd">        </span>
<span class="sd">        It undoes any button - input mappings.</span>
<span class="sd">        </span>
<span class="sd">        Note that the firmware in Bits# units varies over time and some </span>
<span class="sd">        features of this class may not work for all firmware versions. </span>
<span class="sd">        Also Bits# units can be configured in various ways via their </span>
<span class="sd">        config.xml file so this class makes certain assumptions about the</span>
<span class="sd">        configuration. Such variations may affect key mappings for RTBox</span>
<span class="sd">        commands.</span>
<span class="sd">        </span>
<span class="sd">        The ability to reset keys mappings has been found not to work</span>
<span class="sd">        on some Bits# firmware.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">noComms</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">RTBoxEnabled</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">((</span><span class="s1">&#39;Down&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">RTBoxMode</span><span class="p">)</span>
                 <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;down&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">RTBoxMode</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">msg</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;d&#39;</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Take RTBox out of key down mode&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Cannot take RTBox out of key down mode&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">((</span><span class="s1">&#39;Up&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">RTBoxMode</span><span class="p">)</span>
                 <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;up&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">RTBoxMode</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="s1">&#39;u&#39;</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">msg</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;u&#39;</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Take RTBox out of key up mode&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Cannot take RTBox out of key up mode&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">((</span><span class="s1">&#39;Trigger&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">RTBoxMode</span><span class="p">)</span>
                 <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;trigger&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">RTBoxMode</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="s1">&#39;f&#39;</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">msg</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;f&#39;</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Take RTBox out of TR mode&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Cannot take RTBox out of TR mode&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">((</span><span class="s1">&#39;Light&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">RTBoxMode</span><span class="p">)</span>
                 <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;light&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">RTBoxMode</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">msg</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;o&#39;</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Take RTBox out of Light mode&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Cannot take RTBox out of Light mode&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">((</span><span class="s1">&#39;Pulse&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">RTBoxMode</span><span class="p">)</span>
                 <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;pulse&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">RTBoxMode</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">msg</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;p&#39;</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Take RTBox out of Pulse mode&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Cannot take RTBox out of Pulse mode&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">RTBoxClear</span><span class="p">()</span>
        <span class="c1">#Reset the button mappings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">RTBoxResetKeys</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">RTBoxClear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">RTBoxEnabled</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;RTBox emulation disabled&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="BitsSharp.RTBoxResetKeys">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.BitsSharp.RTBoxResetKeys">[docs]</a>
    <span class="k">def</span> <span class="nf">RTBoxResetKeys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Resets the key mappings to no mapping.</span>
<span class="sd">        Has the effect of disabling RTBox input.</span>
<span class="sd">        </span>
<span class="sd">        Note that the firmware in Bits# units varies over time and some </span>
<span class="sd">        features of this class may not work for all firmware versions. </span>
<span class="sd">        Also Bits# units can be configured in various ways via their </span>
<span class="sd">        config.xml file so this class makes certain assumptions about the</span>
<span class="sd">        configuration. Such variations may affect key mappings for RTBox</span>
<span class="sd">        commands.</span>
<span class="sd">        </span>
<span class="sd">        The ability to reset keys mappings has been found not to work</span>
<span class="sd">        on some Bits# firmware.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">noComms</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;$btn1 =[null]</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;$btn2 =[null]</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;$btn3 =[null]</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;$btn4 =[null]</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;$light =[null]</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;$pulse =[null]</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;$trigger =[null]</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;All RTBOX buttons disconnected&quot;</span><span class="p">)</span></div>

        
<div class="viewcode-block" id="BitsSharp.RTBoxSetKeys">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.BitsSharp.RTBoxSetKeys">[docs]</a>
    <span class="k">def</span> <span class="nf">RTBoxSetKeys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="nb">map</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Set key mappings: first resets existing then adds new ones.</span>
<span class="sd">        Does not reset any event that is not in the new list.</span>
<span class="sd">        RTBox events can be mapped to a number of physical events on Bits#</span>
<span class="sd">        They can be mapped to digital input lines, triggers and CB6 IR input channels.</span>
<span class="sd">        The format for map is a list of tuples with each tuple containing the name of the </span>
<span class="sd">        RTBox button to be mapped and its source eg (&#39;btn1&#39;,&#39;Din1&#39;) maps physical input Din1 to </span>
<span class="sd">        logical button btn1.</span>
<span class="sd">        </span>
<span class="sd">        RTBox has four logical buttons (btn1-4) and three auxiliary events (light, pulse and trigger)</span>
<span class="sd">        Buttons/events can be mapped to multiple physical inputs and stay mapped until reset.</span>
<span class="sd">        </span>
<span class="sd">        Example:</span>
<span class="sd">            bits.RTBoxSetKeys([(&#39;btn1&#39;,&#39;Din0),(&#39;light&#39;,&#39;Din9&#39;)])</span>
<span class="sd">            </span>
<span class="sd">        Will link Din0 to button 1 and Din9 to the the light input emulation.</span>
<span class="sd">        </span>
<span class="sd">        Note that the firmware in Bits# units varies over time and some </span>
<span class="sd">        features of this class may not work for all firmware versions. </span>
<span class="sd">        Also Bits# units can be configured in various ways via their </span>
<span class="sd">        config.xml file so this class makes certain assumptions about the</span>
<span class="sd">        configuration. Such variations may affect key mappings for RTBox</span>
<span class="sd">        commands.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">noComms</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">mapping</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">:</span>
            <span class="c1"># reset the mapping.</span>
            <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;$&#39;</span><span class="o">+</span><span class="n">mapping</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;=[null]</span><span class="se">\r</span><span class="s1">&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
            <span class="c1"># Construct and send new mapping string</span>
            <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;$&#39;</span><span class="o">+</span><span class="n">mapping</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;=[&#39;</span><span class="o">+</span><span class="n">mapping</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;]</span><span class="se">\r</span><span class="s1">&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span></div>

            
<div class="viewcode-block" id="BitsSharp.RTBoxAddKeys">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.BitsSharp.RTBoxAddKeys">[docs]</a>
    <span class="k">def</span> <span class="nf">RTBoxAddKeys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="nb">map</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Add key mappings to an existing map.</span>
<span class="sd">        RTBox events can be mapped to a number of physical events on Bits#</span>
<span class="sd">        They can be mapped to digital input lines, triggers and CB6 IR input channels.</span>
<span class="sd">        The format for map is a list of tuples with each tuple containing the name of the </span>
<span class="sd">        RTBox button to be mapped and its source eg (&#39;btn1&#39;,&#39;Din1&#39;) maps physical input Din1 to </span>
<span class="sd">        logical button btn1.</span>
<span class="sd">        RTBox has four logical buttons (btn1-4) and three auxiliary events (light, pulse and trigger)</span>
<span class="sd">        Buttons/events can be mapped to multiple physical inputs and stay mapped until reset.</span>
<span class="sd">        </span>
<span class="sd">        </span>
<span class="sd">        Example::</span>

<span class="sd">            bits.RTBoxSetKeys([(&#39;btn1&#39;,&#39;Din0),(&#39;btn2&#39;,&#39;Din1&#39;)])</span>
<span class="sd">            bits.RTBoxAddKeys([(&#39;btn1&#39;,&#39;IRButtonA&#39;),((&#39;btn2&#39;,&#39;IRButtonB&#39;)])</span>
<span class="sd">            </span>
<span class="sd">        Will link Din0 to button 1 and Din1 to button 2.</span>
<span class="sd">        Then adds IRButtonA and IRButtonB alongside the original mappings.</span>
<span class="sd">        </span>
<span class="sd">        Now both hard wired and IR inputs will - emulating the same logical button press.</span>

<span class="sd">        Note that the firmware in Bits# units varies over time and some </span>
<span class="sd">        features of this class may not work for all firmware versions. </span>
<span class="sd">        Also Bits# units can be configured in various ways via their </span>
<span class="sd">        config.xml file so this class makes certain assumptions about the</span>
<span class="sd">        configuration. Such variations may affect key mappings for RTBox</span>
<span class="sd">        commands.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">noComms</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">mapping</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">:</span>
            <span class="c1"># Construct and send new mapping string</span>
            <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;$&#39;</span><span class="o">+</span><span class="n">mapping</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;=[&#39;</span><span class="o">+</span><span class="n">mapping</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;]</span><span class="se">\r</span><span class="s1">&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span></div>


<div class="viewcode-block" id="BitsSharp.RTBoxCalibrate">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.BitsSharp.RTBoxCalibrate">[docs]</a>
    <span class="k">def</span> <span class="nf">RTBoxCalibrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">N</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Used to assess error between host clock and Bits# </span>
<span class="sd">        button press time stamps.</span>
<span class="sd">        </span>
<span class="sd">        Prints each sample provided and returns the mean error.</span>
<span class="sd">        </span>
<span class="sd">        The clock willnever be completely in sync but the aim is that there</span>
<span class="sd">        should be that the difference between them should not grow over</span>
<span class="sd">        a serise of button presses.</span>
<span class="sd">        </span>
<span class="sd">        Note that the firmware in Bits# units varies over time and some </span>
<span class="sd">        features of this class may not work for all firmware versions. </span>
<span class="sd">        Also Bits# units can be configured in various ways via their </span>
<span class="sd">        config.xml file so this class makes certain assumptions about the</span>
<span class="sd">        configuration. Such variations may affect key mappings for RTBox</span>
<span class="sd">        commands.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Calibrating Bits Button box: Press button </span><span class="si">%d</span><span class="s2"> times&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">N</span><span class="p">))</span>
        <span class="n">drift</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
        <span class="n">HostClock</span><span class="o">=</span><span class="n">core</span><span class="o">.</span><span class="n">Clock</span><span class="p">()</span>
        <span class="c1"># Sync the 2 clocks as best they can be by resetting them both.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">syncClocks</span><span class="p">(</span><span class="n">HostClock</span><span class="p">)</span>
        <span class="c1"># Measure the difference between the stime stamps provided by N</span>
        <span class="c1"># Button presses and the host clock equivalents.</span>
        <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RTBoxWait</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">msg</span><span class="p">:</span>
                <span class="n">tH</span> <span class="o">=</span> <span class="n">HostClock</span><span class="o">.</span><span class="n">getTime</span><span class="p">()</span>
                <span class="n">tB</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">time</span>
                <span class="n">drift</span> <span class="o">=</span> <span class="n">drift</span><span class="o">+</span><span class="n">tH</span><span class="o">-</span><span class="n">tB</span>
                <span class="nb">print</span> <span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="n">tB</span><span class="p">,</span> <span class="n">tH</span><span class="p">,</span> <span class="n">tH</span><span class="o">-</span><span class="n">tB</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">drift</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">drift</span><span class="o">/</span><span class="n">N</span></div>



<div class="viewcode-block" id="BitsSharp.getRTBoxResponses">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.BitsSharp.getRTBoxResponses">[docs]</a>
    <span class="k">def</span> <span class="nf">getRTBoxResponses</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; checks for (at least) an appropriate number of </span>
<span class="sd">        RTBox style key presses on the input buffer then reads them.</span>
<span class="sd">        Returns a list of dict like objects with three members </span>
<span class="sd">        &#39;button&#39;, &#39;dir&#39; and &#39;time&#39;</span>
<span class="sd">        </span>
<span class="sd">        &#39;button&#39; is a number from 1 to 9 to indicate the event that </span>
<span class="sd">        was detected.</span>
<span class="sd">        1-4 are the &#39;btn1-btn4&#39; events, 5 and 6 are the </span>
<span class="sd">        &#39;light&#39; and &#39;pulse&#39; events,</span>
<span class="sd">        7 is the &#39;trigger&#39; event, </span>
<span class="sd">        9 is a requested timestamp event (see Clock()).</span>
<span class="sd">        </span>
<span class="sd">        &#39;dir&#39; is the direction of the event eg &#39;up&#39; or &#39;down&#39;, </span>
<span class="sd">        trigger is described as &#39;on&#39; when low.</span>
<span class="sd">        </span>
<span class="sd">        &#39;dir&#39; is set to &#39;time&#39; if a requested </span>
<span class="sd">        timestamp event has been detected.</span>
<span class="sd">        </span>
<span class="sd">        &#39;time&#39; is the timestamp associated with the event.</span>
<span class="sd">        </span>
<span class="sd">        Values can be read as a list of structures eg::</span>

<span class="sd">            res = getRTBoxResponses(3)</span>
<span class="sd">            res[0].dir, res[0].button, res[0].time</span>

<span class="sd">        or dictionaries::</span>

<span class="sd">            res[0][&#39;dir&#39;], res[0][&#39;button&#39;], res[0][&#39;time&#39;]</span>
<span class="sd">            </span>
<span class="sd">        Note even if only 1 key press was requested </span>
<span class="sd">        a list of dict / objects is returned.</span>
<span class="sd">        </span>
<span class="sd">        Note that the firmware in Bits# units varies over time and some </span>
<span class="sd">        features of this class may not work for all firmware versions. </span>
<span class="sd">        Also Bits# units can be configured in various ways via their </span>
<span class="sd">        config.xml file so this class makes certain assumptions about the</span>
<span class="sd">        configuration. Such variations may affect key mappings for RTBox</span>
<span class="sd">        commands.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">noComms</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span>  <span class="bp">self</span><span class="o">.</span><span class="n">_inWaiting</span><span class="p">()</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">N</span><span class="o">*</span><span class="mi">7</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_RTBoxDecodeResponse</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span><span class="n">N</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span></div>


<div class="viewcode-block" id="BitsSharp.getRTBoxResponse">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.BitsSharp.getRTBoxResponse">[docs]</a>
    <span class="k">def</span> <span class="nf">getRTBoxResponse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; checks for one RTBox style key presses on the input </span>
<span class="sd">        buffer then reads it.</span>
<span class="sd">        Returns a dict like object with three members </span>
<span class="sd">        &#39;button&#39;, &#39;dir&#39; and &#39;time&#39;</span>
<span class="sd">        </span>
<span class="sd">        &#39;button&#39; is a number from 1 to 9 to indicate the event that </span>
<span class="sd">        was detected.</span>
<span class="sd">        1-4 are the &#39;btn1-btn4&#39; events, 5 and 6 are the </span>
<span class="sd">        &#39;light&#39; and &#39;pulse&#39; events,</span>
<span class="sd">        7 is the &#39;trigger&#39; event, </span>
<span class="sd">        9 is a requested timestamp event (see Clock()).</span>
<span class="sd">        </span>
<span class="sd">        &#39;dir&#39; is the direction of the event eg &#39;up&#39; or &#39;down&#39;, </span>
<span class="sd">        trigger is described as &#39;on&#39; when low.</span>
<span class="sd">        </span>
<span class="sd">        &#39;dir&#39; is set to &#39;time&#39; if a requested </span>
<span class="sd">        timestamp event has been detected.</span>
<span class="sd">        </span>
<span class="sd">        &#39;time&#39; is the timestamp associated with the event.</span>
<span class="sd">        </span>
<span class="sd">        Value can be read as a structure, eg:</span>
<span class="sd">            res= getRTBoxResponse()</span>
<span class="sd">            res.dir, res.button, res.time</span>
<span class="sd">        or dictionary</span>
<span class="sd">            res[&#39;dir&#39;], res[&#39;button&#39;], res[&#39;time&#39;]</span>
<span class="sd">            </span>
<span class="sd">        Note that the firmware in Bits# units varies over time and some </span>
<span class="sd">        features of this class may not work for all firmware versions. </span>
<span class="sd">        Also Bits# units can be configured in various ways via their </span>
<span class="sd">        config.xml file so this class makes certain assumptions about the</span>
<span class="sd">        configuration. Such variations may affect key mappings for RTBox</span>
<span class="sd">        commands.</span>
<span class="sd">        &quot;&quot;&quot;</span>    

        <span class="bp">self</span><span class="o">.</span><span class="n">getRTBoxResponses</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nRTPresses</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">op</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">RTButtons</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">op</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> </div>


<div class="viewcode-block" id="BitsSharp.getAllRTBoxResponses">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.BitsSharp.getAllRTBoxResponses">[docs]</a>
    <span class="k">def</span> <span class="nf">getAllRTBoxResponses</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Read all of the RTBox style key presses on the </span>
<span class="sd">        input buffer.</span>
<span class="sd">        Returns a list of dict like objects with three members </span>
<span class="sd">        &#39;button&#39;, &#39;dir&#39; and &#39;time&#39;</span>
<span class="sd">        </span>
<span class="sd">        &#39;button&#39; is a number from 1 to 9 to indicate the event that </span>
<span class="sd">        was detected.</span>
<span class="sd">        1-4 are the &#39;btn1-btn4&#39; events, 5 and 6 are the </span>
<span class="sd">        &#39;light&#39; and &#39;pulse&#39; events,</span>
<span class="sd">        7 is the &#39;trigger&#39; event, </span>
<span class="sd">        9 is a requested timestamp event (see Clock()).</span>
<span class="sd">        </span>
<span class="sd">        &#39;dir&#39; is the direction of the event eg &#39;up&#39; or &#39;down&#39;, </span>
<span class="sd">        trigger is described as &#39;on&#39; when low.</span>
<span class="sd">        </span>
<span class="sd">        &#39;dir&#39; is set to &#39;time&#39; if a requested </span>
<span class="sd">        timestamp event has been detected.</span>
<span class="sd">        </span>
<span class="sd">        &#39;time&#39; is the timestamp associated with the event.</span>
<span class="sd">        </span>
<span class="sd">        Values can be read as a structure eg::</span>

<span class="sd">            res = getAllRTBoxResponses()</span>
<span class="sd">            res[0].dir, res[0].button, res[0].time</span>

<span class="sd">        or dictionary::</span>

<span class="sd">            res[0][&#39;dir&#39;], res[0][&#39;button&#39;], res[0][&#39;time&#39;]</span>
<span class="sd">            </span>
<span class="sd">        Note even if only 1 key press was found </span>
<span class="sd">        a list of dict / objects is returned</span>
<span class="sd">        </span>
<span class="sd">        Note that the firmware in Bits# units varies over time and some </span>
<span class="sd">        features of this class may not work for all firmware versions. </span>
<span class="sd">        Also Bits# units can be configured in various ways via their </span>
<span class="sd">        config.xml file so this class makes certain assumptions about the</span>
<span class="sd">        configuration. Such variations may affect key mappings for RTBox</span>
<span class="sd">        commands.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">N</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_inWaiting</span><span class="p">()</span><span class="o">/</span><span class="mi">7</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getRTBoxResponses</span><span class="p">(</span><span class="n">N</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="BitsSharp.RTBoxKeysPressed">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.BitsSharp.RTBoxKeysPressed">[docs]</a>
    <span class="k">def</span> <span class="nf">RTBoxKeysPressed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">N</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check to see if (at least) the appropriate number </span>
<span class="sd">        of RTBox style key presses have been made.</span>
<span class="sd">        </span>
<span class="sd">        Example:</span>
<span class="sd">            bits.RTBoxKeysPressed(5)</span>
<span class="sd">            </span>
<span class="sd">        will return false until 5 button presses have been recorded.</span>
<span class="sd">        </span>
<span class="sd">        Note that the firmware in Bits# units varies over time and some </span>
<span class="sd">        features of this class may not work for all firmware versions. </span>
<span class="sd">        Also Bits# units can be configured in various ways via their </span>
<span class="sd">        config.xml file so this class makes certain assumptions about the</span>
<span class="sd">        configuration. Such variations may affect key mappings for RTBox</span>
<span class="sd">        commands.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#7 is number of bytes for one press</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inWaiting</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="o">*</span><span class="n">N</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span> 
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span></div>

    
<div class="viewcode-block" id="BitsSharp.RTBoxWaitN">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.BitsSharp.RTBoxWaitN">[docs]</a>
    <span class="k">def</span> <span class="nf">RTBoxWaitN</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Waits until (at least) the appropriate number </span>
<span class="sd">        of RTBox style key presses have been made </span>
<span class="sd">        Pauses program execution in mean time.</span>
<span class="sd">        </span>
<span class="sd">        Example:</span>
<span class="sd">            res = bits.RTBoxWaitN(5) </span>
<span class="sd">            </span>
<span class="sd">        will suspend all other activity until 5 button presses have been</span>
<span class="sd">        recorded and will then return a list of Dicts containing the 5 results.</span>
<span class="sd">        </span>
<span class="sd">        Results can be accessed as follows:</span>
<span class="sd">            </span>
<span class="sd">        structure</span>
<span class="sd">            res[0].dir, res[0].button, res[0].time</span>
<span class="sd">        or dictionary</span>
<span class="sd">            res[0][&#39;dir&#39;], res[0][&#39;button&#39;], res[0][&#39;time&#39;]</span>

<span class="sd">        Note that the firmware in Bits# units varies over time and some </span>
<span class="sd">        features of this class may not work for all firmware versions. </span>
<span class="sd">        Also Bits# units can be configured in various ways via their </span>
<span class="sd">        config.xml file so this class makes certain assumptions about the</span>
<span class="sd">        configuration. Such variations may affect key mappings for RTBox</span>
<span class="sd">        commands.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">noComms</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inWaiting</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="o">*</span><span class="n">N</span><span class="p">:</span>
            <span class="k">continue</span> <span class="c1"># ie loop</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getRTBoxResponses</span><span class="p">(</span><span class="n">N</span><span class="p">)</span></div>


<div class="viewcode-block" id="BitsSharp.RTBoxWait">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.BitsSharp.RTBoxWait">[docs]</a>
    <span class="k">def</span> <span class="nf">RTBoxWait</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Waits until (at least) one </span>
<span class="sd">        of RTBox style key presses have been made </span>
<span class="sd">        Pauses program execution in mean time.</span>
<span class="sd">        </span>
<span class="sd">        Example:</span>
<span class="sd">            res = bits.RTBoxWait() </span>
<span class="sd">            </span>
<span class="sd">        will suspend all other activity until 1 button press has been</span>
<span class="sd">        recorded and will then return a dict / structure containing results.</span>
<span class="sd">        </span>
<span class="sd">        Results can be accessed as follows:</span>
<span class="sd">            </span>
<span class="sd">        structure</span>
<span class="sd">            res.dir, res.button, res.time</span>
<span class="sd">        or dictionary</span>
<span class="sd">            res[&#39;dir&#39;], res[&#39;button&#39;], res[&#39;time&#39;]</span>
<span class="sd">            </span>
<span class="sd">        Note that the firmware in Bits# units varies over time and some </span>
<span class="sd">        features of this class may not work for all firmware versions. </span>
<span class="sd">        Also Bits# units can be configured in various ways via their </span>
<span class="sd">        config.xml file so this class makes certain assumptions about the</span>
<span class="sd">        configuration. Such variations may affect key mappings for RTBox</span>
<span class="sd">        commands.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">noComms</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inWaiting</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">:</span>
            <span class="k">continue</span> <span class="c1"># ie loop</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getRTBoxResponse</span><span class="p">()</span></div>


<div class="viewcode-block" id="BitsSharp.clock">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.BitsSharp.clock">[docs]</a>
    <span class="k">def</span> <span class="nf">clock</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Reads the internal clock of the Bits box via the RTBox</span>
<span class="sd">        fortmat but note there will be a delay in reading the value </span>
<span class="sd">        back. The fortmat for the return values is the same as for</span>
<span class="sd">        button box presses. The return value for button will be 9 and</span>
<span class="sd">        the return value for event will be time. The return value for</span>
<span class="sd">        time will be the time of the clock at the moment of the request.</span>
<span class="sd">        </span>
<span class="sd">        Example:</span>
<span class="sd">            res = bits.clock()</span>
<span class="sd">            print(res.time)</span>
<span class="sd">            print(res[&#39;time&#39;])</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">RTBoxClear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="s1">&#39;Y&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">RTBoxWait</span><span class="p">()</span></div>


    <span class="c1"># Helper function for RTBox commands #</span>
    <span class="k">def</span> <span class="nf">_RTBoxDecodeResponse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">msg</span><span class="p">,</span><span class="n">N</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Helper function for decoding key presses in the </span>
<span class="sd">        RT response box format.</span>
<span class="sd">        </span>
<span class="sd">        Not normally needed by user</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">RTButtons</span> <span class="o">=</span> <span class="p">[</span><span class="n">button</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nRTPresses</span> <span class="o">=</span> <span class="n">N</span>
        <span class="n">EV</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">N</span><span class="p">):</span>
            <span class="n">t</span><span class="o">=</span><span class="mi">0</span>
            <span class="c1"># The RTBox serial input format is quite primitive</span>
            <span class="c1"># This is a hack to make work in different versions of Python </span>
            <span class="c1"># There may be a better way!</span>
            <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span> 
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">index</span><span class="o">*</span><span class="mi">7</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span><span class="n">index</span><span class="o">*</span><span class="mi">7</span> <span class="o">+</span> <span class="mi">7</span><span class="p">):</span>
                    <span class="c1"># i is ofset by index*7 so this is subtracted from 7 in line</span>
                    <span class="c1"># below and then reinstated by adding index*7 back in.</span>
                    <span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="o">+</span><span class="nb">ord</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="o">*</span> <span class="mi">256</span><span class="o">**</span><span class="p">(</span><span class="mi">7</span><span class="o">-</span><span class="n">i</span> <span class="o">+</span> <span class="n">index</span><span class="o">*</span><span class="mi">7</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">t</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">RTBoxTimeBase</span> 
                <span class="k">if</span> <span class="nb">chr</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="s1">&#39;Y&#39;</span><span class="p">:</span>
                    <span class="n">event</span> <span class="o">=</span> <span class="mi">9</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">event</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="n">index</span><span class="o">*</span><span class="mi">7</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;Bits# RTBox Only tested for PY3&quot;</span><span class="p">)</span>
            <span class="n">Direction</span> <span class="o">=</span> <span class="s1">&#39;None&#39;</span>
            <span class="n">EV</span><span class="o">=</span><span class="mi">99</span>
            <span class="c1"># Decode event bytes into a button number and a direction.</span>
            <span class="c1"># Calls to read the clock are a special case.</span>
            <span class="k">if</span> <span class="n">event</span> <span class="o">==</span> <span class="mi">9</span><span class="p">:</span>
                <span class="n">Direction</span> <span class="o">=</span> <span class="s1">&#39;time&#39;</span>
                <span class="n">EV</span> <span class="o">=</span> <span class="mi">9</span>
            <span class="c1"># Odd numbered events 49 - 55 are the down events for the 4 btn inputs</span>
            <span class="c1"># Decoded to button = 1 -4 and direction = down.</span>
            <span class="k">if</span> <span class="n">event</span> <span class="o">==</span> <span class="mi">49</span><span class="p">:</span>
                <span class="n">Direction</span> <span class="o">=</span> <span class="s1">&#39;down&#39;</span>
                <span class="n">EV</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">event</span> <span class="o">==</span> <span class="mi">51</span><span class="p">:</span>
                <span class="n">Direction</span> <span class="o">=</span> <span class="s1">&#39;down&#39;</span>
                <span class="n">EV</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="k">if</span> <span class="n">event</span> <span class="o">==</span> <span class="mi">53</span><span class="p">:</span>
                <span class="n">Direction</span> <span class="o">=</span> <span class="s1">&#39;down&#39;</span>
                <span class="n">EV</span> <span class="o">=</span> <span class="mi">3</span>
            <span class="k">if</span> <span class="n">event</span> <span class="o">==</span> <span class="mi">55</span><span class="p">:</span>
                <span class="n">Direction</span> <span class="o">=</span> <span class="s1">&#39;down&#39;</span>
                <span class="n">EV</span> <span class="o">=</span> <span class="mi">4</span>
            <span class="c1"># Even numbered events 50 - 56 are the down events for the 4 btn inputs</span>
            <span class="c1"># Decoded to button = 1 -4 and direction = up.</span>
            <span class="k">if</span> <span class="n">event</span> <span class="o">==</span> <span class="mi">50</span><span class="p">:</span>
                <span class="n">Direction</span> <span class="o">=</span> <span class="s1">&#39;up&#39;</span>
                <span class="n">EV</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">event</span> <span class="o">==</span> <span class="mi">52</span> <span class="p">:</span>
                <span class="n">Direction</span> <span class="o">=</span> <span class="s1">&#39;up&#39;</span>
                <span class="n">EV</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="k">if</span> <span class="n">event</span> <span class="o">==</span> <span class="mi">54</span><span class="p">:</span>
                <span class="n">Direction</span> <span class="o">=</span> <span class="s1">&#39;up&#39;</span>
                <span class="n">EV</span><span class="o">=</span> <span class="mi">3</span>
            <span class="k">if</span> <span class="n">event</span> <span class="o">==</span> <span class="mi">56</span><span class="p">:</span>
                <span class="n">Direction</span> <span class="o">=</span> <span class="s1">&#39;up&#39;</span>
                <span class="n">EV</span> <span class="o">=</span> <span class="mi">4</span>
            <span class="c1"># Event 48 is the pulse event - down only</span>
            <span class="c1"># Decoded to button = 5, direction = down</span>
            <span class="k">if</span> <span class="n">event</span> <span class="o">==</span> <span class="mi">48</span><span class="p">:</span>
                <span class="n">Direction</span> <span class="o">=</span> <span class="s1">&#39;down&#39;</span>
                <span class="n">EV</span> <span class="o">=</span> <span class="mi">5</span>
            <span class="c1"># Event 57 is the light event - down only</span>
            <span class="c1"># Decoded to button = 6, direction = down</span>
            <span class="k">if</span> <span class="n">event</span> <span class="o">==</span> <span class="mi">57</span><span class="p">:</span>
                <span class="n">Direction</span> <span class="o">=</span> <span class="s1">&#39;down&#39;</span>
                <span class="n">EV</span><span class="o">=</span> <span class="mi">6</span>
            <span class="c1"># Event 97 is the Trigger event</span>
            <span class="c1"># Decoded to button = 7, direction = on</span>
            <span class="k">if</span> <span class="n">event</span> <span class="o">==</span> <span class="mi">97</span><span class="p">:</span>
                <span class="n">Direction</span> <span class="o">=</span> <span class="s1">&#39;on&#39;</span>
                <span class="n">EV</span> <span class="o">=</span> <span class="mi">7</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">RTButtons</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">dir</span> <span class="o">=</span> <span class="n">Direction</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">RTButtons</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">button</span> <span class="o">=</span> <span class="n">EV</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">RTButtons</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="n">t</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">RTButtons</span>

    <span class="c1">#====================================================================#</span>
    <span class="c1">#   &#39;statusBox&#39; functions use BitsSharp status reporting to          #</span>
    <span class="c1">#   emulate a button box.                                            #</span>
    <span class="c1">#====================================================================#</span>

<div class="viewcode-block" id="BitsSharp.setStatusBoxMode">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.BitsSharp.setStatusBoxMode">[docs]</a>
    <span class="k">def</span> <span class="nf">setStatusBoxMode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;CB6&#39;</span><span class="p">,</span><span class="s1">&#39;Down&#39;</span><span class="p">,</span><span class="s1">&#39;Trigger&#39;</span><span class="p">,</span><span class="s1">&#39;Analog&#39;</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Sets the statusBox mode data member - does not</span>
<span class="sd">        actually set the statusBox into this mode.</span>
<span class="sd">        </span>
<span class="sd">        Example:</span>
<span class="sd">            bits.setStatusBoxMode([&#39;CB6&#39;,&#39;Down&#39;]) # set the mode</span>
<span class="sd">            bits.statusBoxEnable() # Enable status Box emulation with</span>
<span class="sd">            # the preset mode.</span>
<span class="sd">        </span>
<span class="sd">        sets the statusBox mode settings for a CRS CB6 button box.</span>
<span class="sd">        and for detection of &#39;Down&#39; events only.</span>
<span class="sd">        </span>
<span class="sd">        Note that the firmware in Bits# units varies over time and some </span>
<span class="sd">        features of this class may not work for all firmware versions. </span>
<span class="sd">        Also Bits# units can be configured in various ways via their </span>
<span class="sd">        config.xml file so this class makes certain assumptions about the</span>
<span class="sd">        configuration. In particular it is assumed that all digital inputs,</span>
<span class="sd">        triggers and analog inputs are reported as part of status</span>
<span class="sd">        updates. If some of these report are disabled in your config.xml file </span>
<span class="sd">        then &#39;status&#39; and &#39;event&#39; commands in this class may not work.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statusBoxMode</span> <span class="o">=</span> <span class="n">mode</span></div>

        
<div class="viewcode-block" id="BitsSharp.setStatusBoxThreshold">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.BitsSharp.setStatusBoxThreshold">[docs]</a>
    <span class="k">def</span> <span class="nf">setStatusBoxThreshold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Sets the threshold by which analog inputs must change to trigger a button </span>
<span class="sd">        press event. If None the threshold will be set very high so that no such events are</span>
<span class="sd">        triggered.</span>
<span class="sd">        </span>
<span class="sd">        Can be used to change the threshold for analog events without having to re enable the</span>
<span class="sd">        status box system as a whole.</span>
<span class="sd">        </span>
<span class="sd">        Note that the firmware in Bits# units varies over time and some </span>
<span class="sd">        features of this class may not work for all firmware versions. </span>
<span class="sd">        Also Bits# units can be configured in various ways via their </span>
<span class="sd">        config.xml file so this class makes certain assumptions about the</span>
<span class="sd">        configuration. In particular it is assumed that all digital inputs,</span>
<span class="sd">        triggers and analog inputs are reported as part of status</span>
<span class="sd">        updates. If some of these report are disabled in your config.xml file </span>
<span class="sd">        then &#39;status&#39; and &#39;event&#39; commands in this class may not work.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">threshold</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">statusBoxThreshold</span> <span class="o">=</span> <span class="n">threshold</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">statusBoxThreshold</span> <span class="o">=</span> <span class="mf">9999.99</span>  <span class="c1"># set impossibly high to block events.</span></div>


<div class="viewcode-block" id="BitsSharp.statusBoxEnable">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.BitsSharp.statusBoxEnable">[docs]</a>
    <span class="k">def</span> <span class="nf">statusBoxEnable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">map</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Sets up the stautsBox with preset or bespoke mappings </span>
<span class="sd">        and enables event detection.</span>
<span class="sd">        </span>
<span class="sd">        stautsBox events can be mapped to a number of physical events on Bits#</span>
<span class="sd">        They can be mapped to digital input lines, tigers and</span>
<span class="sd">        CB6 IR input channels.</span>
<span class="sd">        </span>
<span class="sd">        mode is a list of strings.</span>
<span class="sd">        Preset mappings provided via mode:</span>

<span class="sd">            - CB6 for the CRS CB6 IR response box connected mapped to btn1-6</span>
<span class="sd">            - IO for a three button box connected to Din0-2 mapped to btn1-3</span>
<span class="sd">            - IO6 for a six button box connected to Din0-5 mapped to btn1-6</span>
<span class="sd">            - IO10 for a ten button box connected to Din0-9 mapped to btn1-10</span>
<span class="sd">            - Trigger maps the trigIn to btn17</span>
<span class="sd">            - Analog maps the 6 analog inputs on a Bits# to btn18-23</span>
<span class="sd">            </span>
<span class="sd">        If CB6 and IOx are used together the Dins are mapped from btn7 onwards.</span>
<span class="sd">            </span>
<span class="sd">        If mode = None or is not set then the value of self.statusBoxMode is used.</span>

<span class="sd">        Bespoke Mappings overwrite preset ones.</span>
<span class="sd">        </span>
<span class="sd">        The format for map is a list of tuples with each tuple </span>
<span class="sd">        containing the name of the </span>
<span class="sd">        button to be mapped and its source </span>
<span class="sd">        eg (&#39;btn1&#39;,&#39;Din0&#39;) maps physical input Din0 to </span>
<span class="sd">        logical button btn1. </span>
<span class="sd">        </span>
<span class="sd">        Note the lowest number button event is Btn1</span>
<span class="sd">        </span>
<span class="sd">        statusBox has 23 logical buttons (btn1-123).</span>
<span class="sd">        Buttons/events can be mapped to multiple physical</span>
<span class="sd">        inputs and stay mapped until reset.</span>
<span class="sd">        </span>
<span class="sd">        mode is a string or list of strings that contains </span>
<span class="sd">        keywords to determine present mappings and modes for statusBox.</span>
<span class="sd">        </span>
<span class="sd">        If mode includes &#39;Down&#39; button events will be </span>
<span class="sd">        detected when pressed.</span>
<span class="sd">        If mode includes &#39;Up&#39; button events will be </span>
<span class="sd">        detected when released.</span>
<span class="sd">        You can detect both types of event noting that the event detector</span>
<span class="sd">        will look for transitions and ignorewhat it sees as the starting state.</span>
<span class="sd">        </span>
<span class="sd">        To match with the CRS hardware description inputs are labelled as follows.</span>
<span class="sd">        </span>
<span class="sd">        TrigIn, Din0 ... Din9, IRButtonA ... IRButtonF, AnalogIn1 ... AnalogIn6</span>
<span class="sd">        </span>
<span class="sd">        Logical buttons are numbered from 1 to 23.</span>
<span class="sd">        </span>
<span class="sd">        threshold sets the threshold by which analog inputs must change to trigger a button </span>
<span class="sd">        press event. If None the threshold will be set very high so that no such events are</span>
<span class="sd">        triggered. Analog inputs must cycle up and down by threshold to be detected as separate</span>
<span class="sd">        events. So if only &#39;Up&#39; events are detected the input must go up by threshold, then come</span>
<span class="sd">        down again and then go back up to register 2 up events.</span>
<span class="sd">            </span>
<span class="sd">        Example::</span>

<span class="sd">            bits.statusBoxEnable(mode = &#39;Down&#39;), map = [(&#39;btn1&#39;,&#39;Din0&#39;), (&#39;btn2&#39;,&#39;Din1&#39;)]</span>
<span class="sd">            </span>
<span class="sd">        enables the stautsBox to detect Down events on buttons 1 and 2 where they are</span>
<span class="sd">        mapped to DIN0 and DIN1.</span>
<span class="sd">        </span>
<span class="sd">        Example::</span>

<span class="sd">            bits.statusBoxEnable(mode = [&#39;Down&#39;,&#39;CB6&#39;])</span>
<span class="sd">        </span>
<span class="sd">        enables the status Box emulation to detect Down events on the standard CB6 IR response box keys.</span>
<span class="sd">        </span>
<span class="sd">        </span>
<span class="sd">        Note that the firmware in Bits# units varies over time and some </span>
<span class="sd">        features of this class may not work for all firmware versions. </span>
<span class="sd">        Also Bits# units can be configured in various ways via their </span>
<span class="sd">        config.xml file so this class makes certain assumptions about the</span>
<span class="sd">        configuration. In particular it is assumed that all digital inputs,</span>
<span class="sd">        triggers and analog inputs are reported as part of status</span>
<span class="sd">        updates. If some of these report are disabled in your config.xml file </span>
<span class="sd">        then &#39;status&#39; and &#39;event&#39; commands in this class may not work.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">noComms</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">statusEnabled</span><span class="p">:</span>
            <span class="n">warning</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Cannot use statusBox when status logging &quot;</span>
                       <span class="s2">&quot; is on&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="n">warning</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">RTBoxEnabled</span><span class="p">:</span>
            <span class="n">warning</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Cannot use statusBox when RTBox is on &quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="n">warning</span><span class="p">)</span>
            
        <span class="c1"># If threshold is not None use the supplied value as the threshold for analog events.</span>
        <span class="k">if</span> <span class="n">threshold</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">statusBoxThreshold</span> <span class="o">=</span> <span class="n">threshold</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">statusBoxThreshold</span> <span class="o">=</span> <span class="mf">9999.99</span>  <span class="c1"># set impossibly high to block events.</span>

        <span class="c1"># If mode is not None then use the supplied Mode otherwise use the preset or default mode.</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">statusBoxMode</span> <span class="o">=</span> <span class="n">mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statusBoxResetKeys</span><span class="p">()</span> <span class="c1"># reset all the button - input mappings.</span>

        <span class="c1"># If map is not None the mapping provided will over ride any presets given</span>
        <span class="c1"># by mode, otherwise use the present mappings below.</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">statusButtonMap</span> <span class="o">=</span> <span class="p">[</span><span class="mi">99</span><span class="p">]</span><span class="o">*</span><span class="mi">23</span>
        
        <span class="k">if</span> <span class="nb">map</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">DinBaseButton</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="s1">&#39;CB6&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">statusBoxMode</span><span class="p">:</span>
                <span class="c1"># position in status line = logical button number</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">statusButtonMap</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">statusButtonMap</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">statusButtonMap</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">statusButtonMap</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">statusButtonMap</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">statusButtonMap</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="mi">6</span>
                <span class="n">DinBaseButton</span> <span class="o">=</span> <span class="mi">7</span>
            <span class="c1"># For a 3 button box wired to the DINs</span>
            <span class="k">if</span> <span class="s1">&#39;IO&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">statusBoxMode</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">statusButtonMap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="o">+</span><span class="n">DinBaseButton</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">statusButtonMap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="o">+</span><span class="n">DinBaseButton</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">statusButtonMap</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="o">+</span><span class="n">DinBaseButton</span>
            <span class="c1"># Add 3 more buttons wired to the DINs</span>
            <span class="k">if</span> <span class="s1">&#39;IO6&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">statusBoxMode</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">statusButtonMap</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="o">+</span><span class="n">DinBaseButton</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">statusButtonMap</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="o">+</span><span class="n">DinBaseButton</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">statusButtonMap</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span><span class="o">+</span><span class="n">DinBaseButton</span>
            <span class="c1"># Add all the Dins to the button list</span>
            <span class="k">if</span> <span class="s1">&#39;IO10&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">statusBoxMode</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">statusButtonMap</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mi">6</span><span class="o">+</span><span class="n">DinBaseButton</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">statusButtonMap</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">7</span><span class="o">+</span><span class="n">DinBaseButton</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">statusButtonMap</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span><span class="o">+</span><span class="n">DinBaseButton</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">statusButtonMap</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="mi">9</span><span class="o">+</span><span class="n">DinBaseButton</span>
            <span class="k">if</span> <span class="p">((</span><span class="s1">&#39;Trigger&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">statusBoxMode</span><span class="p">)</span>
                 <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;trigger&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">statusBoxMode</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">statusButtonMap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">17</span>
            <span class="k">if</span> <span class="p">((</span><span class="s1">&#39;Analog&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">statusBoxMode</span><span class="p">)</span>
                 <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;analog&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">statusBoxMode</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">statusButtonMap</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="o">=</span> <span class="mi">18</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">statusButtonMap</span><span class="p">[</span><span class="mi">18</span><span class="p">]</span> <span class="o">=</span> <span class="mi">19</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">statusButtonMap</span><span class="p">[</span><span class="mi">19</span><span class="p">]</span> <span class="o">=</span> <span class="mi">20</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">statusButtonMap</span><span class="p">[</span><span class="mi">20</span><span class="p">]</span> <span class="o">=</span> <span class="mi">21</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">statusButtonMap</span><span class="p">[</span><span class="mi">21</span><span class="p">]</span> <span class="o">=</span> <span class="mi">22</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">statusButtonMap</span><span class="p">[</span><span class="mi">22</span><span class="p">]</span> <span class="o">=</span> <span class="mi">23</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">statusBoxSetKeys</span><span class="p">(</span><span class="nb">map</span><span class="p">)</span> <span class="c1"># Set up a bespoke mapping</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statusBoxEnabled</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;statusBox emulation enabled&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        
        <span class="c1">#time = 60</span>
        
        <span class="c1"># Enable status reading </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statusThread</span><span class="o">=</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_statusBox</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statusBoxEnd</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_statusEnable</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statusThread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span></div>


<div class="viewcode-block" id="BitsSharp.statusBoxDisable">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.BitsSharp.statusBoxDisable">[docs]</a>
    <span class="k">def</span> <span class="nf">statusBoxDisable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Disables the detection of statusBox events.</span>
<span class="sd">        This is useful to stop the Bits# from reporting key presses</span>
<span class="sd">        When you no longer need them. And must be done before using any</span>
<span class="sd">        other data logging methods.</span>
<span class="sd">        </span>
<span class="sd">        It undoes any button - input mappings</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">noComms</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">statusBoxEnabled</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">return</span>
        
        <span class="c1"># disable code here</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statusBoxEnd</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># This semaphore will tell the status logging thread to stop.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statusThread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span> <span class="c1"># Join the thread and wait for it to finish.</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">statusThread</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statusBoxResetKeys</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statusBoxEnabled</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;statusBox emulation disabled&quot;</span><span class="p">)</span></div>

        
    <span class="k">def</span> <span class="nf">statusBoxResetKeys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statusButtons</span> <span class="o">=</span> <span class="p">[</span><span class="mi">99</span><span class="p">]</span><span class="o">*</span><span class="mi">23</span>
        
<div class="viewcode-block" id="BitsSharp.statusBoxSetKeys">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.BitsSharp.statusBoxSetKeys">[docs]</a>
    <span class="k">def</span> <span class="nf">statusBoxSetKeys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="nb">map</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Set key mappings: first resets existing then adds new ones.</span>
<span class="sd">        Does not reset any event that is not in the new list.</span>
<span class="sd">        statusBox events can be mapped to a number of physical events on Bits#</span>
<span class="sd">        They can be mapped to digital input lines, triggers and CB6 IR input channels.</span>
<span class="sd">        The format for map is a list of tuples with each tuple containing the name of the </span>
<span class="sd">        RTBox button to be mapped and its source eg (&#39;btn1&#39;,&#39;Din1&#39;) maps physical input Din1 to </span>
<span class="sd">        logical button btn1.</span>
<span class="sd">        </span>
<span class="sd">        statusBox has 17 logical buttons (btn1-17) </span>
<span class="sd">        Buttons/events can be mapped to multiple physical inputs and stay mapped until reset.</span>
<span class="sd">        </span>
<span class="sd">        Example:</span>
<span class="sd">            bits.RTBoxSetKeys([(&#39;btn1&#39;,&#39;Din0),(&#39;btn2&#39;,&#39;IRButtonA&#39;)])</span>
<span class="sd">            </span>
<span class="sd">        Will link physical Din0 to logical button 1 and IRButtonA to button 2.</span>
<span class="sd">        </span>
<span class="sd">        To match with the CRS hardware description inputs are labelled as follows.</span>
<span class="sd">        </span>
<span class="sd">        TrigIn, Din0 ... Din9, IRButtonA ... IRButtonF, AnalogIn1 ... AnalogIn6</span>
<span class="sd">        </span>
<span class="sd">        Logical buttons are numbered from 1 to 23.</span>
<span class="sd">        </span>
<span class="sd">        Note that the firmware in Bits# units varies over time and some </span>
<span class="sd">        features of this class may not work for all firmware versions. </span>
<span class="sd">        Also Bits# units can be configured in various ways via their </span>
<span class="sd">        config.xml file so this class makes certain assumptions about the</span>
<span class="sd">        configuration. In particular it is assumed that all digital inputs,</span>
<span class="sd">        triggers and analog inputs are reported as part of status</span>
<span class="sd">        updates. If some of these report are disabled in your config.xml file </span>
<span class="sd">        then &#39;status&#39; and &#39;event&#39; commands in this class may not work.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">statusBoxResetKeys</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statusBoxAddKeys</span><span class="p">(</span><span class="nb">map</span><span class="p">)</span></div>

    
        
<div class="viewcode-block" id="BitsSharp.statusBoxAddKeys">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.BitsSharp.statusBoxAddKeys">[docs]</a>
    <span class="k">def</span> <span class="nf">statusBoxAddKeys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="nb">map</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Add key mappings to an existing map.</span>
<span class="sd">        statusBox events can be mapped to a number of physical events on Bits#</span>
<span class="sd">        They can be mapped to digital input lines, triggers and CB6 IR input channels.</span>
<span class="sd">        The format for map is a list of tuples with each tuple containing the name of the </span>
<span class="sd">        RTBox button to be mapped and its source eg (&#39;btn1&#39;,&#39;Din1&#39;) maps physical input Din1 to </span>
<span class="sd">        logical button btn1.</span>
<span class="sd">        statusBox has 23 logical buttons (btn1-23).</span>
<span class="sd">        Unlike RTBox buttons/events can only be partially mapped to multiple physical inputs.</span>
<span class="sd">        That is a logical button can be mapped to more than 1 physical input but a physical input</span>
<span class="sd">        can onloy be mapped to 1 logical button.</span>
<span class="sd">        So, this function over write any existing mappings if the physical input is the</span>
<span class="sd">        same.</span>
<span class="sd">        </span>
<span class="sd">        </span>
<span class="sd">        Example::</span>
<span class="sd">        </span>
<span class="sd">            bits.RTBoxSetKeys([(&#39;btn1&#39;,&#39;Din0),(&#39;btn2&#39;,&#39;Din1&#39;)])</span>
<span class="sd">            bits.RTBoxAddKeys([(&#39;btn1&#39;,&#39;IRButtonA&#39;),((&#39;btn2&#39;,&#39;IRButtonB&#39;)])</span>
<span class="sd">            </span>
<span class="sd">        Will link Din0 to button 1 and Din1 to button 2.</span>
<span class="sd">        Then adds IRButtonA and IRButtonB alongside the original mappings.</span>
<span class="sd">        </span>
<span class="sd">        Now both hard wired and IR inputs will emulate the same logical button press.</span>
<span class="sd">        </span>
<span class="sd">        To match with the CRS hardware description inputs are labelled as follows.</span>
<span class="sd">        </span>
<span class="sd">        TrigIn, Din0 ... Din9, IRButtonA ... IRButtonF, AnalogIn1 ... AnalogIn6</span>
<span class="sd">        </span>
<span class="sd">        Logical buttons are numbered from 1 to 23.</span>
<span class="sd">        </span>
<span class="sd">        Note that the firmware in Bits# units varies over time and some </span>
<span class="sd">        features of this class may not work for all firmware versions. </span>
<span class="sd">        Also Bits# units can be configured in various ways via their </span>
<span class="sd">        config.xml file so this class makes certain assumptions about the</span>
<span class="sd">        configuration. In particular it is assumed that all digital inputs,</span>
<span class="sd">        triggers and analog inputs are reported as part of status</span>
<span class="sd">        updates. If some of these report are disabled in your config.xml file </span>
<span class="sd">        then &#39;status&#39; and &#39;event&#39; commands in this class may not work.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>        <span class="c1"># reset the mapping</span>
        <span class="k">for</span> <span class="n">mapping</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">:</span>
            <span class="n">btn</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mapping</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">mapping</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;I&#39;</span><span class="p">:</span>  <span class="c1"># IR input</span>
                <span class="c1"># A = 65 so ord(chr)-65+11 is the 11th status input etc</span>
                <span class="c1"># status inputs will be adjusted later to match true position.</span>
                <span class="n">sourse</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="n">mapping</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">-</span><span class="mi">65</span><span class="o">+</span><span class="mi">11</span>
            <span class="k">if</span> <span class="n">mapping</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;D&#39;</span><span class="p">:</span> <span class="c1"># Digital input</span>
                <span class="n">source</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mapping</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span>
            <span class="k">if</span> <span class="n">mapping</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;T&#39;</span><span class="p">:</span> <span class="c1"># Trigger input</span>
                <span class="n">source</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">mapping</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;A&#39;</span><span class="p">:</span> <span class="c1"># Analog input</span>
                <span class="n">source</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mapping</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="mi">16</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">statusButtonMap</span><span class="p">[</span><span class="n">sourse</span><span class="p">]</span> <span class="o">=</span> <span class="n">btn</span></div>


<div class="viewcode-block" id="BitsSharp.getStatusBoxResponses">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.BitsSharp.getStatusBoxResponses">[docs]</a>
    <span class="k">def</span> <span class="nf">getStatusBoxResponses</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; checks for (at least) an appropriate number of </span>
<span class="sd">        RTBox style key presses on the input buffer then reads them.</span>
<span class="sd">        Returns a list of dict like objects with three members </span>
<span class="sd">        &#39;button&#39;, &#39;dir&#39; and &#39;time&#39;</span>
<span class="sd">        </span>
<span class="sd">        &#39;button&#39; is a number from 1 to 9 to indicate the event that </span>
<span class="sd">        was detected.</span>
<span class="sd">        1-4 are the &#39;btn1-btn4&#39; events, 5 and 6 are the </span>
<span class="sd">        &#39;light&#39; and &#39;pulse&#39; events,</span>
<span class="sd">        7 is the &#39;trigger&#39; event, </span>
<span class="sd">        9 is a requested timestamp event (see Clock()).</span>
<span class="sd">        </span>
<span class="sd">        &#39;dir&#39; is the direction of the event eg &#39;up&#39; or &#39;down&#39;, </span>
<span class="sd">        trigger is described as &#39;on&#39; when low.</span>
<span class="sd">        </span>
<span class="sd">        &#39;dir&#39; is set to &#39;time&#39; if a requested </span>
<span class="sd">        timestamp event has been detected.</span>
<span class="sd">        </span>
<span class="sd">        &#39;time&#39; is the timestamp associated with the event.</span>
<span class="sd">        </span>
<span class="sd">        Values can be read as a list of structures eg::</span>

<span class="sd">            res = getRTBoxResponses(3)</span>
<span class="sd">            print(res[0].dir, res[0].button, res[0].time)</span>

<span class="sd">        or dictionaries::</span>

<span class="sd">            print(res[0][&#39;dir&#39;], res[0][&#39;button&#39;], res[0][&#39;time&#39;])</span>
<span class="sd">            </span>
<span class="sd">        Note even if only 1 key press was requested </span>
<span class="sd">        a list of dict / objects is returned.</span>
<span class="sd">        </span>
<span class="sd">        Note that the firmware in Bits# units varies over time and some </span>
<span class="sd">        features of this class may not work for all firmware versions. </span>
<span class="sd">        Also Bits# units can be configured in various ways via their </span>
<span class="sd">        config.xml file so this class makes certain assumptions about the</span>
<span class="sd">        configuration. In particular it is assumed that all digital inputs,</span>
<span class="sd">        triggers and analog inputs are reported as part of status</span>
<span class="sd">        updates. If some of these report are disabled in your config.xml file </span>
<span class="sd">        then &#39;status&#39; and &#39;event&#39; commands in this class may not work.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">noComms</span><span class="p">:</span> <span class="c1"># If we have no commes there will nothing to read</span>
            <span class="k">return</span>
        <span class="k">if</span>  <span class="bp">self</span><span class="o">.</span><span class="n">statusQ</span><span class="o">.</span><span class="n">qsize</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">N</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="p">[</span><span class="n">button</span><span class="p">()</span> <span class="k">for</span>  <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)]</span> 
            <span class="c1"># get the required number of button presses off the queue</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
                <span class="n">res</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">statusQ</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="c1"># empty the queue of everything else</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">statusQ</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
                <span class="n">dummy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">statusQ</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nStatusPresses</span> <span class="o">=</span> <span class="n">N</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">statusButtons</span> <span class="o">=</span> <span class="n">res</span>
            <span class="k">return</span> <span class="n">res</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span></div>


<div class="viewcode-block" id="BitsSharp.getStatusBoxResponse">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.BitsSharp.getStatusBoxResponse">[docs]</a>
    <span class="k">def</span> <span class="nf">getStatusBoxResponse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; checks for one statusBox style key presses on the input </span>
<span class="sd">        buffer then reads it.</span>
<span class="sd">        Returns a dict like object with three members </span>
<span class="sd">        &#39;button&#39;, &#39;dir&#39; and &#39;time&#39;</span>
<span class="sd">        </span>
<span class="sd">        &#39;button&#39; is a number from 1 to 9 to indicate the event that </span>
<span class="sd">        was detected.</span>
<span class="sd">        1-17 are the &#39;btn1-btn17&#39; events.</span>
<span class="sd">        </span>
<span class="sd">        &#39;dir&#39; is the direction of the event eg &#39;up&#39; or &#39;down&#39;, </span>
<span class="sd">        trigger is described as &#39;on&#39; when low.</span>
<span class="sd">        </span>
<span class="sd">        &#39;dir&#39; is set to &#39;time&#39; if a requested </span>
<span class="sd">        timestamp event has been detected.</span>
<span class="sd">        </span>
<span class="sd">        &#39;time&#39; is the timestamp associated with the event.</span>
<span class="sd">        </span>
<span class="sd">        Value can be read as a structure, eg:</span>
<span class="sd">            res= getRTBoxResponse()</span>
<span class="sd">            res.dir, res.button, res.time</span>
<span class="sd">        or dictionary</span>
<span class="sd">            res[&#39;dir&#39;], res[&#39;button&#39;], res[&#39;time&#39;]</span>
<span class="sd">            </span>
<span class="sd">        Note that the firmware in Bits# units varies over time and some </span>
<span class="sd">        features of this class may not work for all firmware versions. </span>
<span class="sd">        Also Bits# units can be configured in various ways via their </span>
<span class="sd">        config.xml file so this class makes certain assumptions about the</span>
<span class="sd">        configuration. In particular it is assumed that all digital inputs,</span>
<span class="sd">        triggers and analog inputs are reported as part of status</span>
<span class="sd">        updates. If some of these report are disabled in your config.xml file </span>
<span class="sd">        then &#39;status&#39; and &#39;event&#39; commands in this class may not work.</span>
<span class="sd">        &quot;&quot;&quot;</span>    

        <span class="bp">self</span><span class="o">.</span><span class="n">getStatusBoxResponses</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nStatusPresses</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">op</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">statusButtons</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">op</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> </div>


<div class="viewcode-block" id="BitsSharp.getAllStatusBoxResponses">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.BitsSharp.getAllStatusBoxResponses">[docs]</a>
    <span class="k">def</span> <span class="nf">getAllStatusBoxResponses</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Read all of the statusBox style key presses on the </span>
<span class="sd">        input buffer.</span>
<span class="sd">        Returns a list of dict like objects with three members </span>
<span class="sd">        &#39;button&#39;, &#39;dir&#39; and &#39;time&#39;</span>
<span class="sd">        </span>
<span class="sd">        &#39;button&#39; is a number from 1 to 9 to indicate the event that </span>
<span class="sd">        was detected.</span>
<span class="sd">        1-17 are the &#39;btn1-btn17&#39; events.</span>
<span class="sd">        </span>
<span class="sd">        &#39;dir&#39; is the direction of the event eg &#39;up&#39; or &#39;down&#39;, </span>
<span class="sd">        trigger is described as &#39;on&#39; when low.</span>
<span class="sd">        </span>
<span class="sd">        &#39;dir&#39; is set to &#39;time&#39; if a requested </span>
<span class="sd">        timestamp event has been detected.</span>
<span class="sd">        </span>
<span class="sd">        &#39;time&#39; is the timestamp associated with the event.</span>
<span class="sd">        </span>
<span class="sd">        Values can be read as a structure eg::</span>

<span class="sd">            res= getAllStatusBoxResponses()</span>
<span class="sd">            res[0].dir, res[0].button, res[0].time</span>

<span class="sd">        or dictionary::</span>

<span class="sd">            res[0][&#39;dir&#39;], res[0][&#39;button&#39;], res[0][&#39;time&#39;]</span>
<span class="sd">            </span>
<span class="sd">        Note even if only 1 key press was found </span>
<span class="sd">        a list of dict / objects is returned.</span>
<span class="sd">        </span>
<span class="sd">        Note that the firmware in Bits# units varies over time and some </span>
<span class="sd">        features of this class may not work for all firmware versions. </span>
<span class="sd">        Also Bits# units can be configured in various ways via their </span>
<span class="sd">        config.xml file so this class makes certain assumptions about the</span>
<span class="sd">        configuration. In particular it is assumed that all digital inputs,</span>
<span class="sd">        triggers and analog inputs are reported as part of status</span>
<span class="sd">        updates. If some of these report are disabled in your config.xml file </span>
<span class="sd">        then &#39;status&#39; and &#39;event&#39; commands in this class may not work.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">N</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">statusQ</span><span class="o">.</span><span class="n">qsize</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getStatusBoxResponses</span><span class="p">(</span><span class="n">N</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="BitsSharp.statusBoxKeysPressed">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.BitsSharp.statusBoxKeysPressed">[docs]</a>
    <span class="k">def</span> <span class="nf">statusBoxKeysPressed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">N</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check to see if (at least) the appropriate number </span>
<span class="sd">        of RTBox style key presses have been made.</span>
<span class="sd">        </span>
<span class="sd">        Example:</span>
<span class="sd">            bits.statusBoxKeysPressed(5)</span>
<span class="sd">            </span>
<span class="sd">        will return false until 5 button presses have been recorded.</span>
<span class="sd">        </span>
<span class="sd">        Note that the firmware in Bits# units varies over time and some </span>
<span class="sd">        features of this class may not work for all firmware versions. </span>
<span class="sd">        Also Bits# units can be configured in various ways via their </span>
<span class="sd">        config.xml file so this class makes certain assumptions about the</span>
<span class="sd">        configuration. In particular it is assumed that all digital inputs,</span>
<span class="sd">        triggers and analog inputs are reported as part of status</span>
<span class="sd">        updates. If some of these report are disabled in your config.xml file </span>
<span class="sd">        then &#39;status&#39; and &#39;event&#39; commands in this class may not work.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#7 is number of bytes for one press</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">statusQ</span><span class="o">.</span><span class="n">qsize</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">N</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span> 
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span></div>

    
<div class="viewcode-block" id="BitsSharp.statusBoxWaitN">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.BitsSharp.statusBoxWaitN">[docs]</a>
    <span class="k">def</span> <span class="nf">statusBoxWaitN</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Waits until (at least) the appropriate number </span>
<span class="sd">        of RTBox style key presses have been made </span>
<span class="sd">        Pauses program execution in mean time.</span>
<span class="sd">        </span>
<span class="sd">        Example:</span>
<span class="sd">            res = bits.statusBoxWaitN(5) </span>
<span class="sd">            </span>
<span class="sd">        will suspend all other activity until 5 button presses have been</span>
<span class="sd">        recorded and will then return a list of Dicts containing the 5 results.</span>
<span class="sd">        </span>
<span class="sd">        Results can be accessed as follows:</span>
<span class="sd">            </span>
<span class="sd">        structure::</span>

<span class="sd">            res[0].dir, res[0].button, res[0].time</span>

<span class="sd">        or dictionary::</span>

<span class="sd">            res[0][&#39;dir&#39;], res[0][&#39;button&#39;], res[0][&#39;time&#39;]</span>
<span class="sd">        </span>
<span class="sd">        Note that the firmware in Bits# units varies over time and some </span>
<span class="sd">        features of this class may not work for all firmware versions. </span>
<span class="sd">        Also Bits# units can be configured in various ways via their </span>
<span class="sd">        config.xml file so this class makes certain assumptions about the</span>
<span class="sd">        configuration. In particular it is assumed that all digital inputs,</span>
<span class="sd">        triggers and analog inputs are reported as part of status</span>
<span class="sd">        updates. If some of these report are disabled in your config.xml file </span>
<span class="sd">        then &#39;status&#39; and &#39;event&#39; commands in this class may not work.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">noComms</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">statusQ</span><span class="o">.</span><span class="n">qsize</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">N</span><span class="p">:</span>
            <span class="k">continue</span> <span class="c1"># ie loop</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getStatusBoxResponses</span><span class="p">(</span><span class="n">N</span><span class="p">)</span></div>


<div class="viewcode-block" id="BitsSharp.statusBoxWait">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.BitsSharp.statusBoxWait">[docs]</a>
    <span class="k">def</span> <span class="nf">statusBoxWait</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Waits until (at least) one </span>
<span class="sd">        of RTBox style key presses have been made </span>
<span class="sd">        Pauses program execution in mean time.</span>
<span class="sd">        </span>
<span class="sd">        Example:</span>
<span class="sd">            res = bits.statusBoxWait() </span>
<span class="sd">            </span>
<span class="sd">        will suspend all other activity until 1 button press has been</span>
<span class="sd">        recorded and will then return a dict / structure containing results.</span>
<span class="sd">        </span>
<span class="sd">        Results can be accessed as follows:</span>
<span class="sd">            </span>
<span class="sd">        structure</span>
<span class="sd">            res.dir, res.button, res.time</span>
<span class="sd">        or dictionary</span>
<span class="sd">            res[&#39;dir&#39;], res[&#39;button&#39;], res[&#39;time&#39;]</span>
<span class="sd">            </span>
<span class="sd">            </span>
<span class="sd">        Note that the firmware in Bits# units varies over time and some </span>
<span class="sd">        features of this class may not work for all firmware versions. </span>
<span class="sd">        Also DBits# units can be configured in various ways via their </span>
<span class="sd">        config.xml file so this class makes certain assumptions about the</span>
<span class="sd">        configuration. In particular it is assumed that all digital inputs,</span>
<span class="sd">        triggers and analog inputs are reported as part of status</span>
<span class="sd">        updates. If some of these report are disabled in your config.xml file </span>
<span class="sd">        then &#39;status&#39; and &#39;event&#39; commands in this class may not work.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">noComms</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">statusQ</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
            <span class="k">continue</span> <span class="c1"># ie loop</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getStatusBoxResponse</span><span class="p">()</span></div>


    <span class="c1">#====================================================================#</span>
    <span class="c1">#   Helper function to run in its own thread detecting statusBox     #</span>
    <span class="c1">#   events and putting them in a queue                               #</span>
    <span class="c1">#====================================================================#</span>

    <span class="k">def</span> <span class="nf">_statusBox</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Should not normally be called by user</span>
<span class="sd">        Called in its own thread via self.statusBoxEnable()</span>
<span class="sd">        Reads the status reports from the Bits# for default 60 seconds or</span>
<span class="sd">        until self.statusBoxDisable() is called.</span>
<span class="sd"> </span>
<span class="sd">        Note any non status reports are found on the buffer will </span>
<span class="sd">        cause an error.</span>
<span class="sd">        </span>
<span class="sd">        args specifies the time over which to record status events.</span>
<span class="sd">        The minimum time is 10ms, less than this results in recording stopping after </span>
<span class="sd">        about 1 status report has been read.</span>
<span class="sd">        </span>
<span class="sd">        Puts its results into a Queue.</span>
<span class="sd">        </span>
<span class="sd">        This function is normally run in its own thread so actions can be asynchronous.</span>
<span class="sd">        </span>

<span class="sd">        &quot;&quot;&quot;</span>


        <span class="c1"># Continue reading data until sample time is up or status.End is set</span>
        <span class="c1"># Note when used in thread statusEnd can be set from outside this function.</span>
        <span class="n">firstIn</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># we do something different for the very first status entry</span>
        <span class="k">while</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">statusBoxEnd</span> <span class="o">==</span> <span class="kc">False</span><span class="p">):</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">com</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="mf">0.01</span>
            <span class="n">raw</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
            <span class="n">nChars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inWaiting</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">nChars</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_statusSize</span><span class="p">:</span>  <span class="c1"># we many have a status report</span>
                <span class="c1"># use self.com.read() to get exact number of chars</span>
                <span class="n">raw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">com</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">nChars</span><span class="p">)</span> 
                <span class="n">msg</span><span class="o">=</span><span class="n">raw</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
                <span class="c1"># just in case split message into status lines marked by CR</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">)</span> 
                <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> 
                <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">button</span><span class="p">()</span> <span class="k">for</span>  <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)]</span> 
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span> <span class="c1"># for each status line</span>
                    <span class="c1"># split line into component parts marked by ;</span>
                    <span class="n">v</span><span class="o">=</span><span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span> 
                    <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;#sample&#39;</span><span class="p">:</span> <span class="c1"># Check we have read a status line</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">firstIn</span><span class="p">:</span> <span class="c1"># Not first status entry</span>
                            <span class="c1"># Check digital inputs</span>
                            <span class="k">for</span> <span class="n">sourse</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">17</span><span class="p">):</span>
                                <span class="c1"># if input has changed and input is mapped</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">3</span><span class="o">+</span><span class="n">sourse</span><span class="p">]</span> <span class="o">!=</span> <span class="n">log</span><span class="p">[</span><span class="mi">3</span><span class="o">+</span><span class="n">sourse</span><span class="p">]</span> 
                                    <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">statusButtonMap</span><span class="p">[</span><span class="n">sourse</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">24</span><span class="p">):</span> 
                                    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;Down&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">statusBoxMode</span>
                                            <span class="ow">or</span> <span class="s1">&#39;down&#39;</span>  <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">statusBoxMode</span><span class="p">):</span>
                                        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">3</span><span class="o">+</span><span class="n">sourse</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                            <span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">button</span> <span class="o">=</span> <span class="p">(</span>
                                                    <span class="bp">self</span><span class="o">.</span><span class="n">statusButtonMap</span><span class="p">[</span><span class="n">sourse</span><span class="p">])</span>
                                            <span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                                            <span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">dir</span> <span class="o">=</span> <span class="s1">&#39;down&#39;</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">statusQ</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                                    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;Up&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">statusBoxMode</span>
                                            <span class="ow">or</span> <span class="s1">&#39;up&#39;</span>  <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">statusBoxMode</span><span class="p">):</span>
                                        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">3</span><span class="o">+</span><span class="n">sourse</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                            <span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">button</span> <span class="o">=</span> <span class="p">(</span>
                                                    <span class="bp">self</span><span class="o">.</span><span class="n">statusButtonMap</span><span class="p">[</span><span class="n">sourse</span><span class="p">])</span>
                                            <span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                                            <span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">dir</span> <span class="o">=</span> <span class="s1">&#39;up&#39;</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">statusQ</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                                    <span class="c1"># save new state of sourse</span>
                                    <span class="n">log</span><span class="p">[</span><span class="mi">3</span><span class="o">+</span><span class="n">sourse</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="mi">3</span><span class="o">+</span><span class="n">sourse</span><span class="p">]</span> 
                            <span class="c1"># Check analog inputs</span>
                            <span class="k">for</span> <span class="n">analog</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
                                <span class="n">sourse</span> <span class="o">=</span> <span class="n">analog</span> <span class="o">+</span> <span class="mi">17</span>
                                <span class="n">fLog</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">log</span><span class="p">[</span><span class="mi">3</span><span class="o">+</span><span class="n">sourse</span><span class="p">])</span>
                                <span class="n">fVal</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">3</span><span class="o">+</span><span class="n">sourse</span><span class="p">])</span>
                                <span class="c1"># if input has changed enough and input is mapped</span>
                                <span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">fVal</span> <span class="o">-</span> <span class="n">fLog</span><span class="p">)</span>
                                    <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">statusBoxThreshold</span>
                                    <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">statusButtonMap</span><span class="p">[</span><span class="n">sourse</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">24</span><span class="p">):</span> 
                                    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;Down&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">statusBoxMode</span>
                                            <span class="ow">or</span> <span class="s1">&#39;down&#39;</span>  <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">statusBoxMode</span><span class="p">):</span>
                                        <span class="c1"># Is change of input in downward direction</span>
                                        <span class="k">if</span> <span class="n">fLog</span> <span class="o">&gt;</span> <span class="n">fVal</span><span class="p">:</span>
                                            <span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">button</span> <span class="o">=</span> <span class="p">(</span>
                                                    <span class="bp">self</span><span class="o">.</span><span class="n">statusButtonMap</span><span class="p">[</span><span class="n">sourse</span><span class="p">])</span>
                                            <span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                                            <span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">dir</span> <span class="o">=</span> <span class="s1">&#39;down&#39;</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">statusQ</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

                                    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;Up&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">statusBoxMode</span>
                                            <span class="ow">or</span> <span class="s1">&#39;up&#39;</span>  <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">statusBoxMode</span><span class="p">):</span>
                                        <span class="c1"># Is change of input in upward direction</span>
                                        <span class="k">if</span> <span class="n">fVal</span> <span class="o">&gt;</span> <span class="n">fLog</span><span class="p">:</span>
                                            <span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">button</span> <span class="o">=</span> <span class="p">(</span>
                                                    <span class="bp">self</span><span class="o">.</span><span class="n">statusButtonMap</span><span class="p">[</span><span class="n">sourse</span><span class="p">])</span>
                                            <span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                                            <span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">dir</span> <span class="o">=</span> <span class="s1">&#39;up&#39;</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">statusQ</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                                    <span class="c1"># save new state of sourse</span>
                                    <span class="n">log</span><span class="p">[</span><span class="mi">3</span><span class="o">+</span><span class="n">sourse</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="mi">3</span><span class="o">+</span><span class="n">sourse</span><span class="p">]</span> 
                        <span class="k">else</span><span class="p">:</span> <span class="c1"># this is the first entry</span>
                            <span class="n">log</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="c1"># make a copy of status entry</span>
                            <span class="n">firstIn</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">elif</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;$touch&#39;</span><span class="p">:</span> <span class="c1"># We&#39;ve read a screen touch event by mistake.</span>
                        <span class="n">warning</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;_statusBox found touch&quot;</span> 
                                <span class="s2">&quot; data on input so skipping that&quot;</span><span class="p">)</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">warning</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span> <span class="c1"># We&#39;ve read something we can&#39;t interpret.</span>
                        <span class="n">warning</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;_statusBox found unknown data&quot;</span>
                                <span class="s2">&quot; on input so skipping that&quot;</span><span class="p">)</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">warning</span><span class="p">)</span>
                        
        <span class="c1"># clearn up when stop is called.</span>
        <span class="c1"># Send stop signal to CRS device to shut it up.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_statusDisable</span><span class="p">()</span> <span class="c1"># Send stop signal to CRS device to shut it up.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statusBoxEnd</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># Confirm that data logging has ended.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

    <span class="c1">#====================================================================#</span>
    <span class="c1">#    &#39;status&#39; functions use BitsSharp status reporting to read the   #</span>
    <span class="c1">#    digital IO, IR channels                                         #</span>
    <span class="c1">#    and analog inputs via a separate thread                          #</span>
    <span class="c1">#====================================================================#</span>

<div class="viewcode-block" id="BitsSharp.setStatusEventParams">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.BitsSharp.setStatusEventParams">[docs]</a>
    <span class="k">def</span> <span class="nf">setStatusEventParams</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">DINBase</span><span class="o">=</span><span class="mb">0b1111111111</span><span class="p">,</span> 
                                      <span class="n">IRBase</span><span class="o">=</span><span class="mb">0b111111</span><span class="p">,</span> 
                                      <span class="n">TrigInBase</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                      <span class="n">ADCBase</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                      <span class="n">threshold</span><span class="o">=</span><span class="mf">9999.99</span><span class="p">,</span>
                                      <span class="n">mode</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;up&#39;</span><span class="p">,</span><span class="s1">&#39;down&#39;</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Sets the parameters used to determine if a status value represents</span>
<span class="sd">        a reportable event.</span>
<span class="sd">        </span>
<span class="sd">        DIN_base = a 10 bit binary word specifying the expected starting </span>
<span class="sd">        values of the 10 digital input lines</span>
<span class="sd">        </span>
<span class="sd">        IR_base = a 6 bit binary word specifying the expected starting </span>
<span class="sd">        values of the 6 CB6 IR buttons</span>
<span class="sd">        </span>
<span class="sd">        Trig_base = the starting value of the Trigger input</span>
<span class="sd">        </span>
<span class="sd">        mode = a list of event types to monitor can be &#39;up&#39; or  &#39;down&#39; </span>
<span class="sd">        typically &#39;down&#39; corresponds to a button press or when the input</span>
<span class="sd">        is being pulled down to zero volts.</span>
<span class="sd">        </span>
<span class="sd">        Example::</span>

<span class="sd">            bits.setStatusEventParams(DINBase=0b1111111111, </span>
<span class="sd">                                      IRBase=0b111111, </span>
<span class="sd">                                      TrigInBase=0, </span>
<span class="sd">                                      ADCBase=0,</span>
<span class="sd">                                      threshold = 3.4,</span>
<span class="sd">                                      mode = [&#39;down&#39;])</span>
<span class="sd">            bits.startStatusLog()</span>
<span class="sd">            while not event</span>
<span class="sd">                #do some processing</span>
<span class="sd">                continue</span>
<span class="sd">            bits.stopStatusLog()</span>
<span class="sd">            res=getAllStatusEvents(0)</span>
<span class="sd">            print(bits.res.time)</span>
<span class="sd">            </span>
<span class="sd">        This ill start the event extraction process as if DINs and IRs are all &#39;1&#39;, Trigger is &#39;0&#39;</span>
<span class="sd">        ADCs = 0 with an ADC threshold for change of 3.4 volts,</span>
<span class="sd">        and will only register &#39;down&#39; events. Here we display the time stamp of the first event.</span>
<span class="sd">        </span>
<span class="sd">        Note that the firmware in Display++ units varies over time and some </span>
<span class="sd">        features of this class may not work for all firmware versions. </span>
<span class="sd">        Also Display++ units can be configured in various ways via their </span>
<span class="sd">        config.xml file so this class makes certain assumptions about the</span>
<span class="sd">        configuration. In particular it is assumed that all digital inputs,</span>
<span class="sd">        triggers and analog inputs are reported as part of status</span>
<span class="sd">        updates. If some of these report are disabled in your config.xml file </span>
<span class="sd">        then &#39;status&#39; and &#39;event&#39; commands in this class may not work.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statusDINBase</span> <span class="o">=</span> <span class="n">DINBase</span>   <span class="c1"># Initial values for ditgial ins</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statusIRBase</span> <span class="o">=</span> <span class="n">IRBase</span>        <span class="c1"># Initial values for CB6 IR box</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statusTrigInBase</span> <span class="o">=</span> <span class="n">TrigInBase</span>           <span class="c1"># Initial values for TrigIn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statusADCBase</span> <span class="o">=</span> <span class="n">ADCBase</span>           <span class="c1"># Initial value for all ADCs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statusThreshold</span> <span class="o">=</span> <span class="n">threshold</span>   <span class="c1"># Threshold for ADC events</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statusMode</span> <span class="o">=</span> <span class="n">mode</span>     <span class="c1"># Direction of events to be reported</span></div>


<div class="viewcode-block" id="BitsSharp.pollStatus">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.BitsSharp.pollStatus">[docs]</a>
    <span class="k">def</span> <span class="nf">pollStatus</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Reads the status reports from the Bits# for the specified </span>
<span class="sd">        usually short time period t. The script will wait for this time</span>
<span class="sd">        to lapse so not ideal for  time critical applications.</span>
<span class="sd">        </span>
<span class="sd">        If t is less than 0.01 polling will continue until at least 1</span>
<span class="sd">        data entry has been recorded.</span>
<span class="sd">        </span>
<span class="sd">        If you don&#39;t want to wait while this does its job </span>
<span class="sd">        use startStatusLog and stopStatusLog instead.</span>
<span class="sd">        </span>
<span class="sd">        Fills the statusValues list with all the status values</span>
<span class="sd">        read during the time period.</span>
<span class="sd">        </span>
<span class="sd">        Fills the statusEvents list with just those status values</span>
<span class="sd">        that are likely to be meaningful events.</span>
<span class="sd">        </span>
<span class="sd">        the members statusValues and statusEvents will end up containing </span>
<span class="sd">        dict like objects of the following style:</span>
<span class="sd">        sample, time, trigIn, DIN[10], DWORD, IR[6], ADC[6]</span>
<span class="sd">        </span>
<span class="sd">        They can be accessed as statusValues[i][&#39;sample&#39;] or </span>
<span class="sd">        stautsValues[i].sample, statusValues[x].ADC[j].</span>
<span class="sd">        </span>
<span class="sd">        Example::</span>

<span class="sd">            bits.pollStatus()</span>
<span class="sd">            print(bits.statusValues[0].IR[0])</span>
<span class="sd">            </span>
<span class="sd">        will display the value of the IR InputA in the first sample recorded.</span>

<span class="sd">        Note: Starts and stops logging for itself.</span>
<span class="sd">        </span>
<span class="sd">        </span>
<span class="sd">        Note that the firmware in Bits# units varies over time and some </span>
<span class="sd">        features of this class may not work for all firmware versions. </span>
<span class="sd">        Also Bits# units can be configured in various ways via their </span>
<span class="sd">        config.xml file so this class makes certain assumptions about the</span>
<span class="sd">        configuration. In particular it is assumed that all digital inputs,</span>
<span class="sd">        triggers and analog inputs are reported as part of status</span>
<span class="sd">        updates. If some of these report are disabled in your config.xml file </span>
<span class="sd">        then &#39;status&#39; and &#39;event&#39; commands in this class may not work.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">startStatusLog</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statusThread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_statusDisable</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_getStatusLog</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_extractStatusEvents</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">statusThread</span></div>


<div class="viewcode-block" id="BitsSharp.startStatusLog">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.BitsSharp.startStatusLog">[docs]</a>
    <span class="k">def</span> <span class="nf">startStatusLog</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="mi">60</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Start logging data from the Bits#</span>
<span class="sd">        </span>
<span class="sd">            Starts data logging in its own thread.</span>
<span class="sd">            </span>
<span class="sd">            Will run for t seconds, defrault 60 or until </span>
<span class="sd">            stopStatusLog() is called.</span>
<span class="sd">            </span>
<span class="sd">            Example::</span>

<span class="sd">                bits.startStatusLog()</span>
<span class="sd">                while not event</span>
<span class="sd">                    #do some processing</span>
<span class="sd">                    continue</span>
<span class="sd">                bits.stopStatusLog()</span>
<span class="sd">            </span>
<span class="sd">        Note that the firmware in Bits# units varies over time and some </span>
<span class="sd">        features of this class may not work for all firmware versions. </span>
<span class="sd">        Also Bits# units can be configured in various ways via their </span>
<span class="sd">        config.xml file so this class makes certain assumptions about the</span>
<span class="sd">        configuration. In particular it is assumed that all digital inputs,</span>
<span class="sd">        triggers and analog inputs are reported as part of status</span>
<span class="sd">        updates. If some of these report are disabled in your config.xml file </span>
<span class="sd">        then &#39;status&#39; and &#39;event&#39; commands in this class may not work.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">statusBoxEnabled</span><span class="p">:</span>
            <span class="n">warning</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Cannot use status log when statusBox is on &quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="n">warning</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">RTBoxEnabled</span><span class="p">:</span>
            <span class="n">warning</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Cannot use status log when RTBox is on &quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="n">warning</span><span class="p">)</span>
        
        <span class="c1"># Try both Py2 and Py3 safe versions</span>
        <span class="c1"># The two Python versions seem to want to pass args to threads in different ways.</span>
        <span class="k">try</span><span class="p">:</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">statusThread</span><span class="o">=</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_statusLog</span><span class="p">,</span><span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">t</span><span class="p">,))</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">statusThread</span><span class="o">=</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_statusLog</span><span class="p">,</span><span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statusEnd</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_statusEnable</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statusThread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span></div>


<div class="viewcode-block" id="BitsSharp.stopStatusLog">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.BitsSharp.stopStatusLog">[docs]</a>
    <span class="k">def</span> <span class="nf">stopStatusLog</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Stop logging data from the Bits#</span>
<span class="sd">            and extracts the raw status values and significant events and puts them</span>
<span class="sd">            in statusValues and statusEvents.</span>
<span class="sd">            </span>
<span class="sd">            statusValues will end up containing </span>
<span class="sd">            dict like objects of the following style: `sample, time, trigIn, DIN[10], DWORD, IR[6], ADC[6]`</span>
<span class="sd">        </span>
<span class="sd">            They can be accessed as statusValues[i][&#39;sample&#39;] or </span>
<span class="sd">            statusValues[i].sample, statusValues[x].ADC[j].</span>
<span class="sd">            </span>
<span class="sd">            StatusEvents will end up containing dict like objects of</span>
<span class="sd">            the following style: `source, input, direction, time`</span>
<span class="sd">                </span>
<span class="sd">            The data can be accessed as statusEvents[i][&#39;time&#39;] or statusEvents[i].time</span>
<span class="sd">            </span>
<span class="sd">            Waits for _statusLog to finish properly </span>
<span class="sd">            so can introduce a timing delay.</span>
<span class="sd">                        </span>
<span class="sd">        Example::</span>

<span class="sd">            bits.startStatusLog()</span>
<span class="sd">            while not event</span>
<span class="sd">                #do some processing</span>
<span class="sd">                continue</span>
<span class="sd">            bits.stopStatusLog()</span>
<span class="sd">            print(bits.statusValues[0].time)</span>
<span class="sd">            print(bits.statusEvents[0].time)</span>
<span class="sd">            </span>
<span class="sd">        Will display the time stamps of the first starus value recorded and the first</span>
<span class="sd">        meaningful event.</span>


<span class="sd">        Note that the firmware in Bits# units varies over time and some </span>
<span class="sd">        features of this class may not work for all firmware versions. </span>
<span class="sd">        Also Bits# units can be configured in various ways via their </span>
<span class="sd">        config.xml file so this class makes certain assumptions about the</span>
<span class="sd">        configuration. In particular it is assumed that all digital inputs,</span>
<span class="sd">        triggers and analog inputs are reported as part of status</span>
<span class="sd">        updates. If some of these report are disabled in your config.xml file </span>
<span class="sd">        then &#39;status&#39; and &#39;event&#39; commands in this class may not work.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">statusEnd</span><span class="o">=</span><span class="kc">True</span> <span class="c1"># This semaphore will tell the status logging thread to stop.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statusThread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span> <span class="c1"># Join the thread and wait for it to finish.</span>
        <span class="c1"># Get the stausts values and events form the queue.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_getStatusLog</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_extractStatusEvents</span><span class="p">()</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">statusThread</span></div>


<div class="viewcode-block" id="BitsSharp.getAllStatusEvents">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.BitsSharp.getAllStatusEvents">[docs]</a>
    <span class="k">def</span> <span class="nf">getAllStatusEvents</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the whole status event list</span>
<span class="sd">        </span>
<span class="sd">        Returns a list of dictionary like objects with the following entries</span>
<span class="sd">        source, input, direction, time.</span>
<span class="sd">        </span>
<span class="sd">        source = the general source of the event - e.g. </span>
<span class="sd">        DIN for Digital input, </span>
<span class="sd">        IR for CB6 IR response box events</span>
<span class="sd">        </span>
<span class="sd">        input = the individual input in the source.</span>
<span class="sd">        direction = &#39;up&#39; or &#39;down&#39;</span>
<span class="sd">        time = time stamp.</span>
<span class="sd">        </span>
<span class="sd">        All sourses are numbered from zero.</span>
<span class="sd">        Din 0 ... 9</span>
<span class="sd">        IR 0 ... 5</span>
<span class="sd">        ADC 0 ... 5</span>
<span class="sd">        </span>
<span class="sd">        mode specifies which directions of events are captured. </span>
<span class="sd">        e.g &#39;up&#39; will only report up events.</span>
<span class="sd">        </span>
<span class="sd">        The data can be accessed as value[i][&#39;time&#39;] or value[i].time</span>
<span class="sd">        </span>
<span class="sd">        Example::</span>

<span class="sd">            bits.startStatusLog()</span>
<span class="sd">            while not event</span>
<span class="sd">                #do some processing</span>
<span class="sd">                continue</span>
<span class="sd">            bits.stopStatusLog()</span>
<span class="sd">            res=getAllStatusEvents()</span>
<span class="sd">            print(bits.res[0].time)</span>
<span class="sd">            </span>
<span class="sd">        Note that the firmware in Bits# units varies over time and some </span>
<span class="sd">        features of this class may not work for all firmware versions. </span>
<span class="sd">        Also Bits# units can be configured in various ways via their </span>
<span class="sd">        config.xml file so this class makes certain assumptions about the</span>
<span class="sd">        configuration. In particular it is assumed that all digital inputs,</span>
<span class="sd">        triggers and analog inputs are reported as part of status</span>
<span class="sd">        updates. If some of these report are disabled in your config.xml file </span>
<span class="sd">        then &#39;status&#39; and &#39;event&#39; commands in this class may not work.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">statusEvents</span></div>


<div class="viewcode-block" id="BitsSharp.getStatusEvent">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.BitsSharp.getStatusEvent">[docs]</a>
    <span class="k">def</span> <span class="nf">getStatusEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span> 
<span class="w">        </span><span class="sd">&quot;&quot;&quot; pulls out the Nth event from the status event list</span>
<span class="sd">        </span>
<span class="sd">        Returns a dictionary like object with the following entries</span>
<span class="sd">        source, input, direction, time.</span>
<span class="sd">        </span>
<span class="sd">        source = the general source of the event - e.g. </span>
<span class="sd">        DIN for Digital input, </span>
<span class="sd">        IR for IT response box.</span>
<span class="sd">        </span>
<span class="sd">        input = the individual input in the source.</span>
<span class="sd">        direction = &#39;up&#39; or &#39;down&#39;</span>
<span class="sd">        time = time stamp.</span>
<span class="sd">        </span>
<span class="sd">        All sourses are numbered from zero.</span>
<span class="sd">        Din 0 ... 9</span>
<span class="sd">        IR 0 ... 5</span>
<span class="sd">        ADC 0 ... 5</span>
<span class="sd">        </span>
<span class="sd">        mode specifies which directions of events are captured, </span>
<span class="sd">        e.g &#39;up&#39; will only report up events.</span>
<span class="sd">        </span>
<span class="sd">        The data can be accessed as value[&#39;time&#39;] or value.time</span>
<span class="sd">        </span>
<span class="sd">        Example::</span>

<span class="sd">            bits.startStatusLog()</span>
<span class="sd">            while not event</span>
<span class="sd">                #do some processing</span>
<span class="sd">                continue</span>
<span class="sd">            bits.stopStatusLog()</span>
<span class="sd">            res=getAllStatusEvents(20)</span>
<span class="sd">            print(bits.res.time)</span>
<span class="sd">            </span>
<span class="sd">        Note that the firmware in Bits# units varies over time and some </span>
<span class="sd">        features of this class may not work for all firmware versions. </span>
<span class="sd">        Also Bits# units can be configured in various ways via their </span>
<span class="sd">        config.xml file so this class makes certain assumptions about the</span>
<span class="sd">        configuration. In particular it is assumed that all digital inputs,</span>
<span class="sd">        triggers and analog inputs are reported as part of status</span>
<span class="sd">        updates. If some of these report are disabled in your config.xml file </span>
<span class="sd">        then &#39;status&#39; and &#39;event&#39; commands in this class may not work.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">N</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">status_nEvents</span><span class="p">:</span>
            <span class="n">op</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">statusEvents</span><span class="p">[</span><span class="n">N</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">op</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> </div>


<div class="viewcode-block" id="BitsSharp.getAllStatusValues">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.BitsSharp.getAllStatusValues">[docs]</a>
    <span class="k">def</span> <span class="nf">getAllStatusValues</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the whole status values list.</span>
<span class="sd">        </span>
<span class="sd">        Returns a list of dict like objects with the following entries</span>
<span class="sd">        sample, time, trigIn, DIN[10], DWORD, IR[6], ADC[6]</span>
<span class="sd">        sample is the sample ID number.</span>
<span class="sd">        time is the time stamp.</span>
<span class="sd">        trigIn is the value of the trigger input.</span>
<span class="sd">        DIN is a list of 10 digital input values.</span>
<span class="sd">        DWORD represents the digital inputs as a single decimal value.</span>
<span class="sd">        IR is a list of 10 infra-red (IR) input values.</span>
<span class="sd">        ADC is a list of 6 analog input values.</span>
<span class="sd">        These can be accessed as value[i][&#39;sample&#39;] </span>
<span class="sd">        or value[i].sample, values[i].ADC[j].</span>
<span class="sd">        </span>
<span class="sd">        All sourses are numbered from zero.</span>
<span class="sd">        Din 0 ... 9</span>
<span class="sd">        IR 0 ... 5</span>
<span class="sd">        ADC 0 ... 5</span>
<span class="sd">        </span>
<span class="sd">        Example::</span>

<span class="sd">            bits.startStatusLog()</span>
<span class="sd">            while not event</span>
<span class="sd">                #do some processing</span>
<span class="sd">                continue</span>
<span class="sd">            bits.stopStatusLog()</span>
<span class="sd">            res=getAllStatusValues()</span>
<span class="sd">            print(bits.res[0].time)</span>
<span class="sd">            </span>
<span class="sd">        Note that the firmware in Bits# units varies over time and some </span>
<span class="sd">        features of this class may not work for all firmware versions. </span>
<span class="sd">        Also Bits# units can be configured in various ways via their </span>
<span class="sd">        config.xml file so this class makes certain assumptions about the</span>
<span class="sd">        configuration. In particular it is assumed that all digital inputs,</span>
<span class="sd">        triggers and analog inputs are reported as part of status</span>
<span class="sd">        updates. If some of these report are disabled in your config.xml file </span>
<span class="sd">        then &#39;status&#39; and &#39;event&#39; commands in this class may not work.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">statusValues</span></div>


<div class="viewcode-block" id="BitsSharp.getStatus">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.BitsSharp.getStatus">[docs]</a>
    <span class="k">def</span> <span class="nf">getStatus</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">N</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Pulls out the Nth entry in the statusValues list.</span>
<span class="sd">        </span>
<span class="sd">        Returns a dict like object with the following entries</span>
<span class="sd">        sample, time, trigIn, DIN[10], DWORD, IR[6], ADC[6]</span>
<span class="sd">        </span>
<span class="sd">        sample is the sample ID number.</span>
<span class="sd">        time is the time stamp.</span>
<span class="sd">        trigIn is the value of the trigger input.</span>
<span class="sd">        DIN is a list of 10 digital input values.</span>
<span class="sd">        DWORD represents the digital inputs as a single decimal value.</span>
<span class="sd">        IR is a list of 10 infra-red (IR) input values.</span>
<span class="sd">        ADC is a list of 6 analog input values.</span>
<span class="sd">        These can be accessed as value[&#39;sample&#39;] </span>
<span class="sd">        or value.sample, values.ADC[j].</span>
<span class="sd">        </span>
<span class="sd">        All sourses are numbered from zero.</span>
<span class="sd">        Din 0 ... 9</span>
<span class="sd">        IR 0 ... 5</span>
<span class="sd">        ADC 0 ... 5</span>

<span class="sd">        Example::</span>

<span class="sd">            bits.startStatusLog()</span>
<span class="sd">            while not event</span>
<span class="sd">                #do some processing</span>
<span class="sd">                continue</span>
<span class="sd">            bits.stopStatusLog()</span>
<span class="sd">            res=getStatus(20)</span>
<span class="sd">            print(bits.res.time)</span>
<span class="sd">            </span>
<span class="sd">            </span>
<span class="sd">        Note that the firmware in Bits# units varies over time and some </span>
<span class="sd">        features of this class may not work for all firmware versions. </span>
<span class="sd">        Also Bits# units can be configured in various ways via their </span>
<span class="sd">        config.xml file so this class makes certain assumptions about the</span>
<span class="sd">        configuration. In particular it is assumed that all digital inputs,</span>
<span class="sd">        triggers and analog inputs are reported as part of status</span>
<span class="sd">        updates. If some of these report are disabled in your config.xml file </span>
<span class="sd">        then &#39;status&#39; and &#39;event&#39; commands in this class may not work.</span>
<span class="sd"> </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">N</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">status_nValues</span><span class="p">:</span>
            <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">statusValues</span><span class="p">[</span><span class="n">N</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> </div>



<div class="viewcode-block" id="BitsSharp.getAnalog">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.BitsSharp.getAnalog">[docs]</a>
    <span class="k">def</span> <span class="nf">getAnalog</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">N</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Pulls out the values of the analog inputs for </span>
<span class="sd">        the Nth status entry.</span>
<span class="sd">        </span>
<span class="sd">        Returns a dictionary with a list of 6 floats (ADC) and a time stamp (time).</span>
<span class="sd">        </span>
<span class="sd">        All sourses are numbered from zero.</span>
<span class="sd">        ADC 0 ... 5</span>
<span class="sd">        </span>
<span class="sd">        Example:</span>
<span class="sd">            bits.pollStatus()</span>
<span class="sd">            res=bits.getAnalog()</span>
<span class="sd">            print(res[&#39;ADC&#39;])</span>
<span class="sd">            </span>
<span class="sd">        will poll the status display the values of the  ADC inputs </span>
<span class="sd">        in the first status entry returned.</span>
<span class="sd">        </span>
<span class="sd">        Note that the firmware in Bits# units varies over time and some </span>
<span class="sd">        features of this class may not work for all firmware versions. </span>
<span class="sd">        Also Bits# units can be configured in various ways via their </span>
<span class="sd">        config.xml file so this class makes certain assumptions about the</span>
<span class="sd">        configuration. In particular it is assumed that all digital inputs,</span>
<span class="sd">        triggers and analog inputs are reported as part of status</span>
<span class="sd">        updates. If some of these report are disabled in your config.xml file </span>
<span class="sd">        then &#39;status&#39; and &#39;event&#39; commands in this class may not work.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getStatus</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;ADC&#39;</span><span class="p">:</span><span class="n">value</span><span class="o">.</span><span class="n">ADC</span><span class="p">,</span><span class="s1">&#39;time&#39;</span><span class="p">:</span><span class="n">value</span><span class="o">.</span><span class="n">time</span><span class="p">}</span></div>

        
<div class="viewcode-block" id="BitsSharp.getDigital">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.BitsSharp.getDigital">[docs]</a>
    <span class="k">def</span> <span class="nf">getDigital</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">N</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Pulls out the values of the digital inputs for</span>
<span class="sd">        the Nth status entry.</span>
<span class="sd">        </span>
<span class="sd">        Returns a dictionary with a list of 10 ints that </span>
<span class="sd">        are 1 or 0 (DIN) and a time stamp (time)</span>
<span class="sd">        </span>
<span class="sd">        ll sourses are numbered from zero.</span>
<span class="sd">        Din 0 ... 9</span>

<span class="sd">        </span>
<span class="sd">        Example:</span>
<span class="sd">            bits.pollStatus()</span>
<span class="sd">            res=bits.getAnalog()</span>
<span class="sd">            print(res[&#39;DIN&#39;])</span>
<span class="sd">            </span>
<span class="sd">        will poll the status display the value of the  digital inputs </span>
<span class="sd">        in the first status entry returned.</span>
<span class="sd">        </span>
<span class="sd">        Note that the firmware in Bits# units varies over time and some </span>
<span class="sd">        features of this class may not work for all firmware versions. </span>
<span class="sd">        Also DBits# units can be configured in various ways via their </span>
<span class="sd">        config.xml file so this class makes certain assumptions about the</span>
<span class="sd">        configuration. In particular it is assumed that all digital inputs,</span>
<span class="sd">        triggers and analog inputs are reported as part of status</span>
<span class="sd">        updates. If some of these report are disabled in your config.xml file </span>
<span class="sd">        then &#39;status&#39; and &#39;event&#39; commands in this class may not work.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getStatus</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;DIN&#39;</span><span class="p">:</span><span class="n">value</span><span class="o">.</span><span class="n">DIN</span><span class="p">,</span><span class="s1">&#39;time&#39;</span><span class="p">:</span><span class="n">value</span><span class="o">.</span><span class="n">time</span><span class="p">}</span></div>

        
<div class="viewcode-block" id="BitsSharp.getDigitalWord">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.BitsSharp.getDigitalWord">[docs]</a>
    <span class="k">def</span> <span class="nf">getDigitalWord</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">N</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Pulls out the values of the digital inputs for </span>
<span class="sd">        the Nth status entry.</span>
<span class="sd">        </span>
<span class="sd">        Returns a dictionary with a 10 bit word representing the binary</span>
<span class="sd">        values of those inputs (DWORD) and a time stamp (time).</span>
<span class="sd">        </span>
<span class="sd">        Example:</span>
<span class="sd">            bits.pollStatus()</span>
<span class="sd">            res=bits.getAnalog()</span>
<span class="sd">            print(res[&#39;DWORD&#39;])</span>
<span class="sd">            </span>
<span class="sd">        will poll the status display the value of the digital inputs </span>
<span class="sd">        as a decimal number.</span>
<span class="sd">        </span>
<span class="sd">        Note that the firmware in Bits# units varies over time and some </span>
<span class="sd">        features of this class may not work for all firmware versions. </span>
<span class="sd">        Also Bits# units can be configured in various ways via their </span>
<span class="sd">        config.xml file so this class makes certain assumptions about the</span>
<span class="sd">        configuration. In particular it is assumed that all digital inputs,</span>
<span class="sd">        triggers and analog inputs are reported as part of status</span>
<span class="sd">        updates. If some of these report are disabled in your config.xml file </span>
<span class="sd">        then &#39;status&#39; and &#39;event&#39; commands in this class may not work.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getStatus</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;DWORD&#39;</span><span class="p">:</span><span class="n">value</span><span class="o">.</span><span class="n">DWORD</span><span class="p">,</span><span class="s1">&#39;time&#39;</span><span class="p">:</span><span class="n">value</span><span class="o">.</span><span class="n">time</span><span class="p">}</span></div>

        
<div class="viewcode-block" id="BitsSharp.getTrigIn">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.BitsSharp.getTrigIn">[docs]</a>
    <span class="k">def</span> <span class="nf">getTrigIn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">N</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Pulls out the values of the trigger input for the </span>
<span class="sd">        Nth status entry.</span>
<span class="sd">        </span>
<span class="sd">        Returns dictionary with a 0 or 1 (trigIn) and a time stamp (time)</span>
<span class="sd">        </span>
<span class="sd">        Example:</span>
<span class="sd">            bits.pollStatus()</span>
<span class="sd">            res=bits.getAnalog()</span>
<span class="sd">            print(res[&#39;trigIn&#39;])</span>
<span class="sd">            </span>
<span class="sd">        will poll the status display the value of the trigger input.</span>
<span class="sd">        </span>
<span class="sd">        Note that the firmware in Bits# units varies over time and some </span>
<span class="sd">        features of this class may not work for all firmware versions. </span>
<span class="sd">        Also Bits# units can be configured in various ways via their </span>
<span class="sd">        config.xml file so this class makes certain assumptions about the</span>
<span class="sd">        configuration. In particular it is assumed that all digital inputs,</span>
<span class="sd">        triggers and analog inputs are reported as part of status</span>
<span class="sd">        updates. If some of these report are disabled in your config.xml file </span>
<span class="sd">        then &#39;status&#39; and &#39;event&#39; commands in this class may not work.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getStatus</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;trigIn&#39;</span><span class="p">:</span><span class="n">value</span><span class="o">.</span><span class="n">trigIn</span><span class="p">,</span><span class="s1">&#39;time&#39;</span><span class="p">:</span><span class="n">value</span><span class="o">.</span><span class="n">time</span><span class="p">}</span></div>

        
<div class="viewcode-block" id="BitsSharp.getIRBox">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.BitsSharp.getIRBox">[docs]</a>
    <span class="k">def</span> <span class="nf">getIRBox</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">N</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Pulls out the values of the CB6 IR response box inputs for</span>
<span class="sd">        the Nth status entry.</span>
<span class="sd">        </span>
<span class="sd">        Returns a dictionary with a list of 6 ints that are</span>
<span class="sd">        1 or 0 (IRBox) and a time stamp (time).</span>
<span class="sd">        </span>
<span class="sd">        ll sourses are numbered from zero.</span>
<span class="sd">        IR 0 ... 5</span>
<span class="sd">        </span>
<span class="sd">        </span>
<span class="sd">        Example:</span>
<span class="sd">            bits.pollStatus()</span>
<span class="sd">            res=bits.getAnalog()</span>
<span class="sd">            print(res.[&#39;IRBox&#39;])</span>
<span class="sd">            </span>
<span class="sd">        will poll the status display the values of the  IR box buttons </span>
<span class="sd">        in the first status entry returned.</span>
<span class="sd">        </span>
<span class="sd">        Note that the firmware in Bits# units varies over time and some </span>
<span class="sd">        features of this class may not work for all firmware versions. </span>
<span class="sd">        Also Bits# units can be configured in various ways via their </span>
<span class="sd">        config.xml file so this class makes certain assumptions about the</span>
<span class="sd">        configuration. In particular it is assumed that all digital inputs,</span>
<span class="sd">        triggers and analog inputs are reported as part of status</span>
<span class="sd">        updates. If some of these report are disabled in your config.xml file </span>
<span class="sd">        then &#39;status&#39; and &#39;event&#39; commands in this class may not work.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getStatus</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;IRBox&#39;</span><span class="p">:</span><span class="n">value</span><span class="o">.</span><span class="n">IR</span><span class="p">,</span><span class="s1">&#39;time&#39;</span><span class="p">:</span><span class="n">value</span><span class="o">.</span><span class="n">time</span><span class="p">}</span></div>


    <span class="c1">#=============================================================#</span>
    <span class="c1">#    Helper functions for the main status functions.          #</span>
    <span class="c1">#    Not normally needed by the user.                         #</span>
    <span class="c1">#=============================================================#</span>

    <span class="k">def</span> <span class="nf">_statusEnable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sets the Bits# to continuously send back its status until stopped.</span>
<span class="sd">        You get a lot a data by leaving this going.</span>
<span class="sd">        </span>
<span class="sd">        Not normally needed by user</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">RTBoxEnabled</span><span class="p">:</span>
            <span class="n">warning</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Cannot use status log when RTBox is on &quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="n">warning</span><span class="p">)</span>
        <span class="c1"># send start message to CRS device</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;$Start</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statusEnabled</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_statusDisable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Stop Bits# from recording data - and clears the buffer</span>
<span class="sd">        </span>
<span class="sd">        Not normally needed by user</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># send stop message to CRS device</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;$Stop</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statusEnabled</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_statusLog</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">args</span><span class="o">=</span><span class="mi">60</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Should not normally be called by user</span>
<span class="sd">        Called in its own thread via self.startStatusLog()</span>
<span class="sd">        Reads the status reports from the Bits# for default 60 seconds or</span>
<span class="sd">        until self.stopStatusLog() is called.</span>
<span class="sd">        Ignores the last line as this is can be bogus. </span>
<span class="sd">        Note any non status reports are found on the buffer will </span>
<span class="sd">        cause an error.</span>
<span class="sd">        </span>
<span class="sd">        args specifies the time over which to record status events.</span>
<span class="sd">        The minimum time is 10ms, less than this results in recording stopping after </span>
<span class="sd">        about 1 status report has been read.</span>
<span class="sd">        </span>
<span class="sd">        Puts its results into a Queue.</span>
<span class="sd">        </span>
<span class="sd">        This function is normally run in its own thread so actions can be asynchronous.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">t</span> <span class="o">=</span> <span class="n">args</span>   <span class="c1"># Get the time to run for</span>
        <span class="k">if</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="mf">0.01</span><span class="p">:</span> <span class="c1"># But if very short treat as a 1-shot read.</span>
            <span class="n">oneshot</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">t</span> <span class="o">=</span> <span class="mf">0.01</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">oneshot</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">sT</span><span class="o">=</span><span class="n">clock</span><span class="p">()</span> <span class="c1"># start time</span>
        <span class="n">msg</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
        <span class="c1"># Continue reading data until sample time is up or status.End is set</span>
        <span class="c1"># Note when used in thread statusEnd can be set from outside this function.</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">clock</span><span class="p">()</span> <span class="o">-</span> <span class="n">sT</span> <span class="o">&lt;</span> <span class="n">t</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">statusEnd</span> <span class="o">==</span> <span class="kc">False</span><span class="p">):</span>
            <span class="n">smsg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="c1"># Compile message strings</span>
            <span class="k">if</span> <span class="n">smsg</span><span class="p">:</span>
                <span class="n">msg</span><span class="o">=</span><span class="n">msg</span> <span class="o">+</span> <span class="n">smsg</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
            <span class="c1"># Stop if we have 1 whole status string in one shot mode</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_statusSize</span> <span class="ow">and</span> <span class="n">oneshot</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">statusEnd</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># Send stop signal to CRS device to shut it up.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_statusDisable</span><span class="p">()</span> <span class="c1"># Send stop signal to CRS device to shut it up.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statusEnd</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># Confirm that data logging has ended.</span>
        <span class="k">if</span> <span class="n">msg</span><span class="p">:</span> <span class="c1"># If we actually have a message</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">)</span> <span class="c1"># Split message into status lines marked by CR</span>
            <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> 
            <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">status</span><span class="p">()</span> <span class="k">for</span>  <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span> <span class="c1"># ignore last line as likely to be error</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span> <span class="c1"># for each status line</span>
                <span class="n">v</span><span class="o">=</span><span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span> <span class="c1"># split line into component parts marked by ;</span>
                <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;#sample&#39;</span><span class="p">:</span> <span class="c1"># Check we have read a status line</span>
                    <span class="c1"># Now strip out status values into a structure.</span>
                    <span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">sample</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                    <span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                    <span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">trigIn</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
                    <span class="n">dword</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span> <span class="c1">#10 digital inputs</span>
                        <span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">DIN</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">4</span><span class="o">+</span><span class="n">j</span><span class="p">]))</span>
                        <span class="n">dword</span><span class="o">=</span><span class="n">dword</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">j</span><span class="p">)</span> <span class="o">*</span> <span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">DIN</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                    <span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">DWORD</span> <span class="o">=</span> <span class="n">dword</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span> <span class="c1"># 6 IR buttons</span>
                        <span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">IR</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">14</span><span class="o">+</span><span class="n">j</span><span class="p">]))</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span> <span class="c1"># 6 Analog inputs</span>
                        <span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">ADC</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">20</span><span class="o">+</span><span class="n">j</span><span class="p">])</span>
                    <span class="c1"># Put the structure onto the cue.</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">statusQ</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;$touch&#39;</span><span class="p">:</span> <span class="c1"># We&#39;ve read a screen touch event by mistake.</span>
                    <span class="n">warning</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;_statusLog found touch&quot;</span> 
                            <span class="s2">&quot; data on input so skipping that&quot;</span><span class="p">)</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">warning</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span> <span class="c1"># We&#39;ve read something we can&#39;t interpret.</span>
                    <span class="n">warning</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;_statusLog found unknown data&quot;</span>
                            <span class="s2">&quot; on input so skipping that&quot;</span><span class="p">)</span>



    <span class="k">def</span> <span class="nf">_getStatusLog</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Read the log Queue</span>
<span class="sd">        </span>
<span class="sd">        Should not be needed by user if start/stopStatusLog or pollStatus </span>
<span class="sd">        are used.</span>
<span class="sd">        </span>
<span class="sd">        fills statusValues with a list of dictionary like objects with the following </span>
<span class="sd">        entries:</span>
<span class="sd">        sample, time, trigIn, DIN[10], DWORD, IR[6], ADC[6]</span>
<span class="sd">        </span>
<span class="sd">        They can be accessed as statusValues[i][&#39;sample&#39;] </span>
<span class="sd">        or statusValues[i].sample, statusValues[i].ADC[j]</span>
<span class="sd">        </span>
<span class="sd">        Also sets status_nValues to the number of values recorded.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">statusQ</span><span class="o">.</span><span class="n">empty</span><span class="p">()):</span>
            <span class="c1"># emply statusValues of correct size</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">statusValues</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">status</span><span class="p">()</span> <span class="k">for</span>  <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">statusQ</span><span class="o">.</span><span class="n">qsize</span><span class="p">())]</span>
            <span class="c1"># Take the status values off the queue</span>
            <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">statusQ</span><span class="o">.</span><span class="n">qsize</span><span class="p">()):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">statusValues</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">statusQ</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status_nValues</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">statusValues</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status_nValues</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">_extractStatusEvents</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> 
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Interprets values from status log to pullout any events.</span>
<span class="sd">        </span>
<span class="sd">        Should not be needed by user if start/stopStatusLog or </span>
<span class="sd">        pollStatus are used</span>
<span class="sd">        </span>
<span class="sd">        Fills statusEvents with a list of dictionary like objects with the following entries</span>
<span class="sd">        source, input, direction, time.</span>
<span class="sd">        </span>
<span class="sd">        source = the general source of the event - e.g. DIN for </span>
<span class="sd">        Digital input, IR for IT response box</span>
<span class="sd">        </span>
<span class="sd">        input = the individual input in the source.</span>
<span class="sd">        direction = &#39;up&#39; or &#39;down&#39;</span>
<span class="sd">        time = time stamp.</span>
<span class="sd">        </span>
<span class="sd">        Events are recorded relative to the four event flags</span>
<span class="sd">            statusDINBase, initial values for ditgial ins.</span>
<span class="sd">            statusIRBase, initial values for CB6 IR box.</span>
<span class="sd">            statusTrigInBase, initial values for TrigIn.</span>
<span class="sd">            statusMode, direction(s) of events to be reported.</span>
<span class="sd">        </span>
<span class="sd">        The data can be accessed as statusEvents[i][&#39;time&#39;] or statusEvents[i].time</span>
<span class="sd">        </span>
<span class="sd">        Also set status._nEvents to the number of events recorded</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">DIN_baseAll</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">10</span>
        <span class="n">IR_baseAll</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">6</span>
        <span class="n">ADC_baseAll</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">statusADCBase</span><span class="p">]</span><span class="o">*</span><span class="mi">6</span>
        <span class="c1"># Interpret statusDINBase and statusIRBase statusADCBase into lists.</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="n">i</span>
            <span class="k">if</span> <span class="n">mask</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">statusDINBase</span><span class="p">:</span>
                <span class="n">DIN_baseAll</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="n">i</span>
            <span class="k">if</span> <span class="n">mask</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">statusIRBase</span><span class="p">:</span>
                <span class="n">IR_baseAll</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
       
        <span class="n">Trig_base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">statusTrigInBase</span>
        <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">statusValues</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">statusEvents</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">nEvents</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
            <span class="n">DIN</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">statusValues</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">DIN</span> 
            <span class="n">IR</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">statusValues</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">IR</span>
            <span class="n">Trig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">statusValues</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">trigIn</span>
            <span class="n">ADC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">statusValues</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">ADC</span>
            <span class="c1"># For 10 digital inputs</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
                <span class="c1"># Has input changed high to low and is that direction being recorded?</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">DIN</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">DIN_baseAll</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span> 
                    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;down&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">statusMode</span>
                        <span class="ow">or</span> <span class="s1">&#39;Down&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">statusMode</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">statusEvents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event</span><span class="p">())</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">statusEvents</span><span class="p">[</span><span class="n">nEvents</span><span class="p">]</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="s1">&#39;DIN&#39;</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">statusEvents</span><span class="p">[</span><span class="n">nEvents</span><span class="p">]</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span> <span class="n">j</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">statusEvents</span><span class="p">[</span><span class="n">nEvents</span><span class="p">]</span><span class="o">.</span><span class="n">dir</span> <span class="o">=</span> <span class="s1">&#39;down&#39;</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">statusEvents</span><span class="p">[</span><span class="n">nEvents</span><span class="p">]</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">statusValues</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">time</span>
                        <span class="n">nEvents</span> <span class="o">=</span> <span class="n">nEvents</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="n">DIN_baseAll</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Set to the current input state</span>
                <span class="c1"># Has input changed low to high and is that direction being recorded?</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">DIN</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">DIN_baseAll</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;up&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">statusMode</span>
                        <span class="ow">or</span> <span class="s1">&#39;Up&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">statusMode</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">statusEvents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event</span><span class="p">())</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">statusEvents</span><span class="p">[</span><span class="n">nEvents</span><span class="p">]</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="s1">&#39;DIN&#39;</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">statusEvents</span><span class="p">[</span><span class="n">nEvents</span><span class="p">]</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span> <span class="n">j</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">statusEvents</span><span class="p">[</span><span class="n">nEvents</span><span class="p">]</span><span class="o">.</span><span class="n">dir</span> <span class="o">=</span> <span class="s1">&#39;up&#39;</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">statusEvents</span><span class="p">[</span><span class="n">nEvents</span><span class="p">]</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">statusValues</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">time</span>
                        <span class="n">nEvents</span> <span class="o">=</span> <span class="n">nEvents</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="n">DIN_baseAll</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># Set to the current input state</span>
                    
            <span class="c1"># For 6 IR buttons</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
                <span class="c1"># Has button changed high to low and is that direction being recorded?</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">IR</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">IR_baseAll</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;down&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">statusMode</span>
                        <span class="ow">or</span> <span class="s1">&#39;Down&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">statusMode</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">statusEvents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event</span><span class="p">())</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">statusEvents</span><span class="p">[</span><span class="n">nEvents</span><span class="p">]</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="s1">&#39;IR&#39;</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">statusEvents</span><span class="p">[</span><span class="n">nEvents</span><span class="p">]</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span> <span class="n">j</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">statusEvents</span><span class="p">[</span><span class="n">nEvents</span><span class="p">]</span><span class="o">.</span><span class="n">dir</span> <span class="o">=</span> <span class="s1">&#39;down&#39;</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">statusEvents</span><span class="p">[</span><span class="n">nEvents</span><span class="p">]</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">statusValues</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">time</span>
                        <span class="n">nEvents</span> <span class="o">=</span> <span class="n">nEvents</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="n">IR_baseAll</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># Set to the current input state</span>
                    
                <span class="c1"># Has button changed low to high and is that direction being recorded?</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">IR</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">IR_baseAll</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;up&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">statusMode</span>
                        <span class="ow">or</span> <span class="s1">&#39;Up&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">statusMode</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">statusEvents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event</span><span class="p">())</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">statusEvents</span><span class="p">[</span><span class="n">nEvents</span><span class="p">]</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="s1">&#39;IR&#39;</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">statusEvents</span><span class="p">[</span><span class="n">nEvents</span><span class="p">]</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span> <span class="n">j</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">statusEvents</span><span class="p">[</span><span class="n">nEvents</span><span class="p">]</span><span class="o">.</span><span class="n">dir</span> <span class="o">=</span> <span class="s1">&#39;up&#39;</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">statusEvents</span><span class="p">[</span><span class="n">nEvents</span><span class="p">]</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">statusValues</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">time</span>
                        <span class="n">nEvents</span> <span class="o">=</span> <span class="n">nEvents</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="n">IR_baseAll</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># Set to the current input state</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
                <span class="c1"># Has analog input changed high to low and is that direction being recorded?</span>
                <span class="k">if</span> <span class="n">ADC_baseAll</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">ADC</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">statusThreshold</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;down&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">statusMode</span>
                        <span class="ow">or</span> <span class="s1">&#39;Down&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">statusMode</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">statusEvents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event</span><span class="p">())</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">statusEvents</span><span class="p">[</span><span class="n">nEvents</span><span class="p">]</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="s1">&#39;ADC&#39;</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">statusEvents</span><span class="p">[</span><span class="n">nEvents</span><span class="p">]</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span> <span class="n">j</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">statusEvents</span><span class="p">[</span><span class="n">nEvents</span><span class="p">]</span><span class="o">.</span><span class="n">dir</span> <span class="o">=</span> <span class="s1">&#39;down&#39;</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">statusEvents</span><span class="p">[</span><span class="n">nEvents</span><span class="p">]</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">statusValues</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">time</span>
                        <span class="n">nEvents</span> <span class="o">=</span> <span class="n">nEvents</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="n">ADC_baseAll</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">ADC</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                    
                <span class="c1"># Has analog input changed low to high and is that direction being recorded?</span>
                <span class="k">if</span> <span class="n">ADC</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">ADC_baseAll</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>  <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">statusThreshold</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;up&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">statusMode</span>
                        <span class="ow">or</span> <span class="s1">&#39;Up&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">statusMode</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">statusEvents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event</span><span class="p">())</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">statusEvents</span><span class="p">[</span><span class="n">nEvents</span><span class="p">]</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="s1">&#39;ADC&#39;</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">statusEvents</span><span class="p">[</span><span class="n">nEvents</span><span class="p">]</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span> <span class="n">j</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">statusEvents</span><span class="p">[</span><span class="n">nEvents</span><span class="p">]</span><span class="o">.</span><span class="n">dir</span> <span class="o">=</span> <span class="s1">&#39;up&#39;</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">statusEvents</span><span class="p">[</span><span class="n">nEvents</span><span class="p">]</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">statusValues</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">time</span>
                        <span class="n">nEvents</span> <span class="o">=</span> <span class="n">nEvents</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="n">ADC_baseAll</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">ADC</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                    
            <span class="c1"># Has trigger changed high to low and is that direction being recorded?</span>
            <span class="k">if</span> <span class="n">Trig</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">Trig_base</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;down&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">statusMode</span>
                    <span class="ow">or</span> <span class="s1">&#39;Down&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">statusMode</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">statusEvents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event</span><span class="p">())</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">statusEvents</span><span class="p">[</span><span class="n">nEvents</span><span class="p">]</span><span class="o">.</span><span class="n">source</span><span class="o">=</span><span class="s1">&#39;Trigger&#39;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">statusEvents</span><span class="p">[</span><span class="n">nEvents</span><span class="p">]</span><span class="o">.</span><span class="n">input</span><span class="o">=</span><span class="mi">0</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">statusEvents</span><span class="p">[</span><span class="n">nEvents</span><span class="p">]</span><span class="o">.</span><span class="n">dir</span><span class="o">=</span><span class="s1">&#39;down&#39;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">statusEvents</span><span class="p">[</span><span class="n">nEvents</span><span class="p">]</span><span class="o">.</span><span class="n">time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">statusValues</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">time</span>
                    <span class="n">nEvents</span><span class="o">=</span><span class="n">nEvents</span><span class="o">+</span><span class="mi">1</span>
                <span class="n">Trig_base</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># Set to the current input state</span>
                
            <span class="c1"># Has trigger changed low to high and is that direction being recorded?</span>
            <span class="k">if</span> <span class="n">Trig</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">Trig_base</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;up&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">statusMode</span>
                    <span class="ow">or</span> <span class="s1">&#39;Up&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">statusMode</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">statusEvents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event</span><span class="p">())</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">statusEvents</span><span class="p">[</span><span class="n">nEvents</span><span class="p">]</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="s1">&#39;Trigger&#39;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">statusEvents</span><span class="p">[</span><span class="n">nEvents</span><span class="p">]</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">statusEvents</span><span class="p">[</span><span class="n">nEvents</span><span class="p">]</span><span class="o">.</span><span class="n">dir</span> <span class="o">=</span> <span class="s1">&#39;up&#39;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">statusEvents</span><span class="p">[</span><span class="n">nEvents</span><span class="p">]</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">statusValues</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">time</span>
                    <span class="n">nEvents</span> <span class="o">=</span> <span class="n">nEvents</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">Trig_base</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># Set to the current input state</span>
                
        <span class="bp">self</span><span class="o">.</span><span class="n">status_nEvents</span><span class="o">=</span><span class="n">nEvents</span>



    <span class="c1">#=======================#</span>
    <span class="c1">#   Other functions     #</span>
    <span class="c1">#=======================#</span>

    <span class="c1"># TO DO: The following are either not yet implemented (or not tested)</span>
<div class="viewcode-block" id="BitsSharp.start">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.BitsSharp.start">[docs]</a>
    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;[Not currently implemented] Used to begin event collection by</span>
<span class="sd">        the device.</span>
<span class="sd">        </span>
<span class="sd">        Not really needed as other members now do this.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>


<div class="viewcode-block" id="BitsSharp.stop">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.BitsSharp.stop">[docs]</a>
    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;[Not currently implemented] Used to stop event collection by</span>
<span class="sd">        the device.</span>
<span class="sd">        </span>
<span class="sd">        Not really needed as other members now do this.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>


<div class="viewcode-block" id="BitsSharp.checkConfig">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.BitsSharp.checkConfig">[docs]</a>
    <span class="k">def</span> <span class="nf">checkConfig</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">demoMode</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">logFile</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Checks whether there is a configuration for this device and</span>
<span class="sd">        whether it&#39;s correct</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        level: integer</span>

<span class="sd">            - 0: do nothing</span>
<span class="sd">            - 1: check that we have a config file and that the graphics</span>
<span class="sd">                card and operating system match that specified in the</span>
<span class="sd">                file. Then assume identity LUT is correct</span>
<span class="sd">            - 2: switch the box to status mode and check that the</span>
<span class="sd">                identity LUT is currently working</span>
<span class="sd">            - 3: force a fresh search for the identity LUT</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">noComms</span><span class="p">:</span>
            <span class="n">demoMode</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">prevMode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span>
        <span class="c1"># if we haven&#39;t fetched a config yet then do so</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="c1"># check that this matches the prev config for our graphics card etc</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># until we find otherwise</span>
        <span class="k">if</span> <span class="n">level</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">quickCheck</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">:</span>
                <span class="c1"># didn&#39;t match our graphics card or OS</span>
                <span class="n">level</span> <span class="o">=</span> <span class="mi">2</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_warnTesting</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">prevMode</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">win</span><span class="o">.</span><span class="n">gammaRamp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">identityLUT</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Bits# config matches current system: </span><span class="si">%s</span><span class="s2"> on </span><span class="si">%s</span><span class="s2">&quot;</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">gfxCard</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">os</span><span class="p">))</span>
                <span class="k">return</span> <span class="mi">1</span>
        <span class="c1"># it didn&#39;t so switch to doing the test</span>
        <span class="k">if</span> <span class="n">level</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">errs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">testLUT</span><span class="p">(</span><span class="n">demoMode</span><span class="o">=</span><span class="n">demoMode</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">demoMode</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">errs</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">level</span> <span class="o">=</span> <span class="mi">3</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;The current LUT didn&#39;t work as identity. &quot;</span>
                             <span class="s2">&quot;We&#39;ll try to find a working one.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">identityLUT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">win</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">getGammaRamp</span><span class="p">()</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">prevMode</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;We found a LUT and it worked as identity&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">level</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">findIdentityLUT</span><span class="p">(</span><span class="n">demoMode</span><span class="o">=</span><span class="n">demoMode</span><span class="p">,</span>
                                             <span class="n">logFile</span><span class="o">=</span><span class="n">logFile</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">prevMode</span>
        <span class="k">return</span> <span class="n">ok</span></div>


    <span class="k">def</span> <span class="nf">_warnTesting</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;We need to run some tests on your graphics card (hopefully &quot;</span>
               <span class="s2">&quot;just once).</span><span class="se">\n</span><span class="s2">The BitsSharp will go into status mode while &quot;</span>
               <span class="s2">&quot;this is done.</span><span class="se">\n</span><span class="s2">It can take a minute or two...&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">msgOnScreen</span> <span class="o">=</span> <span class="n">visual</span><span class="o">.</span><span class="n">TextStim</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">win</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
        <span class="n">msgOnScreen</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">win</span><span class="o">.</span><span class="n">flip</span><span class="p">()</span>
        <span class="n">core</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">win</span><span class="o">.</span><span class="n">flip</span><span class="p">()</span>

    <span class="c1"># properties that need a weak ref to avoid circular references</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">win</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The window that this box is attached to</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;win&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;win&#39;</span><span class="p">)()</span>

    <span class="nd">@win</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">win</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">win</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;win&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">win</span><span class="p">)</span></div>


<div class="viewcode-block" id="DisplayPlusPlus">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.DisplayPlusPlus">[docs]</a>
<span class="k">class</span> <span class="nc">DisplayPlusPlus</span><span class="p">(</span><span class="n">BitsSharp</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A Display++ is Bits# box inside and LCD monitor so this class</span>
<span class="sd">       is just a wrapper that reminds people with a Display++ that</span>
<span class="sd">       they are using it. However unlike the Bits# you may not </span>
<span class="sd">       have any analog connections on a Display++ unless you </span>
<span class="sd">       purchased that option.</span>
<span class="sd">       </span>
<span class="sd">       Everything in the Bits# class should work but any </span>
<span class="sd">       analog values sent or read will be spurious unless you</span>
<span class="sd">       have the analog hardware installed.</span>
<span class="sd">       </span>
<span class="sd">        Note that the firmware in Display++ units varies over time and some </span>
<span class="sd">        features of this class may not work for all firmware versions. </span>
<span class="sd">        Also Display++ units can be configured in various ways via their </span>
<span class="sd">        config.xml file so this class makes certain assumptions about the</span>
<span class="sd">        configuration. In particualar it is assumed that all digital inputs,</span>
<span class="sd">        triggers and analog inputs are reported as part of status</span>
<span class="sd">        updates. If some of these report are disabled in your config.xml file </span>
<span class="sd">        then &#39;status&#39; and &#39;event&#39; commands in this class may not work.</span>
<span class="sd">        </span>
<span class="sd">        RTBox commands that reset the key mapping have been found not to work</span>
<span class="sd">        one some firmware.</span>
<span class="sd">    &quot;&quot;&quot;</span>
       
    <span class="n">name</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;CRS Display++&#39;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">win</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                         <span class="n">portName</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                         <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> 
                         <span class="n">checkConfigLevel</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                         <span class="n">gammaCorrect</span> <span class="o">=</span> <span class="s1">&#39;hardware&#39;</span><span class="p">,</span>
                         <span class="n">gamma</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                         <span class="n">noComms</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DisplayPlusPlus</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">win</span><span class="p">,</span> <span class="n">portName</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">checkConfigLevel</span><span class="p">,</span>
                 <span class="n">gammaCorrect</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span>
                 <span class="n">noComms</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DisplayPlusPlus</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__del__</span><span class="p">()</span></div>




<div class="viewcode-block" id="DisplayPlusPlusTouch">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.DisplayPlusPlusTouch">[docs]</a>
<span class="k">class</span> <span class="nc">DisplayPlusPlusTouch</span><span class="p">(</span><span class="n">DisplayPlusPlus</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A Display++ is Bits# box inside and LCD monitor but its </span>
<span class="sd">       also possible to add a touch screen option to Display++ </span>
<span class="sd">       and this class will give access to that.</span>
<span class="sd">       </span>
<span class="sd">       Otherwise this class is just a wrapper to the Bits# class.</span>
<span class="sd">       However unlike the Bits# you may not have any analog</span>
<span class="sd">       connections on a Display++ unless you purchased that option.</span>
<span class="sd">       </span>
<span class="sd">       Everything in the Bits# class should work but any </span>
<span class="sd">       analog values sent or read will be spurious unless you</span>
<span class="sd">       have the analog hardware installed.</span>
<span class="sd">       </span>
<span class="sd">        Note that the firmware in Display++ units varies over time and some </span>
<span class="sd">        features of this class may not work for all firmware versions. </span>
<span class="sd">        Also Display++ units can be configured in various ways via their </span>
<span class="sd">        config.xml file so this class makes certain assumptions about the</span>
<span class="sd">        configuration. In particular it is assumed that all digital inputs,</span>
<span class="sd">        triggers and analog inputs are reported as part of status</span>
<span class="sd">        updates. If some of these report are disabled in your config.xml file </span>
<span class="sd">        then &#39;status&#39; and &#39;event&#39; commands in this class may not work.</span>
<span class="sd">        </span>
<span class="sd">        RTBox commands that reset the key mapping have been found not to work</span>
<span class="sd">        one some firmware.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">name</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;CRS Display++Touch&#39;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">win</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                         <span class="n">portName</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                         <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> 
                         <span class="n">checkConfigLevel</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                         <span class="n">gammaCorrect</span> <span class="o">=</span> <span class="s1">&#39;hardware&#39;</span><span class="p">,</span>
                         <span class="n">gamma</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                         <span class="n">noComms</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DisplayPlusPlusTouch</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">win</span><span class="p">,</span> <span class="n">portName</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> 
                                                <span class="n">checkConfigLevel</span><span class="p">,</span>
                                                <span class="n">gammaCorrect</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span>
                                                <span class="n">noComms</span><span class="p">)</span>
       
       <span class="c1"># Members for controlling touch screen</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">touchEnabled</span> <span class="o">=</span> <span class="kc">False</span>   <span class="c1"># Used to keep track of touch screen enables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">touchLogEnd</span> <span class="o">=</span> <span class="kc">False</span>    <span class="c1"># used to kill the touch logging thread.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lastTouch</span> <span class="o">=</span> <span class="s1">&#39;released&#39;</span> <span class="c1"># Used to detect a possible error </span>
                                        <span class="c1"># in the touch screen hardware.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">touchFirstTime</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># Used to detect a possible error </span>
                                        <span class="c1">#in the touch screen hardware.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">touchDistance</span> <span class="o">=</span> <span class="mi">10</span>     <span class="c1"># Used to screen out events that are </span>
                                        <span class="c1">#too close together.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">touchTime</span> <span class="o">=</span> <span class="mf">0.1</span>        <span class="c1"># Used to screen out events that are </span>
                                        <span class="c1">#too close in time.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">touchType</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;touched&#39;</span><span class="p">,</span> <span class="s1">&#39;released&#39;</span><span class="p">]</span> <span class="c1"># Used to screen in events</span>
                                        <span class="c1">#in forming the touch event list.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkTime</span> <span class="o">=</span> <span class="mf">0.25</span>       <span class="c1"># Used to screen out an error </span>
                                        <span class="c1">#in the touch screen hardware</span>
                                        
        <span class="bp">self</span><span class="o">.</span><span class="n">_touchSize</span> <span class="o">=</span> <span class="mi">31</span>        <span class="c1"># Number of bytes returned by touch </span>
                                        <span class="c1"># screen when pressed.</span>
        
       <span class="c1"># Data members for touch screen</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">touch_nValues</span><span class="o">=</span><span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">touch_nEvents</span><span class="o">=</span><span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">touchValues</span><span class="o">=</span><span class="p">[]</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">touchEvents</span><span class="o">=</span><span class="p">[]</span>
        <span class="c1"># Set up a queue in which to store touch screen events.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">touchQ</span> <span class="o">=</span> <span class="n">Queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">(</span><span class="mi">70000</span><span class="p">)</span> 

    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DisplayPlusPlusTouch</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__del__</span><span class="p">()</span>


<div class="viewcode-block" id="DisplayPlusPlusTouch.RTBoxEnable">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.DisplayPlusPlusTouch.RTBoxEnable">[docs]</a>
    <span class="k">def</span> <span class="nf">RTBoxEnable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;CB6&#39;</span><span class="p">,</span><span class="s1">&#39;Down&#39;</span><span class="p">,</span><span class="s1">&#39;Trigger&#39;</span><span class="p">),</span> <span class="nb">map</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Overaload RTBoxEnable for Display++ with touch screen.</span>
<span class="sd">        Sets up the RTBox with preset or bespoke mappings </span>
<span class="sd">        and enables event detection.</span>
<span class="sd">        </span>
<span class="sd">        RTBox events can be mapped to a number of physical events on Bits#</span>
<span class="sd">        They can be mapped to digital input lines, tigers and</span>
<span class="sd">        CB6 IR input channels.</span>
<span class="sd">        </span>
<span class="sd">        Mode is a list of strings.</span>
<span class="sd">        Preset mappings  provided via mode:</span>
<span class="sd">            CB6 for the CRS CB6 IR response box.</span>
<span class="sd">            IO for a three button box connected to Din0-2</span>
<span class="sd">            IO6 for a six button box connected to Din0-5</span>
<span class="sd">            </span>
<span class="sd">        If mode = None or is not set then the value of self.RTBoxMode is used.</span>

<span class="sd">        Bespoke Mappings over write preset ones.</span>
<span class="sd">        </span>
<span class="sd">        The format for map is a list of tuples with each tuple </span>
<span class="sd">        containing the name of the </span>
<span class="sd">        RT Box button to be mapped and its source </span>
<span class="sd">        eg (&#39;btn1&#39;,&#39;Din0&#39;) maps physical input Din0 to </span>
<span class="sd">        logical button btn1. </span>
<span class="sd">        </span>
<span class="sd">        Note the lowest number button event is Btn1</span>
<span class="sd">        </span>
<span class="sd">        RTBox has four logical buttons (btn1-4) and </span>
<span class="sd">        three auxiliary events (light, pulse and trigger)</span>
<span class="sd">        Buttons/events can be mapped to multiple physical</span>
<span class="sd">        inputs and stay mapped until reset.</span>
<span class="sd">        </span>
<span class="sd">        Mode is a list of string or list of strings that contains </span>
<span class="sd">        keywords to determine present mappings and modes for RTBox.</span>
<span class="sd">        </span>
<span class="sd">        If mode includes &#39;Down&#39; button events will be </span>
<span class="sd">        detected when pressed.</span>
<span class="sd">        If mode includes &#39;Up&#39; button events will be </span>
<span class="sd">        detected when released.</span>
<span class="sd">        You can detect both types of event but note </span>
<span class="sd">        that pulse, light and trigger events</span>
<span class="sd">        dont have an &#39;Up&#39; mode.</span>
<span class="sd">        </span>
<span class="sd">        If Trigger is included in mode the trigger </span>
<span class="sd">            event will be mapped to the trigIn connector.</span>
<span class="sd">            </span>
<span class="sd">        Example: </span>
<span class="sd">            bits.RTBoxEnable(mode = &#39;Down&#39;), map = [(&#39;btn1&#39;,&#39;Din0&#39;), (&#39;btn2&#39;,&#39;Din1&#39;)]</span>
<span class="sd">            </span>
<span class="sd">        enable the RTBox emulation to detect Down events on buttons 1 and 2 where they are</span>
<span class="sd">        mapped to DIN0 and DIN1.</span>
<span class="sd">        </span>
<span class="sd">        Example: </span>
<span class="sd">            bits.RTBoxEnable(mode = [&#39;Down&#39;,&#39;CB6&#39;])</span>
<span class="sd">        </span>
<span class="sd">        enable the RTBox emulation to detect Down events on the standard CB6 IR response box keys.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">touchEnabled</span><span class="p">:</span>
            <span class="n">warning</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Cannot use RTBox when touch screen is on&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="n">warning</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">tuple</span><span class="p">:</span>
                <span class="n">mode</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">DisplayPlusPlusTouch</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">RTBoxEnable</span><span class="p">(</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">,</span> <span class="nb">map</span> <span class="o">=</span> <span class="nb">map</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="DisplayPlusPlusTouch.statusBoxEnable">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.DisplayPlusPlusTouch.statusBoxEnable">[docs]</a>
    <span class="k">def</span> <span class="nf">statusBoxEnable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">map</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">threshold</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Sets up the statusBox with preset or bespoke mappings </span>
<span class="sd">        and enables event detection.</span>
<span class="sd">        </span>
<span class="sd">        stautsBox events can be mapped to a number of physical events on Bits#</span>
<span class="sd">        They can be mapped to digital input lines, tigers and</span>
<span class="sd">        CB6 IR input channels.</span>
<span class="sd">        </span>
<span class="sd">        Mode is a list of strings.</span>
<span class="sd">        Preset mappings  provided via mode:</span>
<span class="sd">            CB6 for the CRS CB6 IR response box connected mapped to btn1-6</span>
<span class="sd">            IO for a three button box connected to Din0-2 mapped to btn1-3</span>
<span class="sd">            IO6 for a six button box connected to Din0-5 mapped to btn1-6</span>
<span class="sd">            IO10 for a ten button box connected to Din0-9 mapped to btn1-10</span>
<span class="sd">            Trigger maps the trigIn to btn17</span>
<span class="sd">            </span>
<span class="sd">            if CB6 and IOx are used the Dins are mapped from btn7 onwards.</span>
<span class="sd">            </span>
<span class="sd">        If mode = None or is not set then the value of self.statusBoxMode is used.</span>

<span class="sd">        Bespoke Mappings over write preset ones.</span>
<span class="sd">        </span>
<span class="sd">        The format for map is a list of tuples with each tuple </span>
<span class="sd">        containing the name of the </span>
<span class="sd">         button to be mapped and its source </span>
<span class="sd">        eg (&#39;btn1&#39;,&#39;Din0&#39;) maps physical input Din0 to </span>
<span class="sd">        logical button btn1. </span>
<span class="sd">        </span>
<span class="sd">        Note the lowest number button event is Btn1</span>
<span class="sd">        </span>
<span class="sd">        statusBox has 17 logical buttons (btn1-17).</span>
<span class="sd">        Buttons/events can be mapped to multiple physical</span>
<span class="sd">        inputs and stay mapped until reset.</span>
<span class="sd">        </span>
<span class="sd">        Mode is a string or list of strings that contains </span>
<span class="sd">        keywords to determine present mappings and modes for statusBox.</span>
<span class="sd">        </span>
<span class="sd">        If mode includes &#39;Down&#39; button events will be </span>
<span class="sd">        detected when pressed.</span>
<span class="sd">        If mode includes &#39;Up&#39; button events will be </span>
<span class="sd">        detected when released.</span>
<span class="sd">        You can detect both types of event noting that the event detector</span>
<span class="sd">        will look for transitions and ignorewhat it sees as the starting state.</span>
<span class="sd">        </span>

<span class="sd">            </span>
<span class="sd">        Example: </span>
<span class="sd">            bits.statusBoxEnable(mode = &#39;Down&#39;), map = [(&#39;btn1&#39;,&#39;Din0&#39;), (&#39;btn2&#39;,&#39;Din1&#39;)]</span>
<span class="sd">            </span>
<span class="sd">        enable the stautsBox to detect Down events on buttons 1 and 2 where they are</span>
<span class="sd">        mapped to DIN0 and DIN1.</span>
<span class="sd">        </span>
<span class="sd">        Example: </span>
<span class="sd">            bits.statusBoxEnable(mode = [&#39;Down&#39;,&#39;CB6&#39;])</span>
<span class="sd">        </span>
<span class="sd">        enable the statusBox emulation to detect Down events on the standard CB6 IR response box keys.</span>
<span class="sd">        </span>
<span class="sd">        Note that the firmware in Display++ units varies over time and some </span>
<span class="sd">        features of this class may not work for all firmware versions. </span>
<span class="sd">        Also Display++ units can be configured in various ways via their </span>
<span class="sd">        config.xml file so this class makes certain assumptions about the</span>
<span class="sd">        configuration. In particular it is assumed that all digital inputs,</span>
<span class="sd">        triggers and analog inputs are reported as part of status</span>
<span class="sd">        updates. If some of these report are disabled in your config.xml file </span>
<span class="sd">        then &#39;status&#39; and &#39;event&#39; commands in this class may not work.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">touchEnabled</span><span class="p">:</span>
            <span class="n">warning</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Cannot use status Box when touch screen is on&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="n">warning</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">DisplayPlusPlusTouch</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">statusBoxEnable</span><span class="p">(</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">,</span> <span class="nb">map</span> <span class="o">=</span> <span class="nb">map</span><span class="p">,</span> <span class="n">threshold</span> <span class="o">=</span> <span class="n">threshold</span><span class="p">)</span></div>

    
    <span class="k">def</span> <span class="nf">_statusEnable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Overaload _statusEnable for Display++ with touch screen</span>
<span class="sd">        </span>
<span class="sd">        Sets the Bits# to continuously send back its status until stopped.</span>
<span class="sd">        You get a lot a data by leaving this going.</span>
<span class="sd">        </span>
<span class="sd">        Not normally needed by user</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">touchEnabled</span><span class="p">:</span>
            <span class="n">warning</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Cannot use status log when touch screen is on&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="n">warning</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">DisplayPlusPlusTouch</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_statusEnable</span><span class="p">()</span>
        
        
    <span class="c1">#===================================================================#</span>
    <span class="c1">#    The getTouch, touchWait, and touchPressed commands work        #</span>
    <span class="c1">#    a bit like equivalent RTBox commands.                          #</span>
    <span class="c1">#                                                                   #</span>
    <span class="c1">#    They do use touch logging in a thread but only do anything if  #</span>
    <span class="c1">#    there is something useful on the serial buffer so you need     #</span>
    <span class="c1">#    to call touchEnable before and touchDisable after any call     # </span>
    <span class="c1">#    to these functions                                             #</span>
    <span class="c1">#===================================================================#</span>
    
        
<div class="viewcode-block" id="DisplayPlusPlusTouch.touchEnable">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.DisplayPlusPlusTouch.touchEnable">[docs]</a>
    <span class="k">def</span> <span class="nf">touchEnable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Turns on the touch screen. Any presses will now be reported</span>
<span class="sd">        </span>
<span class="sd">        Example:</span>
<span class="sd">            bits.touchEnable()</span>
<span class="sd">            res = bits.touchWait()</span>
<span class="sd">            bits.touchDisable()</span>
<span class="sd">            print(res.time)</span>
<span class="sd">            </span>
<span class="sd">        Enables touch screen, waits for a touch, disables touch screen </span>
<span class="sd">        and displays the timestamp of the touch.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">RTBoxEnabled</span><span class="p">:</span>
            <span class="n">warning</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Cannot use touch screen when RTBox is on&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="n">warning</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">statusBoxEnabled</span><span class="p">:</span>
            <span class="n">warning</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Cannot use touch screen when status Box is on&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="n">warning</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">statusEnabled</span><span class="p">:</span>
            <span class="n">warning</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Cannot use touch screen when status logging is on&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="n">warning</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">noComms</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="c1"># Send message to Display++ to turn on touch screen</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;$EnableTouchScreen=[ON]</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">msg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="n">msg</span><span class="o">=</span><span class="n">msg</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="c1"># Check the reply message</span>
        <span class="k">if</span> <span class="s1">&#39;ON&#39;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">touchEnabled</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;Cannot enable touch screen&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span></div>


        
<div class="viewcode-block" id="DisplayPlusPlusTouch.touchDisable">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.DisplayPlusPlusTouch.touchDisable">[docs]</a>
    <span class="k">def</span> <span class="nf">touchDisable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Turns off the touch screen.</span>
<span class="sd">                </span>
<span class="sd">        Example:</span>
<span class="sd">            bits.touchEnable()</span>
<span class="sd">            res = bits.touchWait()</span>
<span class="sd">            bits.touchDisable()</span>
<span class="sd">            print(res.time)</span>
<span class="sd">            </span>
<span class="sd">        Enables touch screen, waits for a touch, disables touch screen </span>
<span class="sd">        and displays the timestamp of the touch.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">noComms</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="c1"># Send message to Display++ to turn off the touch screen.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;$EnableTouchScreen=[OFF]</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">msg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="n">msg</span><span class="o">=</span><span class="n">msg</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="c1"># Check the reply message</span>
        <span class="k">if</span> <span class="s1">&#39;OFF&#39;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">touchEnabled</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;Cannot disable touch screen&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span></div>

        
        
<div class="viewcode-block" id="DisplayPlusPlusTouch.getTouchResponses">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.DisplayPlusPlusTouch.getTouchResponses">[docs]</a>
    <span class="k">def</span> <span class="nf">getTouchResponses</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">N</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; checks for (at least) an appropriate number of touch screen</span>
<span class="sd">        presses on the input buffer then reads them.</span>
<span class="sd">        Returns a list of dict like objects with four members</span>
<span class="sd">        &#39;x&#39;,&#39;y&#39;,&#39;dir&#39; and &#39;time&#39;</span>
<span class="sd">        &#39;x and y&#39; are the x and y coordinates pressed.</span>
<span class="sd">        &#39;dir&#39; is the direction of the event</span>
<span class="sd">                    eg &#39;touched&#39; for presses and &#39;released&#39; for releases.</span>
<span class="sd">        &#39;time&#39; is the timestamp associated with the event.</span>
<span class="sd">        these values can be read as a structure:</span>
<span class="sd">            res=getTouchResponses(3)</span>
<span class="sd">            res[0].dir, res[0].x, res[0].time</span>
<span class="sd">        or dictionary</span>
<span class="sd">            res[0][&#39;dir&#39;], res[0][&#39;x&#39;], res[0][&#39;time&#39;]</span>
<span class="sd">        </span>
<span class="sd">        Note even if only 1 response is requested the result is</span>
<span class="sd">            a 1 item long list of dict like objects.</span>
<span class="sd">        </span>
<span class="sd">        Note in theory this could be used to get multiple responses</span>
<span class="sd">            but in practice the touch screen reports every slight</span>
<span class="sd">            movements so the Logging methods, getTouchResponse </span>
<span class="sd">            or getAllTouchResponses are better.</span>
<span class="sd">        </span>
<span class="sd">        Note this function does not start touch screen</span>
<span class="sd">            recording so should only be called</span>
<span class="sd">            when there appears to be data waiting.</span>
<span class="sd">            So you need to call touchEnable() before and </span>
<span class="sd">            touchDisable after this function.</span>
<span class="sd">            </span>
<span class="sd">        Example:</span>
<span class="sd">            bits.touchEnable()</span>
<span class="sd">            while not event:</span>
<span class="sd">                # do some processing</span>
<span class="sd">                continue</span>
<span class="sd">            bits.touchDisable()</span>
<span class="sd">            res=getTouchResponses(3)</span>
<span class="sd">            print(res[0].time)</span>
<span class="sd">        </span>
<span class="sd">        Will put the touch screen into continuous reading while doing some task</span>
<span class="sd">        and at the end get the first 3 tocuhes are display the timestamp of the first one.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">noComms</span> <span class="ow">or</span> <span class="n">N</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span>  <span class="bp">self</span><span class="o">.</span><span class="n">_inWaiting</span><span class="p">()</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">N</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_touchSize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>  
            <span class="c1"># Works by calling the startTouchLog() after the event.</span>
            <span class="c1"># Will wait 0.01 seconds per response requested</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">startTouchLog</span><span class="p">(</span><span class="n">N</span><span class="o">*</span><span class="mf">0.01</span><span class="p">)</span> 
            <span class="c1"># Join the touch log thread and wait for it to finish.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">touchThread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">touchThread</span>
            <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getTouchLog</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">N</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> </div>

            
<div class="viewcode-block" id="DisplayPlusPlusTouch.getAllTouchResponses">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.DisplayPlusPlusTouch.getAllTouchResponses">[docs]</a>
    <span class="k">def</span> <span class="nf">getAllTouchResponses</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; get all the touch screen presses from the</span>
<span class="sd">        events on the input buffer then reads them.</span>
<span class="sd">        Returns a list of dict like objects with four members</span>
<span class="sd">        &#39;x&#39;,&#39;y&#39;,&#39;dir&#39; and &#39;time&#39;</span>
<span class="sd">        &#39;x and y&#39; are the x and y coordinates pressed.</span>
<span class="sd">        &#39;dir&#39; is the direction of the event</span>
<span class="sd">                    eg &#39;touched&#39; for presses and &#39;relased&#39; for releases.</span>
<span class="sd">        &#39;time&#39; is the timestamp associated with the event.</span>
<span class="sd">        these values can be read as a structure:</span>
<span class="sd">            res=getAllTouchResponses()</span>
<span class="sd">            res[0].dir, res[0].x, rest[0].time</span>
<span class="sd">        or dirctionary</span>
<span class="sd">            res[0][&#39;dir&#39;], res[0][&#39;x&#39;], res[0][&#39;time&#39;]</span>
<span class="sd">        </span>
<span class="sd">        Note even if only 1 response is requested the result is</span>
<span class="sd">            a 1 item long list of dict like objects.</span>
<span class="sd">        </span>
<span class="sd">        Note in theory this could be used to get multiple responses</span>
<span class="sd">            but in practice the touch screen reports every slight</span>
<span class="sd">            movement so the Logging methods are better.</span>
<span class="sd">        </span>
<span class="sd">        Note this function does not start touch screen</span>
<span class="sd">            recording so should only be called</span>
<span class="sd">            when there appears to be data waiting.</span>
<span class="sd">            So you need to call touchEnable() before and </span>
<span class="sd">            touchDisable after this function</span>

<span class="sd">        Example:</span>
<span class="sd">            bits.touchEnable()</span>
<span class="sd">            while not event:</span>
<span class="sd">                # do some processing</span>
<span class="sd">                continue</span>
<span class="sd">            bits.touchDisable()</span>
<span class="sd">            res=getAllTouchResponses(3)</span>
<span class="sd">            print(res[0].time)</span>
<span class="sd">        </span>
<span class="sd">        Will put the touch screen into continuous reading while doing some task</span>
<span class="sd">        and at the end get all the tocuhes are display the timestamp of the first one.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">N</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_inWaiting</span><span class="p">()</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_touchSize</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getTouchResponses</span><span class="p">(</span><span class="n">N</span><span class="p">)</span></div>

        
            
<div class="viewcode-block" id="DisplayPlusPlusTouch.getTouchResponse">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.DisplayPlusPlusTouch.getTouchResponse">[docs]</a>
    <span class="k">def</span> <span class="nf">getTouchResponse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; checks for (at least) one touch screen</span>
<span class="sd">        press on the input buffer then reads it.</span>
<span class="sd">        Returns a dict like object with four members</span>
<span class="sd">        &#39;x&#39;,&#39;y&#39;,&#39;dir&#39; and &#39;time&#39;</span>
<span class="sd">        &#39;x and y&#39; are the x and y coordinates pressed.</span>
<span class="sd">        &#39;dir&#39; is the direction of the event</span>
<span class="sd">                    eg &#39;touched&#39; for presses and &#39;relased&#39; for releases.</span>
<span class="sd">        &#39;time&#39; is the timestamp associated with the event.</span>
<span class="sd">        these values can be read as a structure:</span>
<span class="sd">            res=getTouchGetResponse()</span>
<span class="sd">            res.dir, res.x, rest.time</span>
<span class="sd">        or dirctionary</span>
<span class="sd">            res[&#39;dir&#39;], res[&#39;x&#39;], res[&#39;time&#39;]</span>
<span class="sd">        </span>
<span class="sd">        Note this function does not start touch screen</span>
<span class="sd">            recording so should only be called</span>
<span class="sd">            when there appears to be data waiting.</span>
<span class="sd">            So you need to call touchEnable() before and </span>
<span class="sd">            touchDisable after this function.</span>
<span class="sd">            </span>
<span class="sd">        Example:</span>
<span class="sd">            bits.touchEnable()</span>
<span class="sd">            while not event:</span>
<span class="sd">                # do some processing</span>
<span class="sd">                continue</span>
<span class="sd">            bits.touchDisable()</span>
<span class="sd">            res=getTouchResponse()</span>
<span class="sd">            print(res.time)</span>
<span class="sd">        </span>
<span class="sd">        Will put the touch screen into continuous reading while doing some task</span>
<span class="sd">        and at the end get all the tocuhes are display the timestamp of the first one.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">res</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getTouchResponses</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">value</span><span class="o">=</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">value</span></div>

    
<div class="viewcode-block" id="DisplayPlusPlusTouch.touchPressed">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.DisplayPlusPlusTouch.touchPressed">[docs]</a>
    <span class="k">def</span> <span class="nf">touchPressed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">N</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check to see if (at least) the appropriate number of </span>
<span class="sd">        touch screen events have been made</span>
<span class="sd">        </span>
<span class="sd">        Not accurate due to touch jitter creating extra events</span>
<span class="sd">        but can be used to detect first press.</span>
<span class="sd">        </span>
<span class="sd">        Example:</span>
<span class="sd">            bits.touchEnable()</span>
<span class="sd">            while not bits.touchPressed(5):</span>
<span class="sd">                # do some processing</span>
<span class="sd">                continue</span>
<span class="sd">            bits.touchDisable()</span>
<span class="sd">        </span>
<span class="sd">        Will do some processing until 5 screen couches are recorded.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">noComms</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inWaiting</span><span class="p">()</span><span class="o">&lt;</span><span class="bp">self</span><span class="o">.</span><span class="n">_touchSize</span><span class="o">*</span><span class="n">N</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span></div>

    
    <span class="c1"># touchWaitN is depreciated due to touch jitter creating false events</span>
<div class="viewcode-block" id="DisplayPlusPlusTouch.touchWaitN">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.DisplayPlusPlusTouch.touchWaitN">[docs]</a>
    <span class="k">def</span> <span class="nf">touchWaitN</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Waits until (at least) the appropriate number of </span>
<span class="sd">        touch screen events have been made </span>
<span class="sd">        then reports the responses.</span>
<span class="sd">        Pauses program execution in mean time.</span>
<span class="sd">        </span>
<span class="sd">        Not every accurate due to touch jitter creating extra events.</span>
<span class="sd">        </span>
<span class="sd">        Example:</span>
<span class="sd">            bits.touchEnable()</span>
<span class="sd">            bits.touchWaitN(5):</span>
<span class="sd">            bits.touchDisable()</span>
<span class="sd">            </span>
<span class="sd">        Will pause until 5 screen touches are recorded.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">noComms</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inWaiting</span><span class="p">()</span><span class="o">&lt;</span><span class="bp">self</span><span class="o">.</span><span class="n">_touchSize</span><span class="o">*</span><span class="n">N</span><span class="p">:</span>
            <span class="k">continue</span> <span class="c1"># ie loop</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getTouchResponses</span><span class="p">(</span><span class="n">N</span><span class="p">)</span></div>

    
        
<div class="viewcode-block" id="DisplayPlusPlusTouch.touchWait">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.DisplayPlusPlusTouch.touchWait">[docs]</a>
    <span class="k">def</span> <span class="nf">touchWait</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Waits until (at least) one </span>
<span class="sd">        touch screen event have been made.</span>
<span class="sd">        Then reports the response.</span>
<span class="sd">        Pauses programe execution in mean time.</span>
<span class="sd">        </span>
<span class="sd">        Example:</span>
<span class="sd">            bits.touchEnable()</span>
<span class="sd">            bits.touchWait():</span>
<span class="sd">            bits.touchDisable()</span>
<span class="sd">            </span>
<span class="sd">        Will pause until 1 screen touch  recorded.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">noComms</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inWaiting</span><span class="p">()</span><span class="o">&lt;</span><span class="bp">self</span><span class="o">.</span><span class="n">_touchSize</span><span class="p">:</span>
            <span class="k">continue</span> <span class="c1"># ie loop</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getTouchResponse</span><span class="p">()</span></div>

        
    <span class="c1">#================================================================#</span>
    <span class="c1">#    Touch logging commands work a bit more like the status log  #</span>
    <span class="c1">#    commands.</span>
    <span class="c1">#    You turn logging on, do other stuff, then later collect the #</span>
    <span class="c1">#    log results with getTouchLog                                #</span>
    <span class="c1">#================================================================#</span>
    

<div class="viewcode-block" id="DisplayPlusPlusTouch.startTouchLog">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.DisplayPlusPlusTouch.startTouchLog">[docs]</a>
    <span class="k">def</span> <span class="nf">startTouchLog</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">t</span><span class="o">=</span><span class="mi">60</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Start logging data from the touch screen.</span>
<span class="sd">        Turns on the touch screen.</span>
<span class="sd">        </span>
<span class="sd">        Example:</span>
<span class="sd">            bits.startTouchLog()</span>
<span class="sd">            while not event:</span>
<span class="sd">                #do some processing</span>
<span class="sd">                continue</span>
<span class="sd">            bits.stopTouchLog()</span>
<span class="sd">            res=bits.getTouchLog()</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">touchEnabled</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">touchEnable</span><span class="p">()</span>

        <span class="c1">#Try both Python 2 and 3 versions for initialising a thread</span>
        <span class="k">try</span><span class="p">:</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">touchThread</span><span class="o">=</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_touchLog</span><span class="p">,</span><span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">t</span><span class="p">,))</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">touchThread</span><span class="o">=</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_touchLog</span><span class="p">,</span><span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">touchLogEnd</span><span class="o">=</span><span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">touchThread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span></div>


<div class="viewcode-block" id="DisplayPlusPlusTouch.stopTouchLog">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.DisplayPlusPlusTouch.stopTouchLog">[docs]</a>
    <span class="k">def</span> <span class="nf">stopTouchLog</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Stop logging data from the Bits#</span>
<span class="sd">        Waits for _getLog to finish properly so can </span>
<span class="sd">        introduce a timing delay.</span>
<span class="sd">        </span>
<span class="sd">        Does not automatically extract the touch log.</span>
<span class="sd">        </span>
<span class="sd">        Example:</span>
<span class="sd">            bits.startTouchLog()</span>
<span class="sd">            while not event:</span>
<span class="sd">                #do some processing</span>
<span class="sd">                continue</span>
<span class="sd">            bits.stopTouchLog()</span>
<span class="sd">            res=bits.getTouchLog()</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">touchLogEnd</span><span class="o">=</span><span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">touchThread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">touchThread</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">touchEnabled</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">touchDisable</span><span class="p">()</span></div>


<div class="viewcode-block" id="DisplayPlusPlusTouch.getTouchLog">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.DisplayPlusPlusTouch.getTouchLog">[docs]</a>
    <span class="k">def</span> <span class="nf">getTouchLog</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">caution</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">checkTime</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Reads out the touch screen cue and checks for a known error</span>
<span class="sd">        Returns a list of dict like objects with four members</span>
<span class="sd">        &#39;x&#39;,&#39;y&#39;,&#39;dir&#39; and &#39;time&#39;</span>
<span class="sd">        &#39;x and y&#39; are the x and y coordinates pressed.</span>
<span class="sd">        &#39;dir&#39; is the direction of the event</span>
<span class="sd">                    eg &#39;touched&#39; for presses and &#39;released&#39; for releases.</span>
<span class="sd">        &#39;time&#39; is the timestamp associated with the event.</span>
<span class="sd">        these values can be read as a structure:</span>
<span class="sd">            res=getTouchResponses(3)</span>
<span class="sd">            res[0].dir, res[0].x, res[0].time</span>
<span class="sd">        or dictionary</span>
<span class="sd">            res[0][&#39;dir&#39;], res[0][&#39;x&#39;], res[0][&#39;time&#39;]</span>
<span class="sd">        </span>
<span class="sd">        Note even if only 1 response is requested the result is</span>
<span class="sd">            a 1 item long list of dict like objects.</span>
<span class="sd">        </span>
<span class="sd">        Note in theory this could be used to get multiple responses</span>
<span class="sd">            but in practice the touch screen reports every slight</span>
<span class="sd">            movements so the Logging methods, getTouchResponse </span>
<span class="sd">            or getAllTouchResponses are better.</span>
<span class="sd">        </span>
<span class="sd">        Note this function does not start touch screen</span>
<span class="sd">            recording so should only be called</span>
<span class="sd">            when there appears to be data waiting.</span>
<span class="sd">            So you need to call touchEnable() before and </span>
<span class="sd">            touchDisable after this function.</span>
<span class="sd"> </span>
<span class="sd">        checkTime specifies a time between the first and second touches</span>
<span class="sd">        after which a warning of a possible error will be issued and</span>
<span class="sd">        the error may be corrected.</span>
<span class="sd">        </span>
<span class="sd">        caution: If True tell the function to check for a known Display++ error</span>
<span class="sd">        if you don&#39;t have that error or you don&#39;t care about it you should set </span>
<span class="sd">        this to False.</span>
<span class="sd">        </span>
<span class="sd">        Example:</span>
<span class="sd">            bits.startTouchLog()</span>
<span class="sd">            while not event:</span>
<span class="sd">                #do some processing</span>
<span class="sd">                continue</span>
<span class="sd">            bits.stopTouchLog()</span>
<span class="sd">            res=bits.getTouchLog(caution = False)</span>
<span class="sd">        </span>
<span class="sd">        Will get all the screen touches without checking for errors.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">checkTime</span><span class="o">!=</span><span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">checkTime</span> <span class="o">=</span> <span class="n">checkTime</span>
        
        <span class="n">number</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">touchQ</span><span class="o">.</span><span class="n">qsize</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">touchQ</span><span class="o">.</span><span class="n">empty</span><span class="p">()):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">touchValues</span><span class="o">=</span><span class="p">[</span><span class="n">touch</span><span class="p">()</span> <span class="k">for</span>  <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">touchQ</span><span class="o">.</span><span class="n">qsize</span><span class="p">())]</span>
            <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">touchQ</span><span class="o">.</span><span class="n">qsize</span><span class="p">()):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">touchValues</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">touchQ</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                
            <span class="c1">#Display++ can sometimes issue a spurious touch event left over</span>
            <span class="c1">#from a previous series of touches. The following code should detect</span>
            <span class="c1">#and correct the error</span>
            
            <span class="n">lastTouch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">touchValues</span><span class="p">[</span><span class="n">number</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">dir</span>
            
            <span class="c1">#No need to worry if only one touch recorded or the user is happy</span>
            <span class="c1">#to forgo checks.</span>
            <span class="k">if</span> <span class="n">number</span><span class="o">&gt;</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">caution</span><span class="p">:</span> 
                

                <span class="c1">#Detects if first timestamp is after second</span>
                <span class="c1">#Works if Display++ clock has  been reset between touch </span>
                <span class="c1">#data collection sessions.</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">touchValues</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">time</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">touchValues</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">time</span><span class="p">:</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">touchValues</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">warning</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;getTouchLog: Deleted first touch as recorded &quot;</span> 
                              <span class="s2">&quot;after second. This corrects an error in &quot;</span>
                              <span class="s2">&quot;the Display++&quot;</span><span class="p">)</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">warning</span><span class="p">)</span>
                    
                <span class="c1">#Detects that the last recorded touch in a previous call to </span>
                <span class="c1">#getTouchLog was a &#39;touched&#39; rather than a &#39;release&#39; event.</span>
                <span class="c1">#this is likely to cause the error but won&#39;t capture and</span>
                <span class="c1">#error from the last run of an experiment that uses the </span>
                <span class="c1">#touch screen</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastTouch</span> <span class="o">==</span> <span class="s1">&#39;touched&#39;</span><span class="p">:</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">touchValues</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">warning</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;getTouchLog: Deleted first touch as the &quot;</span>
                             <span class="s2">&quot;last previously recorded touch event &quot;</span>
                             <span class="s2">&quot;was not a release and this can indicate an &quot;</span>
                             <span class="s2">&quot;error in the Display++. However, this could be the &quot;</span>
                             <span class="s2">&quot;wrong thing to have done&quot;</span><span class="p">)</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">warning</span><span class="p">)</span>
                
                <span class="c1">#Detects that gap between first two timestamps is not larger</span>
                <span class="c1">#than checkTime.</span>
                <span class="c1">#Due to finger jitter this is unlikely if first touch is real.</span>
                <span class="c1">#But this is not fool proof it could delete a first very </span>
                <span class="c1">#clean touch</span>
                <span class="c1">#and if the other two tests failed and this is not</span>
                <span class="c1">#the first call to this function the chances are it a good</span>
                <span class="c1">#touch - hence just a warning in that case.</span>
                <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">touchValues</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">time</span> 
                       <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">touchValues</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">time</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkTime</span><span class="p">:</span>
                    <span class="n">warning</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;getTouchLog: Gap between first and second &quot;</span>
                             <span class="s2">&quot;touches is large normally finger jitter means &quot;</span>
                             <span class="s2">&quot;it is quite short.&quot;</span><span class="p">)</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">warning</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">touchFirstTime</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">touchValues</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">warning</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;getTouchLog: Deleted first touch as &quot;</span>
                                 <span class="s2">&quot;the gap between first &quot;</span>
                                 <span class="s2">&quot;and second touches is large &quot;</span>
                                 <span class="s2">&quot;and this is not the first call of the run. &quot;</span>
                                 <span class="s2">&quot;But this could be the wrong thing to have &quot;</span>
                                 <span class="s2">&quot;done.&quot;</span><span class="p">)</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">warning</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lastTouch</span> <span class="o">=</span> <span class="n">lastTouch</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">touchFirstTime</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">touch_nValues</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">touchValues</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">touchValues</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">touch_nValues</span><span class="o">=</span><span class="mi">0</span>
            <span class="k">return</span> <span class="kc">None</span></div>



            
    <span class="c1">#===============================================#</span>
    <span class="c1">#    Helper function for touch screen commands. #</span>
    <span class="c1">#    Normally run in its own thread.             #</span>
    <span class="c1">#===============================================#</span>
            
    <span class="k">def</span> <span class="nf">_touchLog</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="mi">60</span><span class="p">,)):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Gets raw touch screen events and put them in a Queue</span>
<span class="sd">            Not normally needed by the user.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">t</span> <span class="o">=</span> <span class="n">args</span> <span class="c1"># Get the time to run for</span>
        <span class="n">sT</span> <span class="o">=</span> <span class="n">clock</span><span class="p">()</span> <span class="c1"># start time</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="c1"># While not timed out and until touchLogEnd is true</span>
        <span class="c1"># When run in a thread touchLogEnd can be set from outside this function.</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">clock</span><span class="p">()</span> <span class="o">-</span> <span class="n">sT</span> <span class="o">&lt;</span> <span class="n">t</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">touchLogEnd</span> <span class="o">==</span> <span class="kc">False</span><span class="p">):</span>
            <span class="c1"># Complie the message</span>
            <span class="n">smsg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">timeout</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">smsg</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span><span class="o">+</span><span class="n">smsg</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">touchDisable</span><span class="p">()</span> <span class="c1"># Turn off touch screen.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">touchLogEnd</span><span class="o">=</span><span class="kc">True</span> <span class="c1"># Make sure this function marked as ending.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">msg</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">)</span> <span class="c1"># Split message into lines with CR</span>
            <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

            <span class="n">values</span><span class="o">=</span><span class="p">[</span><span class="n">touch</span><span class="p">()</span> <span class="k">for</span>  <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)]</span>
            <span class="c1">#for all the touches</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span> <span class="c1"># Split line into components at ;</span>
                <span class="c1"># If we have read a touch event.</span>
                <span class="k">if</span> <span class="s1">&#39;$touch&#39;</span> <span class="ow">in</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="c1">#Grab the details of the event into a structure.</span>
                    <span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
                    <span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
                    <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">4</span><span class="p">]))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">dir</span> <span class="o">=</span> <span class="s1">&#39;touched&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">dir</span> <span class="o">=</span> <span class="s1">&#39;released&#39;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">touchQ</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="k">elif</span> <span class="s1">&#39;#status&#39;</span> <span class="ow">in</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="c1"># GOt a status event by mistake</span>
                    <span class="n">warning</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;_touchLog found&quot;</span> 
                            <span class="s2">&quot; status on input so skipping that&quot;</span><span class="p">)</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">warning</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span> <span class="c1"># Have picked up some other stuff on the input</span>
                    <span class="n">warning</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;_touchLog found&quot;</span>
                            <span class="s2">&quot; unknown data on input so skipping that&quot;</span><span class="p">)</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">warning</span><span class="p">)</span>


    <span class="c1">#============================================================#</span>
    <span class="c1">#    Touch event functions can be used to get a list of more #</span>
    <span class="c1">#    meaningful events following any getTouch commands       #</span>
    <span class="c1">#    works a bit like an eye movement gaze detector          #</span>
    <span class="c1">#============================================================#</span>

<div class="viewcode-block" id="DisplayPlusPlusTouch.setTouchEventParams">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.DisplayPlusPlusTouch.setTouchEventParams">[docs]</a>
    <span class="k">def</span> <span class="nf">setTouchEventParams</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">distance</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="kc">None</span> <span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Sets the parameters for touch event detection.</span>
<span class="sd">            Distance is how far the touch should move to count</span>
<span class="sd">            as a new touch.</span>
<span class="sd">            Time is how long should lapse between touches for the </span>
<span class="sd">            second one to count.</span>
<span class="sd">            </span>
<span class="sd">        Example:</span>
<span class="sd">            bits.startTouchLog()</span>
<span class="sd">            while not event:</span>
<span class="sd">                #do some processing</span>
<span class="sd">                continue</span>
<span class="sd">            bits.stopTouchLog()</span>
<span class="sd">            res=bits.getTouchLog()</span>
<span class="sd">            bits.setTouchEventParams(distance=20, t=0.001, type=&#39;touched&#39;)</span>
<span class="sd">            events=bits.getTouchEvents()</span>
<span class="sd">            </span>
<span class="sd">            Will extract touch events (not releases) that are 20 pixels and 1 ms apart.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">distance</span><span class="o">!=</span><span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">touchDistance</span> <span class="o">=</span> <span class="n">distance</span>
        <span class="k">if</span> <span class="n">t</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">touchTime</span> <span class="o">=</span> <span class="n">t</span>
        <span class="k">if</span> <span class="nb">type</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">touchType</span> <span class="o">=</span> <span class="nb">type</span></div>


<div class="viewcode-block" id="DisplayPlusPlusTouch.getTouchEvents">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.DisplayPlusPlusTouch.getTouchEvents">[docs]</a>
    <span class="k">def</span> <span class="nf">getTouchEvents</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">distance</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Scans the touch log to extract touch events.</span>
<span class="sd">            You need to run getTouchLog before you run this function.</span>
<span class="sd">        </span>
<span class="sd">            Returns as list of Dict like structures with members</span>
<span class="sd">            time, x, y, and dir</span>
<span class="sd">            </span>
<span class="sd">            time is the time stamp of the event.</span>
<span class="sd">            x and y are the x and y locations of the event.</span>
<span class="sd">            direction is the type of event: &#39;touched&#39;, &#39;released&#39;</span>
<span class="sd">            </span>
<span class="sd">            These values can be read as a structure:</span>
<span class="sd">            res=getTouchResponses(3)</span>
<span class="sd">            res[0].dir, res[0].x, res[0].time</span>
<span class="sd">            or dictionary</span>
<span class="sd">            res[0][&#39;dir&#39;], res[0][&#39;x&#39;], res[0][&#39;time&#39;]</span>
<span class="sd">            </span>
<span class="sd">            </span>
<span class="sd">        Example:</span>
<span class="sd">            bits.startTouchLog()</span>
<span class="sd">            while not event:</span>
<span class="sd">                #do some processing</span>
<span class="sd">                continue</span>
<span class="sd">            bits.stopTouchLog()</span>
<span class="sd">            bits.getTouchLog()</span>
<span class="sd">            res=bits.getTouchEvents(distance=20, t=0.001, type=&#39;touched&#39;)</span>
<span class="sd">            print(res[0][&#39;time&#39;]</span>
<span class="sd">            </span>
<span class="sd">            Will extract touch events (not releases) that are 20 pixels and 1 ms apart.</span>
<span class="sd">            </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setTouchEventParams</span><span class="p">(</span><span class="n">distance</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="nb">type</span><span class="p">)</span>
        <span class="n">N</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">touchValues</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">touchEvents</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">nEvents</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">rT</span> <span class="o">=</span> <span class="o">-</span><span class="mi">999999</span>
        <span class="n">rX</span> <span class="o">=</span> <span class="o">-</span><span class="mi">999999</span>
        <span class="n">rY</span> <span class="o">=</span> <span class="o">-</span><span class="mi">999999</span>
        <span class="n">rType</span> <span class="o">=</span> <span class="s1">&#39;None&#39;</span>
        <span class="n">nEvents</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
            <span class="n">dist</span><span class="o">=</span><span class="p">(((</span><span class="bp">self</span><span class="o">.</span><span class="n">touchValues</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">rX</span><span class="p">)</span><span class="o">**</span><span class="mf">2.0</span><span class="p">)</span>
                  <span class="o">+</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">touchValues</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">rY</span><span class="p">)</span><span class="o">**</span><span class="mf">2.0</span><span class="p">))</span><span class="o">**</span><span class="mf">0.5</span>
            <span class="n">T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">touchValues</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">time</span> <span class="o">-</span> <span class="n">rT</span>
            
            <span class="c1"># Only include events that are sufficiently far from</span>
            <span class="c1"># last recorded event in time and distance, or if</span>
            <span class="c1"># the direction of touch has changed and the new</span>
            <span class="c1"># direction is in the looked for type descriptor.</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">dist</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">touchDistance</span> 
                    <span class="ow">and</span> <span class="n">T</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">touchTime</span><span class="p">)</span> 
                <span class="ow">or</span> <span class="p">(</span><span class="n">rType</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">touchValues</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">dir</span> 
                    <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">touchValues</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">dir</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">touchType</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">touchEvents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">touch</span><span class="p">())</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">touchEvents</span><span class="p">[</span><span class="n">nEvents</span><span class="p">]</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">touchValues</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">time</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">touchEvents</span><span class="p">[</span><span class="n">nEvents</span><span class="p">]</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">touchValues</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">touchEvents</span><span class="p">[</span><span class="n">nEvents</span><span class="p">]</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">touchValues</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">y</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">touchEvents</span><span class="p">[</span><span class="n">nEvents</span><span class="p">]</span><span class="o">.</span><span class="n">dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">touchValues</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">dir</span>
                <span class="n">rT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">touchValues</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">time</span>
                <span class="n">rX</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">touchValues</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>
                <span class="n">rY</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">touchValues</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">y</span>
                <span class="n">rType</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">touchValues</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">dir</span>
                <span class="n">nEvents</span> <span class="o">=</span> <span class="n">nEvents</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">touch_nEvents</span> <span class="o">=</span> <span class="n">nEvents</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">touchEvents</span></div>



<div class="viewcode-block" id="DisplayPlusPlusTouch.getTouchEvent">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.DisplayPlusPlusTouch.getTouchEvent">[docs]</a>
    <span class="k">def</span> <span class="nf">getTouchEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">distance</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Scans the touch log to return the Nth touch event.</span>
<span class="sd">            You need to run getTouchLog before you run this function.</span>
<span class="sd">        </span>
<span class="sd">           Returns as list of Dict like structures with members</span>
<span class="sd">            time, x, y, and dir</span>
<span class="sd">            </span>
<span class="sd">            time is the time stamp of the event.</span>
<span class="sd">            x and y are the x and y locations of the event.</span>
<span class="sd">            direction is the type of event: &#39;touched&#39;, &#39;released&#39;</span>
<span class="sd">            </span>
<span class="sd">            These values can be read as a structure:</span>
<span class="sd">            res=getTouchResponses(3)</span>
<span class="sd">            res[0].dir, res[0].x, res[0].time</span>
<span class="sd">            or dictionary</span>
<span class="sd">            res[0][&#39;dir&#39;], res[0][&#39;x&#39;], res[0][&#39;time&#39;]</span>
<span class="sd">            </span>
<span class="sd">            </span>
<span class="sd">        Example:</span>
<span class="sd">            bits.startTouchLog()</span>
<span class="sd">            while not event:</span>
<span class="sd">                #do some processing</span>
<span class="sd">                continue</span>
<span class="sd">            bits.stopTouchLog()</span>
<span class="sd">            bits.getTouchLog()</span>
<span class="sd">            res=bits.getTouchEvent(N=10, distance=20, time=0.001, type=&#39;touched&#39;)</span>
<span class="sd">            print(res.time)</span>
<span class="sd">            </span>
<span class="sd">            Will extract the 10th touch events (ingnoreing releases) that are 20 pixels and 1 ms apart.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getTouchEvents</span><span class="p">(</span><span class="n">distance</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">N</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">value</span></div>
</div>



<span class="k">class</span> <span class="nc">Config</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bits</span><span class="p">):</span>
        <span class="c1"># we need to set bits reference using weakref to avoid circular refs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bits</span> <span class="o">=</span> <span class="n">bits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>  <span class="c1"># try to fetch previous config file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logFile</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># replace with a file handle if opened</span>

    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;If name is None then we&#39;ll try to save to</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">parseLUTLine</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">psychopy</span> <span class="kn">import</span> <span class="n">prefs</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">prefs</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s1">&#39;userPrefsDir&#39;</span><span class="p">],</span>
                                    <span class="s1">&#39;crs_bits.cfg&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
            <span class="n">config</span> <span class="o">=</span> <span class="n">configparser</span><span class="o">.</span><span class="n">RawConfigParser</span><span class="p">()</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">config</span><span class="o">.</span><span class="n">readfp</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">os</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;system&#39;</span><span class="p">,</span> <span class="s1">&#39;os&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gfxCard</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;system&#39;</span><span class="p">,</span> <span class="s1">&#39;gfxCard&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">identityLUT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="mi">256</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
            <span class="n">_idLUT</span> <span class="o">=</span> <span class="s1">&#39;identityLUT&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">identityLUT</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">parseLUTLine</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">_idLUT</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">identityLUT</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">parseLUTLine</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">_idLUT</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">identityLUT</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">parseLUTLine</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">_idLUT</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;no config file yet for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">bits</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">identityLUT</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gfxCard</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">os</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_getGfxCardString</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">pyglet.gl</span> <span class="kn">import</span> <span class="n">gl_info</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">gl_info</span><span class="o">.</span><span class="n">get_renderer</span><span class="p">(),</span>
                           <span class="n">gl_info</span><span class="o">.</span><span class="n">get_version</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">_getOSstring</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">platform</span>
        <span class="k">return</span> <span class="n">platform</span><span class="o">.</span><span class="n">platform</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">psychopy</span> <span class="kn">import</span> <span class="n">prefs</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">prefs</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s1">&#39;userPrefsDir&#39;</span><span class="p">],</span>
                                    <span class="s1">&#39;crs_bits.cfg&#39;</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;saved Bits# config file to </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>
        <span class="c1"># create the config object</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">configparser</span><span class="o">.</span><span class="n">RawConfigParser</span><span class="p">()</span>
        <span class="n">config</span><span class="o">.</span><span class="n">add_section</span><span class="p">(</span><span class="s1">&#39;system&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">os</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;system&#39;</span><span class="p">,</span> <span class="s1">&#39;os&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getOSstring</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gfxCard</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;system&#39;</span><span class="p">,</span> <span class="s1">&#39;gfxCard&#39;</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">_getGfxCardString</span><span class="p">())</span>

        <span class="c1"># save the current LUT</span>
        <span class="n">config</span><span class="o">.</span><span class="n">add_section</span><span class="p">(</span><span class="s1">&#39;identityLUT&#39;</span><span class="p">)</span>
        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;identityLUT&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">identityLUT</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]))</span>
        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;identityLUT&#39;</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">identityLUT</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]))</span>
        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;identityLUT&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">identityLUT</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]))</span>

        <span class="c1"># save it to disk</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fileObj</span><span class="p">:</span>
            <span class="n">config</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fileObj</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Saved </span><span class="si">%s</span><span class="s2"> configuration to </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bits</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">quickCheck</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check whether the current graphics card and OS match those of</span>
<span class="sd">        the last saved LUT</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getGfxCardString</span><span class="p">()</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gfxCard</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;The graphics card or its driver has changed. &quot;</span>
                         <span class="s2">&quot;We&#39;ll re-check the identity LUT for the card&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getOSstring</span><span class="p">()</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">os</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;The OS has been changed/updated. We&#39;ll re-check&quot;</span>
                         <span class="s2">&quot; the identity LUT for the card&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="mi">1</span>  <span class="c1"># all seems the same as before</span>

    <span class="k">def</span> <span class="nf">testLUT</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">LUT</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">demoMode</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply a LUT to the graphics card gamma table and test whether</span>
<span class="sd">        we get back 0:255 in all channels.</span>
<span class="sd">        :params:</span>
<span class="sd">            LUT: The lookup table to be tested (256x3).</span>
<span class="sd">            If None then the LUT will not be altered</span>
<span class="sd">        :returns:</span>
<span class="sd">            a 256 x 3 array of error values (integers in range 0:255)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">bits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bits</span>  <span class="c1"># if you aren&#39;t yet in</span>
        <span class="n">win</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bits</span><span class="o">.</span><span class="n">win</span>
        <span class="k">if</span> <span class="n">LUT</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">win</span><span class="o">.</span><span class="n">gammaRamp</span> <span class="o">=</span> <span class="n">LUT</span>
        <span class="c1"># create the patch of stimulus to test</span>
        <span class="n">expectedVals</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">256</span><span class="p">))</span>
        <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">win</span><span class="o">.</span><span class="n">size</span>
        <span class="c1"># NB psychopy uses -1:1</span>
        <span class="n">testArrLums</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">256</span><span class="p">),</span> <span class="p">[</span><span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">])</span>
        <span class="n">stim</span> <span class="o">=</span> <span class="n">visual</span><span class="o">.</span><span class="n">ImageStim</span><span class="p">(</span><span class="n">win</span><span class="p">,</span> <span class="n">image</span><span class="o">=</span><span class="n">testArrLums</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">[</span><span class="mi">256</span><span class="p">,</span> <span class="n">h</span><span class="p">],</span>
                                <span class="n">pos</span><span class="o">=</span><span class="p">[</span><span class="mi">128</span> <span class="o">-</span> <span class="n">w</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;pix&#39;</span><span class="p">)</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">expectedVals</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
        <span class="n">stim</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
        <span class="c1"># make sure the frame buffer was correct (before gamma was applied)</span>
        <span class="n">frm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">win</span><span class="o">.</span><span class="n">getMovieFrame</span><span class="p">(</span><span class="n">buffer</span><span class="o">=</span><span class="s1">&#39;back&#39;</span><span class="p">))</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">alltrue</span><span class="p">(</span><span class="n">frm</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">256</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">256</span><span class="p">)))</span>
        <span class="n">win</span><span class="o">.</span><span class="n">flip</span><span class="p">()</span>
        <span class="c1"># use bits sharp to test</span>
        <span class="k">if</span> <span class="n">demoMode</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">256</span>
        <span class="n">pixels</span> <span class="o">=</span> <span class="n">bits</span><span class="o">.</span><span class="n">getVideoLine</span><span class="p">(</span><span class="n">lineN</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">nPixels</span><span class="o">=</span><span class="mi">256</span><span class="p">)</span>
        <span class="n">errs</span> <span class="o">=</span> <span class="n">pixels</span> <span class="o">-</span> <span class="n">expected</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logFile</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">channel</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="s1">&#39;RGB&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">pixVal</span> <span class="ow">in</span> <span class="n">pixels</span><span class="p">[:,</span> <span class="n">ii</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;, </span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">pixVal</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">errs</span>

    <span class="k">def</span> <span class="nf">findIdentityLUT</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">maxIterations</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">errCorrFactor</span><span class="o">=</span><span class="mf">1.0</span><span class="o">/</span><span class="mi">5000</span><span class="p">,</span>
                        <span class="n">nVerifications</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
                        <span class="n">demoMode</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">logFile</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Search for the identity LUT for this card/operating system.</span>
<span class="sd">        This requires that the window being tested is fullscreen on the Bits#</span>
<span class="sd">        monitor (or at least occupies the first 256 pixels in the top left</span>
<span class="sd">        corner!)</span>
<span class="sd">        :params:</span>
<span class="sd">            LUT: The lookup table to be tested (256 x 3).</span>
<span class="sd">            If None then the LUT will not be altered</span>
<span class="sd">            errCorrFactor: amount of correction done for each iteration</span>
<span class="sd">                number of repeats (successful) to check dithering</span>
<span class="sd">                has been eradicated</span>
<span class="sd">            demoMode: generate the screen but don&#39;t go into status mode</span>
<span class="sd">        :returns:</span>
<span class="sd">            a 256x3 array of error values (integers in range 0:255)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="c1"># create standard options</span>
        <span class="n">intel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">.05</span><span class="p">,</span> <span class="mf">.95</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span>
        <span class="n">one</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span>
        <span class="n">fraction</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">65535.0</span><span class="o">/</span><span class="mf">65536.0</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">256</span><span class="p">)</span>
        <span class="n">LUTs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;intel&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">intel</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">]),</span>
                <span class="s1">&#39;0-255&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">one</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">]),</span>
                <span class="s1">&#39;0-65535&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">fraction</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">]),</span>
                <span class="s1">&#39;1-65536&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">fraction</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">])}</span>

        <span class="k">if</span> <span class="n">logFile</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logFile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">logFile</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">plotResults</span><span class="p">:</span>
            <span class="n">pyplot</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>
            <span class="n">pyplot</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">pyplot</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">],</span> <span class="s1">&#39;-k&#39;</span><span class="p">)</span>
            <span class="n">errPlot</span> <span class="o">=</span> <span class="n">pyplot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">256</span><span class="p">)),</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">256</span><span class="p">)),</span> <span class="s1">&#39;.r&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">pyplot</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">pyplot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="s1">&#39;.w&#39;</span><span class="p">)</span>
            <span class="n">pyplot</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">lowestErr</span> <span class="o">=</span> <span class="mi">1000000000</span>
        <span class="n">bestLUTname</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">LUTname</span><span class="p">,</span> <span class="n">currentLUT</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">LUTs</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Checking </span><span class="si">%r</span><span class="s1"> LUT:&#39;</span> <span class="o">%</span> <span class="n">LUTname</span><span class="p">)</span>
            <span class="n">errs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">testLUT</span><span class="p">(</span><span class="n">currentLUT</span><span class="p">,</span> <span class="n">demoMode</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">plotResults</span><span class="p">:</span>
                <span class="n">errPlot</span><span class="o">.</span><span class="n">set_ydata</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">256</span><span class="p">))</span> <span class="o">+</span> <span class="n">errs</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
                <span class="n">pyplot</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;mean err = </span><span class="si">%.3f</span><span class="s1"> per LUT entry&#39;</span> <span class="o">%</span> <span class="nb">abs</span><span class="p">(</span><span class="n">errs</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">errs</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">&lt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">lowestErr</span><span class="p">):</span>
                <span class="n">lowestErr</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">errs</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                <span class="n">bestLUTname</span> <span class="o">=</span> <span class="n">LUTname</span>
        <span class="k">if</span> <span class="n">lowestErr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;The </span><span class="si">%r</span><span class="s2"> identity LUT produced zero error. We&#39;ll use that!&quot;</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">msg</span> <span class="o">%</span> <span class="n">LUTname</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">identityLUT</span> <span class="o">=</span> <span class="n">LUTs</span><span class="p">[</span><span class="n">bestLUTname</span><span class="p">]</span>
            <span class="c1"># it worked so save this configuration for future</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Best was </span><span class="si">%r</span><span class="s2"> LUT (mean err = </span><span class="si">%.3f</span><span class="s2">). Optimising that...&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">msg</span> <span class="o">%</span> <span class="p">(</span><span class="n">bestLUTname</span><span class="p">,</span> <span class="n">lowestErr</span><span class="p">))</span>
        <span class="n">currentLUT</span> <span class="o">=</span> <span class="n">LUTs</span><span class="p">[</span><span class="n">bestLUTname</span><span class="p">]</span>
        <span class="n">errProgression</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">corrInARow</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">maxIterations</span><span class="p">):</span>
            <span class="n">errs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">testLUT</span><span class="p">(</span><span class="n">currentLUT</span><span class="p">)</span>
            <span class="n">tweaks</span> <span class="o">=</span> <span class="n">errs</span> <span class="o">*</span> <span class="n">errCorrFactor</span>
            <span class="n">currentLUT</span> <span class="o">-=</span> <span class="n">tweaks</span>
            <span class="n">currentLUT</span><span class="p">[</span><span class="n">currentLUT</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">currentLUT</span><span class="p">[</span><span class="n">currentLUT</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">meanErr</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">errs</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">errProgression</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">meanErr</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">plotResults</span><span class="p">:</span>
                <span class="n">errPlot</span><span class="o">.</span><span class="n">set_ydata</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">256</span><span class="p">))</span> <span class="o">+</span> <span class="n">errs</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
                <span class="n">pyplot</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">meanErr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">point</span> <span class="o">=</span> <span class="s1">&#39;.k&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">point</span> <span class="o">=</span> <span class="s1">&#39;.r&#39;</span>
                <span class="n">pyplot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">meanErr</span><span class="p">,</span> <span class="s1">&#39;.k&#39;</span><span class="p">)</span>
                <span class="n">pyplot</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">meanErr</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%.3f</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="n">meanErr</span><span class="p">)</span>
                <span class="n">corrInARow</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;. &quot;</span><span class="p">)</span>
                <span class="n">corrInARow</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">corrInARow</span> <span class="o">&gt;=</span> <span class="n">nVerifications</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;success in a total of </span><span class="si">%.1f</span><span class="s1">s&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">identityLUT</span> <span class="o">=</span> <span class="n">currentLUT</span>
                <span class="c1"># it worked so save this configuration for future</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                <span class="k">break</span>
            <span class="k">elif</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">errProgression</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span> <span class="ow">and</span>
                    <span class="nb">max</span><span class="p">(</span><span class="n">errProgression</span><span class="p">)</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">errProgression</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.001</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Trying to correct the gamma table was having no &quot;</span>
                      <span class="s2">&quot;effect. Make sure the window was fullscreen and &quot;</span>
                      <span class="s2">&quot;on the Bits# screen&quot;</span><span class="p">)</span>
                <span class="k">break</span>

        <span class="c1"># did we get here by failure?!</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="n">maxIterations</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;failed to converge on a successful identity LUT. &quot;</span>
                  <span class="s2">&quot;This is BAD!&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">plotResults</span><span class="p">:</span>
            <span class="n">pyplot</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">18</span><span class="p">,</span> <span class="mi">12</span><span class="p">])</span>
            <span class="n">pyplot</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">pyplot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">errProgression</span><span class="p">)</span>
            <span class="n">pyplot</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Progression of errors&#39;</span><span class="p">)</span>
            <span class="n">pyplot</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Mean error per LUT entry (0-1)&quot;</span><span class="p">)</span>
            <span class="n">pyplot</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Test iteration&quot;</span><span class="p">)</span>
            <span class="n">r256</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">256</span><span class="p">)),</span> <span class="p">[</span><span class="mi">256</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">pyplot</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">pyplot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">r256</span><span class="p">,</span> <span class="n">r256</span><span class="p">,</span> <span class="s1">&#39;k-&#39;</span><span class="p">)</span>
            <span class="n">pyplot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">r256</span><span class="p">,</span> <span class="n">currentLUT</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">255</span><span class="p">,</span> <span class="s1">&#39;r.&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span>
            <span class="n">pyplot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">r256</span><span class="p">,</span> <span class="n">currentLUT</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">255</span><span class="p">,</span> <span class="s1">&#39;g.&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span>
            <span class="n">pyplot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">r256</span><span class="p">,</span> <span class="n">currentLUT</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="mi">255</span><span class="p">,</span> <span class="s1">&#39;b.&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span>
            <span class="n">pyplot</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Final identity LUT&#39;</span><span class="p">)</span>
            <span class="n">pyplot</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;LUT value&quot;</span><span class="p">)</span>
            <span class="n">pyplot</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;LUT entry&quot;</span><span class="p">)</span>

            <span class="n">pyplot</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
            <span class="n">deviations</span> <span class="o">=</span> <span class="n">currentLUT</span> <span class="o">-</span> <span class="n">r256</span><span class="o">/</span><span class="mf">255.0</span>
            <span class="n">pyplot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">r256</span><span class="p">,</span> <span class="n">deviations</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;r.&#39;</span><span class="p">)</span>
            <span class="n">pyplot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">r256</span><span class="p">,</span> <span class="n">deviations</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;g.&#39;</span><span class="p">)</span>
            <span class="n">pyplot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">r256</span><span class="p">,</span> <span class="n">deviations</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="s1">&#39;b.&#39;</span><span class="p">)</span>
            <span class="n">pyplot</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;LUT deviations from sensible&#39;</span><span class="p">)</span>
            <span class="n">pyplot</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;LUT value&quot;</span><span class="p">)</span>
            <span class="n">pyplot</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;LUT deviation (multiples of 1024)&quot;</span><span class="p">)</span>
            <span class="n">pyplot</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;bitsSharpIdentityLUT.pdf&quot;</span><span class="p">)</span>
            <span class="n">pyplot</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="c1"># Some properties for which we need weakref pointers, not std properties</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">bits</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The Bits box to which this config object refers</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bits&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bits&#39;</span><span class="p">)()</span>

    <span class="nd">@bits</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">bits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bits</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;bits&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">bits</span><span class="p">)</span>


<div class="viewcode-block" id="init">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.init">[docs]</a>
<span class="k">def</span> <span class="nf">init</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;DEPRECATED: we used to initialise Bits++ via the compiled dll</span>
<span class="sd">    This only ever worked on windows and BitsSharp doesn&#39;t need it at all</span>
<span class="sd">    Note that, by default, Bits++ will perform gamma correction</span>
<span class="sd">    that you don&#39;t want (unless you have the CRS calibration device)</span>
<span class="sd">    (Recommended that you use the BitsPlusPlus class rather than</span>
<span class="sd">    calling this directly)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">retVal</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">haveBitsDLL</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">retVal</span> <span class="o">=</span> <span class="n">_bits</span><span class="o">.</span><span class="n">bitsInit</span><span class="p">()</span>  <span class="c1"># returns null if fails?</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;bits.init() barfed!&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">retVal</span></div>



<div class="viewcode-block" id="setVideoMode">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.setVideoMode">[docs]</a>
<span class="k">def</span> <span class="nf">setVideoMode</span><span class="p">(</span><span class="n">videoMode</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Set the video mode of the Bits++ (win32 only)</span>
<span class="sd">    bits8BITPALETTEMODE = 0x00000001  # normal vsg mode</span>
<span class="sd">    NOGAMMACORRECT = 0x00004000  # No gamma correction mode</span>
<span class="sd">    GAMMACORRECT = 0x00008000  # Gamma correction mode</span>
<span class="sd">    VIDEOENCODEDCOMMS = 0x00080000</span>
<span class="sd">    (Recommended that you use the BitsLUT class rather than</span>
<span class="sd">    calling this directly)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">haveBitsDLL</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_bits</span><span class="o">.</span><span class="n">bitsSetVideoMode</span><span class="p">(</span><span class="n">videoMode</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">1</span></div>



<div class="viewcode-block" id="reset">
<a class="viewcode-back" href="../../../coder/bits/#psychopy_crs.bits.reset">[docs]</a>
<span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="n">noGamma</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Reset the Bits++ box via the USB cable by initialising again</span>
<span class="sd">    Allows the option to turn off gamma correction</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">OK</span> <span class="o">=</span> <span class="n">init</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">noGamma</span> <span class="ow">and</span> <span class="n">OK</span><span class="p">:</span>
        <span class="n">setVideoMode</span><span class="p">(</span><span class="n">NOGAMMACORRECT</span><span class="p">)</span></div>

</pre></div>

      <br/><a href="#" class="pull-right">Back to top</a>
    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <span class="pull-right">
      
        
      <br/>

          &copy; 2002-2018 <a href="https://www.peirce.org.uk/">Jonathan Peirce</a><br/>
          &copy; 2019 <a href="https://opensciencetools.org/">Open Science Tools Ltd.</a><br/><br/>
        PsychoPy<sup></sup> and Pavlovia<sup></sup> are registered trademarks of Open Science Tools Ltd.<br/>
        Created using <a href="http://sphinx-doc.org/">Sphinx</a> 7.3.7.<br/><br/>
    </span>

    <a href="http://www.nottingham.ac.uk/"><img src="../../../_static/Nottingham Supported.png", alt="Uni of Nottingham" width=250></a>
  </div>

</footer>
  </body>
</html>